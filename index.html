<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedRec 2.0</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Basic Layout */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 0.5rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 185px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-sizing: border-box;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .screen {
      display: none;
      width: 100%;
      text-align: center;
    }
    .screen.active {
      display: block;
    }
    /* Card Styling */
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
      padding: 1rem;
      margin: 0.5rem 0;
      width: 100%;
      box-sizing: border-box;
    }
    /* Buttons & Inputs */
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      border-radius: 15px;
      width: 100%;
      max-width: 300px;
      display: block;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.2s ease;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    /* Hide native file inputs */
    input[type="file"] {
      display: none;
    }
    .photo-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin: 1rem 0;
      width: 100%;
    }
    .photo-actions button {
      width: 100%;
      max-width: 300px;
      margin: 0;
    }
    .disclaimer-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1rem 0;
      width: 100%;
    }
    .disclaimer-actions button {
      width: 100%;
      max-width: 300px;
    }
    .upload-instructions {
      font-size: 0.9rem;
      margin: 0.5rem 1rem;
      color: #555;
    }
    .upload-prompt {
      font-size: 0.9rem;
      margin: 0.5rem 1rem;
      color: #333;
    }
    .preview-container {
      text-align: center;
      margin: 0.5rem 0 1rem;
    }
    .thumbnail-container {
      position: relative;
      display: inline-block;
      margin: 0.25rem;
    }
    .thumbnail-container img {
      width: 80px;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    /* ============== delete (close) chip ============== */
    .delete-btn {
      position: absolute;
      top: -6px;                   /* sticks out a little */
      right: -6px;
      width: 24px;                 /* exact circle */
      height: 24px;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ff4d4d;         /* red chip */
      color: #fff;                 /* white “X” */
      font-size: 18px;             /* icon size */
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,.25);
      transition: background .15s ease;
      padding: 0;                  /* override global button padding */
    }
    .delete-btn:hover {
      background: #d73838;         /* darker on hover */
    }
    /* make the glyph a touch smaller and centred */
    .delete-btn .material-icons {
      font-size: 18px;             /* icon ≈ 75 % of circle */
      line-height: 1;
    }
    #error-message {
      color: red;
      text-align: center;
      margin: 1rem 0;
    }
    .critical {
      color: red;
      font-weight: bold;
    }
/* ========= New table styling ========== */
table.changes-table {
  width: auto;
  margin: 1rem auto;    /* center horizontally */
  border-collapse: collapse;
  font-size: 0.9rem;
}
/* allow horizontal scroll on narrow viewports */
#results-content {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
table.changes-table th,
table.changes-table td {
  border: 1px solid #ddd;
  padding: 0.5rem;
  text-align: left;
}
table.changes-table th {
  background-color: #f0f0f0;
}
/* Prevent splitting rows across PDF pages */
.changes-table,
.changes-table thead,
.changes-table tbody,
.changes-table tr,
.changes-table th,
.changes-table td {
  page-break-inside: avoid !important;
}


    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0.5rem 0;
      margin-top: -40px;
      position: relative;
    }
    .progress-step {
      width: 30px;
      height: 30px;
      background-color: #cccccc;
      border: 1px solid #999;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: all 0.3s ease;
    }
    .progress-step.filled {
      background-color: #66b0ff;
      border: 1px solid #0056b3;
      color: white;
    }
    .progress-step.current {
      background-color: #007bff;
      border: 3px solid #0056b3;
      color: white;
    }
    .progress-line-container {
      position: absolute;
      top: 50%;
      left: 15px;
      right: 15px;
      height: 2px;
      z-index: 0;
      display: flex;
      justify-content: space-between;
    }
    .progress-line {
      flex: 1;
      height: 2px;
      background-color: #cccccc;
      margin: 0 5px;
    }
    .progress-line.filled {
      background-color: #66b0ff;
    }
    #loading {
      display: none;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.5rem;
      text-align: center;
      z-index: 2000;
    }
    #loading-text {
      margin-bottom: 0.25rem;
    }
    #loading-progress {
      width: 80%;
      max-width: 300px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin: 0.5rem 0;
    }
    h3 {
      margin-top: 1rem;
    }
    p.disclaimer-text {
      text-align: justify;
      max-width: 500px;
      margin: 0 auto;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
      color: #007bff;
      margin-left: 5px;
      font-size: 0.9rem;
    }
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: white;
      text-align: center;
      border-radius: 5px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltip-text,
    .tooltip.active .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    #medrec-logo {
      height: 180px;
      width: auto;
      display: block;
      margin: 0 auto;
      position: relative;
      top: -10px;
      z-index: 1001;
    }
    /* New styles for text input */
    .text-input-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      width: 100%;
    }
    textarea {
      width: 100%;
      max-width: 300px;
      height: 100px;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: none;
      font-family: Arial, sans-serif;
      font-size: 0.9rem;
    }
    textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }
    
    @media print {
  footer { display: none !important; }
  /* hide everything but the results screen */
  header, button, .photo-actions, .progress-bar, #loading,
  .screen:not(#results-screen) {
    display: none !important;
  }
  #results-screen { display: block !important; }

  /* allow the table to grow and show all columns */
  #results-content {
    overflow: visible !important;
    -webkit-overflow-scrolling: auto !important;
    width: auto !important;
    margin: 0 !important;
  }
  table.changes-table {
    width: 100% !important;
    border-collapse: collapse !important;
  }
  table.changes-table th,
  table.changes-table td {
    border: 1px solid #ddd !important;
    padding: 8px !important;
  }
}

main { /* Add padding to main element */
  padding-bottom: 4rem; /* Add space at bottom before footer */
}

footer {
  text-align: center;
  padding: 1rem;
  margin-top: auto; /* Helps push footer down */
  font-size: 0.8rem;
  color: #6c757d; /* Muted grey color */
  background-color: #f4f4f4; /* Match body background */
}

footer a {
  color: #0056b3; /* Link color */
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}

/* ========== highlight rows that contain a contra‑indicated med ========== */
.ci-row {
  background-color: #fffbe6;          /* pale yellow that prints as light grey */
}

  </style>

<!-- === PDF LIBRARIES === -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<!-- === END PDF LIBRARIES === -->

</head>
<body>
  <header>
    <img src="MedRec%20Logo.png" alt="MedRec 2.0 Logo" id="medrec-logo">
    <div class="progress-bar">
      <div class="progress-line-container">
        <div class="progress-line" id="line1-2"></div>
        <div class="progress-line" id="line2-3"></div>
        <div class="progress-line" id="line3-4"></div>
      </div>
      <div class="progress-step" id="step1">1</div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-step" id="step3">3</div>
      <div class="progress-step" id="step4">4</div>
    </div>
  </header>
  <main>
    <div id="error-message"></div>
    <!-- Disclaimer Screen -->
    <div id="disclaimer-screen" class="screen active">
      <h2>Disclaimer</h2>
      <div class="card">
        <p class="disclaimer-text">
          <strong>HIPAA Warning: DO NOT UPLOAD IMAGES CONTAINING IDENTIFIABLE INFORMATION.</strong> This app is intended for use by personnel authorized to handle Protected Health Information (PHI). While MedRec 2.0 is a HIPAA compliant application, users are responsible for ensuring full compliance with HIPAA regulations, including safeguarding resident/patient data and restricting access to authorized personnel only. Unauthorized disclosure of PHI may result in disciplinary action and legal consequences.
<br><br>
          <em>Note:</em> MedRec 2.0 is a support tool and does not guarantee 100% accuracy in identifying medication discrepancies. Final verification must be completed by qualified clinical personnel.
        </p>
      </div>
      <div class="disclaimer-actions">
        <button onclick="acknowledgeDisclaimer()">I Understand</button>
      </div>
    </div>
    <!-- Photo 1 Screen -->
    <div id="photo1-screen" class="screen">
      <div class="card">
        <h2>Enter Medications Before Hospital Stay</h2>
        <p class="upload-instructions">You can take a photo, upload a photo, or paste your medication list below.</p>
        <div id="initial-photo1-options" class="photo-actions">
          <button onclick="document.getElementById('photo1-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo1-upload').click()">Upload Photo</button>
          <div class="text-input-container">
            <textarea id="photo1-text-input" placeholder="Paste your medication list here..."></textarea>
            <button onclick="handleTextInput1()">Submit List</button>
          </div>
        </div>
        <div id="additional-photo1-option" class="photo-actions" style="display: none;">
          <button onclick="document.getElementById('photo1-capture2').click()">Take Another Photo</button>
          <button onclick="document.getElementById('photo1-upload2').click()">Upload Another Photo</button>
        </div>
      </div>
      <input type="file" id="photo1-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto1(this.files)">
      <input type="file" id="photo1-upload" accept="image/*" multiple onchange="handlePhoto1(this.files)">
      <input type="file" id="photo1-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto1(this.files)">
      <input type="file" id="photo1-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto1(this.files)">
      <div id="photo1-preview" class="preview-container"></div>
      <p id="photo1-status"></p>
      <p id="photo1-prompt" class="upload-prompt" style="display: none;"></p>
      <div class="photo-actions">
        <button id="photo1-next" onclick="goToPhoto2()" disabled>Next</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Photo 2 Screen -->
    <div id="photo2-screen" class="screen">
      <div class="card">
        <h2>Enter Hospital Discharge Medications</h2>
        <p class="upload-instructions">You can take a photo, upload a photo, or paste your medication list below.</p>
        <div id="initial-photo2-options" class="photo-actions">
          <button onclick="document.getElementById('photo2-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo2-upload').click()">Upload Photo</button>
          <div class="text-input-container">
            <textarea id="photo2-text-input" placeholder="Paste your medication list here..."></textarea>
            <button onclick="handleTextInput2()">Submit List</button>
          </div>
        </div>
        <div id="additional-photo2-option" class="photo-actions" style="display: none;">
          <button onclick="document.getElementById('photo2-capture2').click()">Take Another Photo</button>
          <button onclick="document.getElementById('photo2-upload2').click()">Upload Another Photo</button>
        </div>
      </div>
      <input type="file" id="photo2-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto2(this.files)">
      <input type="file" id="photo2-upload" accept="image/*" multiple onchange="handlePhoto2(this.files)">
      <input type="file" id="photo2-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto2(this.files)">
      <input type="file" id="photo2-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto2(this.files)">
      <div id="photo2-preview" class="preview-container"></div>
      <p id="photo2-status"></p>
      <p id="photo2-prompt" class="upload-prompt" style="display: none;"></p>
      <div class="photo-actions">
        <button id="photo2-compare" onclick="comparePhotos()" disabled>Compare</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Results Screen -->
    <div id="results-screen" class="screen">
      <h2>Comparison Results</h2>
      <p>Changes listed in <span class="critical">bold red</span> are critical medications and should be reconciled with the provider within <span class="critical">4 hours</span> of discovery.</p>
      <div class="card">
        <div id="results-content"></div>
      </div>
      <div class="photo-actions">
                    <button onclick="exportToPDF()">Export as PDF</button>
        <button onclick="printResults()">Print Results</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
  </main>
<footer>
  &copy; 2025 David Gottschalk. For technical support, please contact <a href="mailto:david@med-reconciliation.com">david@med-reconciliation.com</a>.
</footer>
  <div id="loading">
    <p id="loading-text">Processing...</p>
    <progress id="loading-progress" max="100"></progress>
  </div>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBYrJPALSB45rPm5D0T29rEwCdJ5Ek24ug",
  authDomain: "medrec-solutions-cd00e.firebaseapp.com",
  projectId: "medrec-solutions-cd00e",
  storageBucket: "medrec-solutions-cd00e.appspot.com",
  messagingSenderId: "276805089930",
  appId: "1:276805089930:web:9631c7d4cf223f1666d087"
};
const app = firebase.initializeApp(firebaseConfig);
const functions = firebase.functions(app);
</script>

  <script>
    const criticalMeds = [
      'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban', 'heparin', 'enoxaparin',
      'clopidogrel', 'ticagrelor', 'prasugrel', 'insulin regular', 'insulin glargine', 'insulin detemir',
      'insulin lispro', 'insulin aspart', 'insulin degludec', 'glipizide', 'glyburide', 'glimepiride',
      'repaglinide', 'nateglinide', 'metformin', 'morphine', 'hydromorphone', 'oxycodone', 'fentanyl',
      'methadone', 'tramadol', 'codeine', 'buprenorphine', 'phenytoin', 'carbamazepine', 'valproic acid',
      'phenobarbital', 'lamotrigine', 'levetiracetam', 'digoxin', 'amiodarone', 'sotalol', 'diltiazem',
      'verapamil', 'metoprolol', 'atenolol', 'carvedilol', 'furosemide', 'bumetanide', 'torsemide',
      'spironolactone', 'hydrochlorothiazide', 'chlorthalidone', 'potassium chloride', 'magnesium sulfate',
      'calcium gluconate', 'calcium chloride', 'sodium bicarbonate', 'phosphate', 'hydralazine', 'clonidine',
      'isosorbide mononitrate', 'isosorbide dinitrate', 'nitroglycerin', 'haloperidol', 'risperidone',
      'olanzapine', 'quetiapine', 'aripiprazole', 'ziprasidone', 'lorazepam', 'diazepam', 'clonazepam',
      'temazepam', 'midazolam', 'zolpidem', 'prednisone', 'methylprednisolone', 'dexamethasone',
      'hydrocortisone', 'levothyroxine', 'liothyronine', 'tacrolimus', 'cyclosporine', 'mycophenolate',
      'azathioprine', 'vancomycin', 'gentamicin', 'tobramycin', 'amikacin', 'ciprofloxacin', 'levofloxacin',
      'moxifloxacin', 'azithromycin', 'clarithromycin', 'erythromycin', 'amoxicillin',
      'amoxicillin-clavulanate', 'ceftriaxone', 'cefepime', 'ceftazidime', 'cefdinir', 'cephalexin',
      'piperacillin-tazobactam', 'penicillin vk', 'dicloxacillin', 'nafcillin', 'meropenem', 'ertapenem',
      'imipenem-cilastatin', 'doxycycline', 'minocycline', 'tetracycline', 'linezolid',
      'sulfamethoxazole-trimethoprim', 'nitrofurantoin', 'metronidazole', 'clindamycin', 'fosfomycin',
      'daptomycin', 'tigecycline', 'carbidopa/levodopa', 'entacapone', 'selegiline', 'rasagiline', 'lithium',
      'theophylline', 'clozapine', 'methotrexate', 'allopurinol', 'colchicine', 'tamsulosin', 'finasteride',
      'denosumab', 'zoledronic acid', 'teriparatide', 'alendronate', 'risedronate', 'acetazolamide',
      'bethanechol', 'bethanechol chloride', 'donepezil', 'rivastigmine', 'galantamine', 'memantine',
      'naltrexone', 'naloxone', 'flumazenil', 'desmopressin', 'octreotide', 'erythropoietin', 'filgrastim',
      'calcitriol', 'ergocalciferol', 'cholecalciferol', 'pyridostigmine', 'propranolol', 'labetalol',
      'isosorbide', 'nicardipine', 'nitroprusside', 'ivabradine', 'sacubitril', 'valsartan',
      'atorvastatin', 'rosuvastatin', 'simvastatin', 'Norco', 'oxycodone/acetaminophen', 'hydrocodone/acetaminophen', 'codeine/acetaminophen', 'tramadol/acetaminophen', 'acetaminophen/caffeine/dihydrocodeine', 'aspirin/caffeine/dihydrocodeine', 'aspirin/codeine', 'ibuprofen/oxycodone', 'acetaminophen/butalbital/caffeine', 'aspirin/butalbital/caffeine', 'acetaminophen/butalbital', 'methylphenidate', 'amphetamine/dextroamphetamine', 'hydrocodone/pseudoephedrine', 'hydrocodone/chlorpheniramine', 'hydrocodone/homatropine', 'busulfan', 'doxorubicin', 'adalimumab', 'acetaminophen/isometheptene/dichloralphenazone', 'ultracet', 'percocet', 'roxicet', 'endocet', 'tylenol #3', 'zamicet', 'vicodin', 'lortab', 'panlor ss', 'trezix', 'synalgos-dc', 'empirin with codeine', 'combunox', 'fioricet', 'esgic', 'zebutal', 'fiorinal', 'bupap', 'rezira', 'tussionex', 'hycomine', 'hydromet', 'midrin','chlorpropamide', 'acarbose', 'miglitol', 'argatroban', 'bivalirudin', 'fondaparinux', 'methylergonovine', 'carboplatin', 'cyclophosphamide', 'promethazine'

    ].map(med => med.toLowerCase());

/* Drug Contraindications List */
const drugContraindications = {
  /* 1 */ "atorvastatin": [
           "tipranavir", "ritonavir", "glecaprevir", "pibrentasvir",
           "cyclosporine", "gemfibrozil"
         ],
  /* 2 */ "levothyroxine": [],
  /* 3 */ "lisinopril": [
           "aliskiren", "sacubitril"
         ],
  /* 4 */ "metformin": [],
  /* 5 */ "amlodipine": [],
  /* 6 */ "omeprazole": [
           "rilpivirine", "nelfinavir"
         ],
  /* 7 */ "simvastatin": [
           "itraconazole", "ketoconazole", "posaconazole", "voriconazole",
           "erythromycin", "clarithromycin", "telithromycin", "nelfinavir",
           "ritonavir", "boceprevir", "telaprevir", "nefazodone", "gemfibrozil",
           "cyclosporine", "danazol", "cobicistat", "lomitapide"
         ],
  /* 8 */ "hydrochlorothiazide": [
           "dofetilide", "lithium"
         ],
  /* 9 */ "gabapentin": [],
  /* 10 */ "sertraline": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "pimozide", "procarbazine", "rasagiline", "selegiline",
           "tranylcypromine", "thioridazine"
         ],
  /* 11 */ "amoxicillin": [],
  /* 12 */ "vitamin_d": [],
  /* 13 */ "ibuprofen": [
           "aspirin", "ketorolac", "methotrexate", "pemetrexed"
         ],
  /* 14 */ "apixaban": [
           "defibrotide"
         ],
  /* 15 */ "montelukast": [],
  /* 16 */ "fluticasone": [
           "ritonavir", "ketoconazole"
         ],
  /* 17 */ "escitalopram": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "pimozide", "procarbazine", "rasagiline", "selegiline",
           "tranylcypromine"
         ],
  /* 18 */ "rosuvastatin": [
           "cyclosporine", "gemfibrozil", "sofosbuvir_velpatasvir_voxilaprevir",
           "glecaprevir_pibrentasvir"
         ],
  /* 19 */ "pantoprazole": [
           "rilpivirine", "nelfinavir"
         ],
  /* 20 */ "trazodone": [
           "isocarboxazid", "linezoid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine",
           "saquinavir", "thioridazine"
         ],
  /* 21 */ "losartan": [
           "aliskiren"
         ],
  /* 22 */ "metoprolol": [],
  /* 23 */ "albuterol": [],
  /* 24 */ "bupropion": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 25 */ "duloxetine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine",
           "thioridazine"
         ],
  /* 26 */ "prednisone": [
           "itraconazole", "ketoconazole", "mifepristone"
         ],
  /* 27 */ "aspirin": [
           "ketorolac", "methotrexate"
         ],
  /* 28 */ "cetirizine": [
           "levocetirizine"
         ],
  /* 29 */ "azithromycin": [
           "pimozide", "dihydroergotamine", "ergotamine"
         ],
  /* 30 */ "tramadol": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 31 */ "pravastatin": [
           "gemfibrozil"
         ],
  /* 32 */ "clopidogrel": [],
  /* 33 */ "furosemide": [],
  /* 34 */ "fluoxetine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "pimozide", "procarbazine", "rasagiline", "selegiline",
           "tranylcypromine", "thioridazine"
         ],
  /* 35 */ "citalopram": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "pimozide", "procarbazine", "rasagiline", "selegiline",
           "tranylcypromine", "dasabuvir"
         ],
  /* 36 */ "warfarin": [
           "defibrotide", "mifepristone"
         ],
  /* 37 */ "doxycycline": [
           "acitretin", "isotretinoin", "methoxyflurane"
         ],
  /* 38 */ "tamsulosin": [],
  /* 39 */ "allopurinol": [
           "didanosine", "azathioprine", "mercaptopurine"
         ],
  /* 40 */ "carvedilol": [],
  /* 41 */ "venlafaxine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 42 */ "propranolol": [
           "thioridazine", "rizatriptan"
         ],
  /* 43 */ "spironolactone": [
           "eplerenone", "triamterene", "amiloride"
         ],
  /* 44 */ "lorazepam": [],
  /* 45 */ "clonazepam": [],
  /* 46 */ "zolpidem": [
           "alcohol"
         ],
  /* 47 */ "cyclobenzaprine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 48 */ "meloxicam": [
           "aspirin", "ketorolac"
         ],
  /* 49 */ "lamotrigine": [
           "dofetilide"
         ],
  /* 50 */ "hydrocodone_acetaminophen": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 51 */ "potassium_chloride": [
           "amiloride", "spironolactone", "triamterene", "eplerenone"
         ],
  /* 52 */ "glipizide": [
           "bosentan"
         ],
  /* 53 */ "methylphenidate": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 54 */ "finasteride": [],
  /* 55 */ "insulin_glargine": [],
  /* 56 */ "esomeprazole": [
           "rilpivirine", "nelfinavir"
         ],
  /* 57 */ "pregabalin": [],
  /* 58 */ "sildenafil": [
           "nitroglycerin", "riociguat", "vericiguat", "amyl_nitrite"
         ],
  /* 59 */ "oxycodone": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine",
           "nalmefene", "naltrexone", "samidorphan"
         ],
  /* 60 */ "mirtazapine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 61 */ "alprazolam": [
           "itraconazole", "ketoconazole"
         ],
  /* 62 */ "chlorthalidone": [
           "dofetilide"
         ],
  /* 63 */ "valsartan": [
           "aliskiren", "sacubitril"
         ],
  /* 64 */ "cephalexin": [],
  /* 65 */ "buspirone": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 66 */ "diclofenac": [
           "aspirin", "ketorolac"
         ],
  /* 67 */ "levetiracetam": [],
  /* 68 */ "risperidone": [],
  /* 69 */ "ramipril": [
           "aliskiren", "sacubitril"
         ],
  /* 70 */ "aripiprazole": [],
  /* 71 */ "nitroglycerin": [
           "sildenafil", "tadalafil", "vardenafil", "avanafil",
           "riociguat", "vericiguat"
         ],
  /* 72 */ "quetiapine": [
           "pimozide", "thioridazine"
         ],
  /* 73 */ "atenolol": [],
  /* 74 */ "topiramate": [],
  /* 75 */ "lovastatin": [
           "itraconazole", "ketoconazole", "posaconazole", "voriconazole",
           "erythromycin", "clarithromycin", "telithromycin", "nelfinavir",
           "ritonavir", "boceprevir", "telaprevir", "nefazodone", "gemfibrozil",
           "cyclosporine", "danazol", "cobicistat", "lomitapide"
         ],
  /* 76 */ "tiotropium": [
           "ipratropium"
         ],
  /* 77 */ "adalimumab": [
           "anakinra", "abatacept", "etanercept", "infliximab",
           "golimumab", "certolizumab_pegol"
         ],
  /* 78 */ "semaglutide": [],
  /* 79 */ "tirzepatide": [],
  /* 80 */ "ferrous_sulfate": [
           "dimercaprol"
         ],
  /* 81 */ "calcium_carbonate": [
           "ceftriaxone", "sodium_polystyrene_sulfonate"
         ],
  /* 82 */ "fish_oil": [],
  /* 83 */ "multivitamin": [
           "levodopa"
         ],
  /* 84 */ "magnesium": [
           "raltegravir", "elvitegravir", "dolutegravir", "bictegravir"
         ],
  /* 85 */ "probiotics": [],
  /* 86 */ "coenzyme_q10": [],
  /* 87 */ "melatonin": [],
  /* 88 */ "vitamin_c": [],
  /* 89 */ "vitamin_b12": [
           "chloramphenicol"
         ],
  /* 90 */ "zinc": [
           "penicillamine"
         ],
  /* 91 */ "glucosamine": [],
  /* 92 */ "turmeric": [],
  /* 93 */ "vitamin_e": [
           "warfarin", "dicumarol"
         ],
  /* 94 */ "vitamin_k": [
           "warfarin", "anisindione", "dicumarol"
         ],
  /* 95 */ "collagen": [],
  /* 96 */ "biotin": [],
  /* 97 */ "folic_acid": [
           "methotrexate", "pyrimethamine", "raltitrexed"
         ],
  /* 98 */ "cranberry_extract": [],
  /* 99 */ "ashwagandha": [],
  /* 100 */ "elderberry": [],
  /* 101 */ "benzonatate": [],
  /* 102 */ "budesonide": [
           "ketoconazole", "itraconazole", "ritonavir", "clarithromycin"
         ],
  /* 103 */ "carbidopa_levodopa": [
           "isocarboxazid", "phenelzine", "procarbazine", "tranylcypromine"
         ],
  /* 104 */ "celecoxib": [
           "ketorolac", "aspirin"
         ],
  /* 105 */ "ciprofloxacin": [
           "tizanidine", "agomelatine", "flibanserin", "lomitapide",
           "pimozide", "thioridazine"
         ],
  /* 106 */ "clonidine": [],
  /* 107 */ "donepezil": [],
  /* 108 */ "enalapril": [
           "aliskiren", "sacubitril"
         ],
  /* 109 */ "ezetimibe": [
           "cyclosporine"
         ],
  /* 110 */ "famotidine": [],
  /* 111 */ "fexofenadine": [],
  /* 112 */ "hydralazine": [],
  /* 113 */ "hydroxyzine": [
           "amifampridine", "droperidol", "pimozide", "thioridazine"
         ],
  /* 114 */ "indapamide": [
           "dofetilide", "sulpiride"
         ],
  /* 115 */ "insulin_aspart": [],
  /* 116 */ "ipratropium": [
           "tiotropium", "aclidinium", "umeclidinium", "revefenacin",
           "glycopyrrolate"
         ],
  /* 117 */ "isosorbide": [
           "sildenafil", "tadalafil", "vardenafil", "avanafil",
           "riociguat", "vericiguat"
         ],
  /* 118 */ "ketoconazole": [
           "alfuzosin", "amiodarone", "apixaban", "astemizole", "bepridil",
           "cisapride", "colchicine", "conivaptan", "dabigatran", "darifenacin",
           "disopyramide", "dofetilide", "domperidone", "dronedarone",
           "eletriptan", "eplerenone", "ergotamine", "dihydroergotamine",
           "ergometrine", "methylergometrine", "felodipine", "fesoterodine",
           "flibanserin", "halofantrine", "irinotecan", "isavuconazonium",
           "ivabradine", "levacetylmethadol", "lomitapide", "loperamide",
           "lovastatin", "lurasidone", "methadone", "mifepristone",
           "mizolastine", "naloxegol", "nisoldipine", "oral_midazolam",
           "pimozide", "quinidine", "ranolazine", "rivaroxaban", "salmeterol",
           "sertindole", "simvastatin", "sirolimus", "solifenacin",
           "tacrolimus", "terfenadine", "ticagrelor", "tolvaptan",
           "triazolam", "udenafil", "vardenafil", "vincristine", "voclosporin"
         ],
  /* 119 */ "liraglutide": [],
  /* 120 */ "loratadine": [],
  /* 121 */ "memantine": [],
  /* 122 */ "methocarbamol": [],
  /* 123 */ "metronidazole": [
           "disulfiram", "alcohol", "busulfan"
         ],
  /* 124 */ "mupirocin": [],
  /* 125 */ "nifedipine": [
           "rifampin"
         ],
  /* 126 */ "olanzapine": [
           "samidorphan", "thioridazine", "mesoridazine"
         ],
  /* 127 */ "ondansetron": [
           "apomorphine", "dronedarone", "pimozide", "thioridazine"
         ],
  /* 128 */ "oxybutynin": [],
  /* 129 */ "paroxetine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "pimozide", "procarbazine", "rasagiline", "selegiline",
           "thioridazine", "tranylcypromine"
         ],
  /* 130 */ "pioglitazone": [],
  /* 131 */ "promethazine": [
           "amifampridine", "bepridil", "cisapride", "dronedarone",
           "levomethadyl", "mesoridazine", "pimozide", "piperaquine",
           "sparfloxacin", "terfenadine", "thioridazine", "ziprasidone"
         ],
  /* 132 */ "ranitidine": [],
  /* 133 */ "ropinirole": [
           "sulpiride", "metoclopramide", "thioridazine"
         ],
  /* 134 */ "sotalol": [
           "amifampridine", "amisulpride", "anagrelide", "arsenic_trioxide",
           "astemizole", "azithromycin", "bepridil", "chloroquine",
           "chlorpromazine", "ciprofloxacin", "cisapride", "citalopram",
           "clarithromycin", "clozapine", "crizotinib", "dabrafenib",
           "dasatinib", "degarelix", "delamanid", "disopyramide",
           "dofetilide", "dolasetron", "domperidone", "donepezil",
           "dronedarone", "droperidol", "eribulin", "erythromycin",
           "escitalopram", "famotidine", "fingolimod", "flecainide",
           "fluconazole", "fluoxetine", "foscarnet", "fosphenytoin",
           "galantamine", "gatifloxacin", "gemifloxacin", "glasdegib",
           "granisetron", "halofantrine", "haloperidol", "hydroxychloroquine",
           "hydroxyzine", "ibutilide", "iloperidone", "imipramine",
           "inotuzumab_ozogamicin", "itraconazole", "ivabradine", "ivosidenib",
           "ketoconazole", "lapatinib", "lenvatinib", "leuprolide",
           "levofloxacin", "lithium", "lofexidine", "lumefantrine",
           "macimorelin", "mefloquine", "mesoridazine", "methadone",
           "metronidazole", "mifepristone", "mirtazapine", "mizolastine",
           "mobocertinib", "moxifloxacin", "nilotinib", "norfloxacin",
           "octreotide", "ofloxacin", "olanzapine", "ondansetron",
           "osimertinib", "oxaliplatin", "paliperidone", "panobinostat",
           "papaverine", "paroxetine", "pasireotide", "pazopanib",
           "pentamidine", "perphenazine", "pimavanserin", "pimozide",
           "piperaquine", "pitolisant", "ponesimod", "posaconazole",
           "probucol", "procainamide", "prochlorperazine", "promazine",
           "promethazine", "propafenone", "protriptyline", "quetiapine",
           "quinidine", "quinine", "ranolazine", "relugolix", "ribociclib",
           "risperidone", "ritonavir", "saquinavir", "selpercatinib",
           "sertindole", "sertraline", "sevoflurane", "siponimod",
           "sodium_phosphate", "solifenacin", "sorafenib", "sparfloxacin",
           "sulpiride", "sunitinib", "tacrolimus", "tamoxifen", "telavancin",
           "telithromycin", "terfenadine", "tetrabenazine", "thioridazine",
           "toremifene", "trazodone", "triclabendazole", "trimethoprim",
           "trimipramine", "vandetanib", "vardenafil", "vemurafenib",
           "venlafaxine", "vinflunine", "voriconazole", "vorinostat",
           "ziprasidone", "zolmitriptan", "zuclopenthixol"
         ],
  /* 135 */ "sulfamethoxazole_trimethoprim": [
           "dofetilide", "methenamine", "leucovorin"
         ],
  /* 136 */ "terazosin": [
           "sildenafil", "tadalafil", "vardenafil", "avanafil"
         ],
  /* 137 */ "timolol": [],
  /* 138 */ "tolterodine": [
           "clarithromycin", "itraconazole", "ketoconazole", "ritonavir"
         ],
  /* 139 */ "triamterene": [
           "amiloride", "spironolactone", "eplerenone", "potassium_supplements"
         ],
  /* 140 */ "valacyclovir": [],
  /* 141 */ "verapamil": [
           "atazanavir", "cisapride", "colchicine", "dabigatran",
           "dofetilide", "dronedarone", "eletriptan", "eplerenone",
           "ergotamine", "flibanserin", "ivabradine", "lomitapide",
           "lovastatin", "lurasidone", "naloxegol", "ranolazine",
           "rivaroxaban", "simvastatin", "sirolimus", "tacrolimus",
           "tolvaptan", "udenafil", "voclosporin"
         ],
  /* 142 */ "acyclovir": [],
  /* 143 */ "amiodarone": [
           "atazanavir", "bepridil", "cisapride", "cobicistat",
           "colchicine", "darunavir", "dasabuvir", "digitoxin",
           "disopyramide", "dofetilide", "domperidone", "dronedarone",
           "eliglustat", "elvitegravir", "fingolimod", "flecainide",
           "fluconazole", "fosamprenavir", "gemifloxacin", "halofantrine",
           "ibutilide", "idelalisib", "indinavir", "itraconazole",
           "ivabradine", "ketoconazole", "ledipasvir", "lenvatinib",
           "lopinavir_ritonavir", "lorlatinib", "lumefantrine",
           "mavacamten", "mefloquine", "mesoridazine", "mifepristone",
           "moxifloxacin", "nelfinavir", "nilotinib", "ombitasvir_paritaprevir_ritonavir",
           "pacritinib", "pentamidine", "pimozide", "piperaquine",
           "posaconazole", "procainamide", "propafenone", "quetiapine",
           "quinidine", "ranolazine", "ribociclib", "ritonavir",
           "saquinavir", "simeprevir", "simvastatin", "sofosbuvir",
           "sorafenib", "sotalol", "sparfloxacin", "sulpiride",
           "tacrolimus", "tamoxifen", "telaprevir", "telithromycin",
           "terfenadine", "tetrabenazine", "thioridazine", "tipranavir",
           "toremifene", "trazodone", "vandetanib", "vemurafenib",
           "venetoclax", "vinflunine", "voriconazole", "ziprasidone"
         ],
  /* 144 */ "baclofen": [],
  /* 145 */ "betamethasone": [
           "itraconazole", "ketoconazole", "mifepristone", "ritonavir"
         ],
  /* 146 */ "brimonidine": [
           "isocarboxazid", "phenelzine", "procarbazine", "rasagiline",
           "selegiline", "tranylcypromine"
         ],
  /* 147 */ "candesartan": [
           "aliskiren"
         ],
  /* 148 */ "chlorhexidine": [],
  /* 149 */ "colchicine": [
           "atazanavir", "clarithromycin", "cyclosporine", "darunavir",
           "elvitegravir_cobicistat", "fluconazole", "fosamprenavir",
           "idelalisib", "indinavir", "itraconazole", "ketoconazole",
           "lopinavir_ritonavir", "mifepristone", "nelfinavir",
           "ombitasvir_paritaprevir_ritonavir_dasabuvir", "posaconazole",
           "ranolazine", "ritonavir", "saquinavir", "telaprevir",
           "telithromycin", "tipranavir", "verapamil", "voriconazole"
         ],
  /* 150 */ "dabigatran": [
           "rifampin", "tipranavir", "dronedarone", "ketoconazole",
           "itraconazole", "cyclosporine"
         ],
  /* 151 */ "desvenlafaxine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 152 */ "digoxin": [],
  /* 153 */ "diltiazem": [
           "cisapride", "colchicine", "dabigatran", "dofetilide",
           "dronedarone", "eletriptan", "eplerenone", "ergotamine",
           "flibanserin", "ivabradine", "lomitapide", "lovastatin",
           "lurasidone", "naloxegol", "pimozide", "rivaroxaban",
           "simvastatin", "sirolimus", "tacrolimus", "tolvaptan",
           "udenafil", "voclosporin"
         ],
  /* 154 */ "divalproex": [
           "meropenem"
         ],
  /* 155 */ "dorzolamide": [],
  /* 156 */ "dronedarone": [
           "amifampridine", "amiodarone", "apomorphine", "arsenic_trioxide",
           "asenapine", "astemizole", "atazanavir", "bepridil", "boceprevir",
           "chloroquine", "chlorpromazine", "ciprofloxacin", "cisapride",
           "citalopram", "clarithromycin", "clofazimine", "clomipramine",
           "clozapine", "cobicistat", "colchicine", "conivaptan",
           "crizotinib", "cyclosporine", "dabigatran", "darunavir",
           "dasatinib", "degarelix", "delamanid", "desipramine",
           "dibenzepin", "disopyramide", "dofetilide", "dolasetron",
           "domperidone", "donepezil", "droperidol", "efavirenz",
           "eliglustat", "encorafenib", "entrectinib", "eribulin",
           "erythromycin", "escitalopram", "famotidine", "fexinidazole",
           "fingolimod", "flecainide", "fluconazole", "fluoxetine",
           "formoterol", "foscarnet", "fostemsavir", "galantamine",
           "gatifloxacin", "gemifloxacin", "gepirone", "givinostat",
           "glasdegib", "granisetron", "halofantrine", "haloperidol",
           "hydroxychloroquine", "hydroxyzine", "ibutilide", "idelalisib",
           "iloperidone", "imipramine", "indinavir", "inotuzumab_ozogamicin",
           "itraconazole", "ivabradine", "ivosidenib", "ketoconazole",
           "lapatinib", "lenvatinib", "leuprolide", "levofloxacin",
           "levoketoconazole", "lithium", "lofepramine", "lopinavir",
           "lovastatin", "lumefantrine", "lurasidone", "macimorelin",
           "mefloquine", "mesoridazine", "methadone", "metronidazole",
           "mifepristone", "mirtazapine", "mizolastine", "mobocertinib",
           "moxifloxacin", "nafarelin", "nelfinavir", "nefazodone",
           "nilotinib", "norfloxacin", "nortriptyline", "octreotide",
           "ofloxacin", "olanzapine", "ondansetron", "osilodrostat",
           "osimertinib", "ozanimod", "paliperidone", "panobinostat",
           "papaverine", "paroxetine", "pasireotide", "pazopanib",
           "pentamidine", "perphenazine", "phenobarbital", "pimavanserin",
           "pimozide", "piperaquine", "pipothiazine", "pitolisant",
           "ponesimod", "posaconazole", "primidone", "probucol",
           "procainamide", "prochlorperazine", "promazine", "promethazine",
           "propafenone", "protriptyline", "quetiapine", "quinidine",
           "quinine", "ranolazine", "relugolix", "ribociclib", "rifabutin",
           "rifampin", "rifapentine", "risperidone", "ritonavir",
           "saquinavir", "selpercatinib", "sertindole", "sertraline",
           "sevoflurane", "simeprevir", "simvastatin", "siponimod",
           "sirolimus", "sodium_phosphate", "solifenacin", "sorafenib",
           "sotalol", "sparfloxacin", "sulpiride", "sunitinib", "tacrolimus",
           "tamoxifen", "telaprevir", "telavancin", "telithromycin",
           "terfenadine", "tetrabenazine", "thioridazine", "toremifene",
           "trazodone", "triclabendazole", "trimipramine", "triptorelin",
           "vandetanib", "vardenafil", "vemurafenib", "venlafaxine",
           "verapamil", "vinflunine", "voclosporin", "voriconazole",
           "vorinostat", "ziprasidone", "zolmitriptan", "zuclopenthixol"
         ],
  /* 157 */ "eletriptan": [
           "atazanavir", "clarithromycin", "cobicistat", "darunavir",
           "diltiazem", "elvitegravir", "ergotamine", "fosamprenavir",
           "idelalisib", "indinavir", "itraconazole", "ketoconazole",
           "lopinavir", "nefazodone", "nelfinavir", "posaconazole",
           "ritonavir", "saquinavir", "telaprevir", "telithromycin",
           "tipranavir", "troleandomycin", "verapamil", "voriconazole"
         ],
  /* 158 */ "empagliflozin": [],
  /* 159 */ "enoxaparin": [
           "defibrotide"
         ],
  /* 160 */ "erythromycin": [
           "alfuzosin", "astemizole", "cisapride", "colchicine",
           "dihydroergotamine", "domperidone", "dronedarone", "eletriptan",
           "eplerenone", "ergotamine", "flibanserin", "ivabradine",
           "lomitapide", "lovastatin", "lurasidone", "mevastatin",
           "mifepristone", "naloxegol", "nisoldipine", "oral_midazolam",
           "pimozide", "ranolazine", "rivaroxaban", "saquinavir",
           "silodosin", "simvastatin", "suvorexant", "tasimelteon",
           "terfenadine", "ticagrelor", "tolvaptan", "triazolam",
           "udenafil", "vardenafil", "voclosporin"
         ],
  /* 161 */ "estradiol": [
           "anastrozole", "exemestane", "letrozole", "ospemifene",
           "tamoxifen"
         ],
  /* 162 */ "etanercept": [
           "anakinra", "abatacept", "adalimumab", "infliximab"
         ],
  /* 163 */ "exenatide": [],
  /* 164 */ "fenofibrate": [
           "simvastatin", "rosuvastatin"
         ],
  /* 165 */ "fluconazole": [
           "alfuzosin", "astemizole", "bepridil", "cisapride",
           "colchicine", "darunavir", "dofetilide", "domperidone",
           "dronedarone", "eletriptan", "eliglustat", "eplerenone",
           "ergotamine", "dihydroergotamine", "erythromycin",
           "fesoterodine", "flibanserin", "halofantrine", "irinotecan",
           "isavuconazonium", "ivabradine", "levacetylmethadol",
           "lomitapide", "lopinavir", "lovastatin", "lurasidone",
           "methadone", "mifepristone", "mizolastine", "naloxegol",
           "nisoldipine", "oral_midazolam", "pimozide", "quinidine",
           "ranolazine", "rivaroxaban", "saquinavir", "sertindole",
           "silodosin", "simvastatin", "sirolimus", "solifenacin",
           "tacrolimus", "terfenadine", "thioridazine", "ticagrelor",
           "tipranavir", "tolvaptan", "triazolam", "udenafil",
           "vardenafil", "venetoclax", "vincristine", "voclosporin",
           "voriconazole", "ziprasidone"
         ],
  /* 166 */ "fluvoxamine": [
           "agomelatine", "alosetron", "astemizole", "cisapride",
           "dronedarone", "eplerenone", "eliglustat", "frovatriptan",
           "isocarboxazid", "ivabradine", "linezolid", "lomitapide",
           "lurasidone", "mesoridazine", "methylene_blue", "mevastatin",
           "mizolastine", "nelfinavir", "phenelzine", "pimozide",
           "procarbazine", "ramelteon", "rasagiline", "ropivacaine",
           "saquinavir", "selegiline", "silodosin", "simvastatin",
           "tacrine", "terfenadine", "theophylline", "thioridazine",
           "tizanidine", "tolvaptan", "tranylcypromine", "triazolam",
           "udenafil", "ziprasidone"
         ],
  /* 167 */ "folic_acid": [
           "methotrexate", "pyrimethamine", "raltitrexed"
         ],
  /* 168 */ "gemfibrozil": [
           "atorvastatin", "cerivastatin", "dasabuvir", "ezetimibe",
           "fluvastatin", "lovastatin", "mevastatin", "pitavastatin",
           "pravastatin", "repaglinide", "rosuvastatin", "selexipag",
           "simvastatin"
         ],
  /* 169 */ "glimepiride": [
           "bosentan"
         ],
  /* 170 */ "glyburide": [
           "bosentan"
         ],
  /* 171 */ "heparin": [
           "defibrotide"
         ],
  /* 172 */ "hydrocortisone": [
           "itraconazole", "ketoconazole", "mifepristone", "ritonavir"
         ],
  /* 173 */ "imatinib": [
           "alfuzosin", "astemizole", "bepridil", "cisapride",
           "colchicine", "conivaptan", "darunavir", "dihydroergotamine",
           "domperidone", "dronedarone", "eletriptan", "eplerenone",
           "ergotamine", "fesoterodine", "flibanserin", "halofantrine",
           "irinotecan", "isavuconazonium", "ivabradine", "ketoconazole",
           "levacetylmethadol", "lomitapide", "lovastatin", "lurasidone",
           "methadone", "mifepristone", "mizolastine", "naloxegol",
           "nisoldipine", "oral_midazolam", "pimozide", "quinidine",
           "ranolazine", "rivaroxaban", "salmeterol", "sertindole",
           "silodosin", "simvastatin", "sirolimus", "solifenacin",
           "tacrolimus", "terfenadine", "thioridazine", "ticagrelor",
           "tolterodine", "tolvaptan", "triazolam", "udenafil",
           "vardenafil", "venetoclax", "vincristine", "voclosporin",
           "voriconazole", "ziprasidone"
         ],
  /* 174 */ "irbesartan": [
           "aliskiren"
         ],
  /* 175 */ "labetalol": [
           "thioridazine"
         ],
  /* 176 */ "latanoprost": [],
  /* 177 */ "linagliptin": [],
  /* 178 */ "lisdexamfetamine": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 179 */ "lithium": [
           "sodium_polystyrene_sulfonate", "thioridazine", "ziprasidone"
         ],
  /* 180 */ "loperamide": [
           "eluxadoline", "gemfibrozil", "itraconazole", "ketoconazole",
           "ritonavir", "saquinavir", "tipranavir"
         ],
  /* 181 */ "meclizine": [
           "potassium_chloride"
         ],
  /* 182 */ "methotrexate": [
           "acitretin", "aspirin", "probenecid", "co_trimoxazole",
           "nitrous_oxide"
         ],
  /* 183 */ "methylprednisolone": [
           "itraconazole", "ketoconazole", "mifepristone", "ritonavir"
         ],
  /* 184 */ "minocycline": [
           "acitretin", "isotretinoin", "methoxyflurane", "penicillin"
         ],
  /* 185 */ "mometasone": [
           "ritonavir", "ketoconazole"
         ],
  /* 186 */ "morphine": [
           "isocarboxazid", "linezolid", "methylene_blue", "nalmefene",
           "naltrexone", "phenelzine", "procarbazine", "rasagiline",
           "selegiline", "samidorphan", "tranylcypromine"
         ],
  /* 187 */ "mycophenolate": [
           "azathioprine", "sevelamer", "cholestyramine"
         ],
  /* 188 */ "naproxen": [
           "aspirin", "ketorolac", "methotrexate", "pemetrexed"
         ],
  /* 189 */ "nebivolol": [
           "thioridazine"
         ],
  /* 190 */ "nortriptyline": [
           "cisapride", "dronedarone", "isocarboxazid", "linezolid",
           "mesoridazine", "methylene_blue", "phenelzine", "pimozide",
           "procarbazine", "rasagiline", "safinamide", "selegiline",
           "thioridazine", "tranylcypromine"
         ],
  /* 191 */ "olmesartan": [
           "aliskiren"
         ],
  /* 192 */ "oseltamivir": [],
  /* 193 */ "oxcarbazepine": [
           "eslicarbazepine"
         ],
  /* 194 */ "phenazopyridine": [],
  /* 195 */ "phenytoin": [
           "delavirdine", "rilpivirine", "doravirine", "isavuconazonium",
           "praziquantel", "voriconazole"
         ],
  /* 196 */ "prazosin": [
           "riociguat", "sildenafil", "tadalafil", "vardenafil", "avanafil"
         ],
  /* 197 */ "prochlorperazine": [
           "amifampridine", "astemizole", "bepridil", "cisapride",
           "dronedarone", "fluoxetine", "levomethadyl", "mesoridazine",
           "metrizamide", "paroxetine", "pimozide", "piperaquine",
           "propafenone", "quinidine", "saquinavir", "sparfloxacin",
           "terfenadine", "thioridazine", "toremifene", "ziprasidone"
         ],
  /* 198 */ "propofol": [],
  /* 199 */ "raloxifene": [
           "cholestyramine"
         ],
  /* 200 */ "rivaroxaban": [
           "atazanavir", "carbamazepine", "clarithromycin", "cobicistat",
           "conivaptan", "darunavir", "defibrotide", "elvitegravir",
           "enzalutamide", "fosamprenavir", "idelalisib", "indinavir",
           "itraconazole", "ketoconazole", "lopinavir", "lumacaftor",
           "mifepristone", "mitotane", "nelfinavir", "nefazodone",
           "ombitasvir_paritaprevir_ritonavir_dasabuvir", "phenobarbital",
           "phenytoin", "posaconazole", "primidone", "rifampin",
           "rifabutin", "rifapentine", "ritonavir", "saquinavir",
           "telaprevir", "tipranavir", "troleandomycin", "voriconazole"
         ],
  /* 201 */ "rizatriptan": [
           "ergotamine", "isocarboxazid", "linezolid", "methylene_blue",
           "phenelzine", "procarbazine", "propranolol", "rasagiline",
           "selegiline", "tranylcypromine"
         ],
  /* 202 */ "salmeterol": [
           "atazanavir", "clarithromycin", "cobicistat", "darunavir",
           "elvitegravir", "fosamprenavir", "idelalisib", "indinavir",
           "itraconazole", "ketoconazole", "lopinavir", "nefazodone",
           "nelfinavir", "posaconazole", "ritonavir", "saquinavir",
           "telaprevir", "telithromycin", "tipranavir", "troleandomycin",
           "voriconazole"
         ],
  /* 203 */ "saxagliptin": [],
  /* 204 */ "sitagliptin": [],
  /* 205 */ "sumatriptan": [
           "ergotamine", "isocarboxazid", "linezolid", "methylene_blue",
           "phenelzine", "procarbazine", "rasagiline", "selegiline",
           "tranylcypromine"
         ],
  /* 206 */ "tacrolimus": [
           "astemizole", "cisapride", "cyclosporine", "dronedarone",
           "fluconazole", "itraconazole", "ketoconazole", "mifepristone",
           "pimozide", "posaconazole", "ritonavir", "terfenadine",
           "thioridazine", "tipranavir", "voriconazole", "ziprasidone"
         ],
  /* 207 */ "telmisartan": [
           "aliskiren"
         ],
  /* 208 */ "temazepam": [
           "sodium_oxybate"
         ],
  /* 209 */ "terbinafine": [
           "eliglustat", "flibanserin", "pimozide", "tamoxifen",
           "thioridazine"
         ],
  /* 210 */ "testosterone": [],
  /* 211 */ "tizanidine": [
           "ciprofloxacin", "fluvoxamine", "acyclovir"
         ],
  /* 212 */ "torsemide": [],
  /* 213 */ "trandolapril": [
           "aliskiren", "sacubitril"
         ],
  /* 214 */ "triamcinolone": [
           "itraconazole", "ketoconazole", "mifepristone", "ritonavir"
         ],
  /* 215 */ "valproic_acid": [
           "meropenem"
         ],
  /* 216 */ "vardenafil": [
           "amyl_nitrite", "atazanavir", "boceprevir", "cobicistat",
           "darunavir", "elvitegravir", "fosamprenavir", "idelalisib",
           "indinavir", "isosorbide_dinitrate", "isosorbide_mononitrate",
           "itraconazole", "ketoconazole", "lopinavir", "mifepristone",
           "nelfinavir", "nitroglycerin", "posaconazole", "riociguat",
           "ritonavir", "saquinavir", "telaprevir", "tipranavir",
           "vericiguat", "voriconazole"
         ],
  /* 217 */ "vilazodone": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 218 */ "voriconazole": [
           "alfuzosin", "aprepitant", "astemizole", "atorvastatin",
           "avanafil", "barbiturates", "bosutinib", "bromocriptine",
           "carbamazepine", "cisapride", "colchicine", "conivaptan",
           "dabrafenib", "darunavir", "domperidone", "dronedarone",
           "efavirenz", "eletriptan", "eliglustat", "encorafenib",
           "entrectinib", "eplerenone", "ergotamine", "dihydroergotamine",
           "eslicarbazepine", "estazolam", "everolimus", "fesoterodine",
           "flibanserin", "fluconazole", "fosamprenavir", "fostamatinib",
           "glasdegib", "halofantrine", "hydroxyzine", "idelalisib",
           "indinavir", "irinotecan", "isavuconazonium", "isoniazid",
           "ivabradine", "ivacaftor", "ivosidenib", "lapatinib",
           "levacetylmethadol", "lomitapide", "lopinavir", "lorlatinib",
           "lovastatin", "lumacaftor", "lurasidone", "mavacamten",
           "mefloquine", "mesoridazine", "methadone", "mifepristone",
           "mitotane", "mizolastine", "mobocertinib", "naloxegol",
           "nelfinavir", "neratinib", "nilotinib", "nisoldipine",
           "olaparib", "omaveloxolone", "oral_midazolam", "osilodrostat",
           "osimertinib", "oxcarbazepine", "palbociclib", "panobinostat",
           "pazopanib", "phenytoin", "pimavanserin", "pimozide",
           "piperaquine", "pitavastatin", "pralsetinib", "quetiapine",
           "quinidine", "ranolazine", "regorafenib", "repotrectinib",
           "ribociclib", "rifabutin", "rifampin", "rimegepant",
           "ritonavir", "rivaroxaban", "romidepsin", "rosuvastatin",
           "salmeterol", "saquinavir", "selumetinib", "sertindole",
           "silodosin", "simeprevir", "simvastatin", "sirolimus",
           "sonidegib", "sotorasib", "sunitinib", "suvorexant",
           "tacrolimus", "tadalafil", "tamoxifen", "tasimelteon",
           "tazemetostat", "terfenadine", "tetrabenazine", "thioridazine",
           "ticagrelor", "tipranavir", "tolterodine", "tolvaptan",
           "trabectedin", "trazodone", "triazolam", "ubrogepant",
           "udenafil", "ulipristal", "vandetanib", "vardenafil",
           "vemurafenib", "venetoclax", "vincristine", "vinflunine",
           "voclosporin", "ziprasidone", "zolpidem"
         ],
  /* 219 */ "zaleplon": [
           "sodium_oxybate"
         ],
  /* 220 */ "zonisamide": [
           "topiramate"
         ],
  /* 221 */ "acetaminophen": [],
  /* 222 */ "alendronate": [],
  /* 223 */ "anastrozole": [
           "estradiol", "tamoxifen", "raloxifene"
         ],
  /* 224 */ "azathioprine": [
           "febuxostat", "allopurinol"
         ],
  /* 225 */ "benazepril": [
           "aliskiren", "sacubitril"
         ],
  /* 226 */ "bimatoprost": [],
  /* 227 */ "bisoprolol": [
           "thioridazine"
         ],
  /* 228 */ "buprenorphine": [
           "nalmefene", "naltrexone", "samidorphan"
         ],
  /* 229 */ "cholecalciferol": [],
  /* 230 */ "cimetidine": [
           "astemizole", "cisapride", "dofetilide", "eliglustat",
           "flibanserin", "lomitapide", "pimozide", "terfenadine",
           "thioridazine"
         ],
  /* 231 */ "clarithromycin": [
           "alfuzosin", "astemizole", "cisapride", "colchicine",
           "dihydroergotamine", "domperidone", "dronedarone", "eletriptan",
           "eplerenone", "ergotamine", "fesoterodine", "flibanserin",
           "ivabradine", "levacetylmethadol", "lomitapide", "lovastatin",
           "lurasidone", "mevastatin", "mifepristone", "naloxegol",
           "nisoldipine", "oral_midazolam", "pimozide", "ranolazine",
           "rivaroxaban", "saquinavir", "salmeterol", "silodosin",
           "simvastatin", "suvorexant", "tacrolimus", "tasimelteon",
           "terfenadine", "thioridazine", "ticagrelor", "tolterodine",
           "tolvaptan", "triazolam", "udenafil", "vardenafil",
           "venetoclax", "voclosporin"
         ],
  /* 232 */ "clindamycin": [],
  /* 233 */ "clobetasol": [],
  /* 234 */ "clozapine": [
           "amifampridine", "bepridil", "cisapride", "dronedarone",
           "fluoxetine", "fluvoxamine", "levomethadyl", "mesoridazine",
           "metoclopramide", "paroxetine", "pimozide", "piperaquine",
           "saquinavir", "sertraline", "sparfloxacin", "terfenadine",
           "thioridazine", "ziprasidone"
         ],
  /* 235 */ "codeine": [
           "isocarboxazid", "linezolid", "methylene_blue", "nalmefene",
           "naltrexone", "phenelzine", "procarbazine", "rasagiline",
           "selegiline", "samidorphan", "tranylcypromine"
         ],
  /* 236 */ "dexamethasone": [
           "desmopressin", "itraconazole", "ketoconazole", "mifepristone",
           "ritonavir", "praziquantel", "rilpivirine"
         ],
  /* 237 */ "diazepam": [
           "sodium_oxybate"
         ],
  /* 238 */ "docusate": [
           "mineral_oil"
         ],
  /* 239 */ "entacapone": [
           "isocarboxazid", "linezolid", "methylene_blue", "phenelzine",
           "procarbazine", "rasagiline", "selegiline", "tranylcypromine"
         ],
  /* 240 */ "eplerenone": [
           "clarithromycin", "itraconazole", "ketoconazole", "nefazodone",
           "nelfinavir", "posaconazole", "ritonavir", "saquinavir",
           "telithromycin", "voriconazole", "potassium_supplements"
         ],
  /* 241 */ "felodipine": [
           "carbamazepine", "clarithromycin", "erythromycin", "itraconazole",
           "ketoconazole", "nefazodone", "phenobarbital", "phenytoin",
           "rifampin", "ritonavir", "telithromycin"
         ],
  /* 242 */ "flurazepam": [
           "sodium_oxybate", "itraconazole", "ketoconazole", "ritonavir"
         ],
  /* 243 */ "fosfomycin": [],
  /* 244 */ "haloperidol": [
           "amifampridine", "astemizole", "bepridil", "cisapride",
           "dronedarone", "fluoxetine", "itraconazole", "ketoconazole",
           "levomethadyl", "mesoridazine", "metoclopramide", "paroxetine",
           "pimozide", "piperaquine", "probucol", "propafenone",
           "quinidine", "saquinavir", "sertindole", "sparfloxacin",
           "terfenadine", "thioridazine", "toremifene", "ziprasidone"
         ],
  /* 245 */ "hydroxychloroquine": [
           "amifampridine", "dronedarone", "fingolimod", "halofantrine",
           "mefloquine", "pimozide", "saquinavir", "tamoxifen",
           "thioridazine", "ziprasidone"
         ],
  /* 246 */ "infliximab": [
           "anakinra", "abatacept", "adalimumab", "etanercept"
         ],
  /* 247 */ "isoniazid": [
           "disulfiram", "carbamazepine", "phenytoin", "valproic_acid"
         ],
  /* 248 */ "ketorolac": [
           "aspirin", "celecoxib", "diclofenac", "diflunisal", "etodolac",
           "fenoprofen", "flurbiprofen", "ibuprofen", "indomethacin",
           "ketoprofen", "meclofenamate", "mefenamic_acid", "meloxicam",
           "nabumetone", "naproxen", "oxaprozin", "pentoxifylline",
           "piroxicam", "probenecid", "sulindac", "tolmetin"
         ],
  /* 249 */ "letrozole": [
           "estradiol", "tamoxifen", "raloxifene"
         ],
  /* 250 */ "lidocaine": [
           "amiodarone", "dofetilide", "dronedarone", "propafenone",
           "quinidine", "tocainide"
         ]
};

function canonicalDrugKey(name) {
  return (name || '').toLowerCase().replace(/[^a-z0-9]/g,'').trim();
}

function hasContra(orderObj, wholeList = []) {
  /* real check can be added later */
  return false;
}

    const commonMedications = [
      { generic: "hydrocodone/acetaminophen", brands: ["Norco", "Vicodin", "Lortab", "Zamicet"] },
      { generic: "oxycodone/acetaminophen",  brands: ["Percocet", "Xartemis XR", "Roxicet", "Endocet"] },
               { generic: "codeine/acetaminophen",     brands: ["Tylenol #3"] },
               { generic: "tramadol/acetaminophen",    brands: ["Ultracet"] },
               { generic: "acetaminophen/caffeine/dihydrocodeine", brands: ["Panlor SS", "Trezix"] },
               { generic: "aspirin/caffeine/dihydrocodeine",       brands: ["Synalgos-DC"] },
               { generic: "aspirin/codeine",            brands: ["Empirin with codeine"] },
               { generic: "acetaminophen/butalbital/caffeine", brands: ["Fioricet", "Esgic", "Zebutal"] },
               { generic: "aspirin/butalbital/caffeine", brands: ["Fiorinal"] },
               { generic: "acetaminophen/butalbital",   brands: ["Bupap"] },
               { generic: "hydrocodone/pseudoephedrine", brands: ["Rezira"] },
               { generic: "hydrocodone/chlorpheniramine", brands: ["Tussionex", "Hycomine"] },
               { generic: "hydrocodone/homatropine",    brands: ["Hydromet"] },
               { generic: "busulfan",                   brands: ["Myleran"] },
               { generic: "acetaminophen/isometheptene/dichloralphenazone", brands: ["Midrin"] },
               { generic: "ibuprofen/oxycodone",        brands: ["Combunox"] },
      { generic: "acetaminophen", brands: ["Tylenol"] },
      { generic: "albuterol", brands: ["Ventolin", "ProAir", "Proventil", "salbutamol"] },
      { generic: "allopurinol", brands: ["Zyloprim"] },
      { generic: "alprazolam", brands: ["Xanax"] },
      { generic: "amlodipine", brands: ["Norvasc"] },
      { generic: "amoxicillin", brands: ["Amoxil", "Trimox"] },
      { generic: "aspirin", brands: ["Bayer", "Ecotrin"] },
      { generic: "atenolol", brands: ["Tenormin"] },
      { generic: "atorvastatin", brands: ["Lipitor"] },
      { generic: "azithromycin", brands: ["Zithromax", "Z-Pak"] },
      { generic: "bisoprolol", brands: ["Zebeta"] },
      { generic: "budesonide", brands: ["Pulmicort", "Rhinocort"] },
              { generic: "budesonide/formoterol", brands: ["Symbicort"] },
               {   generic: "calcium gluconate",  brands: [] },
               {   generic: "calcium chloride",   brands: [] },
               {   generic: "calcium carbonate",  brands: [] },
               {   generic: "calcium citrate",    brands: [] }, 
      { generic: "cefuroxime", brands: ["Ceftin", "Zinacef"] },
      { generic: "cephalexin", brands: ["Keflex"] },
      { generic: "cetirizine", brands: ["Zyrtec"] },
      { generic: "ciprofloxacin", brands: ["Cipro"] },
      { generic: "citalopram", brands: ["Celexa"] },
      { generic: "clindamycin", brands: ["Cleocin"] },
      { generic: "clonazepam", brands: ["Klonopin"] },
      { generic: "clopidogrel", brands: ["Plavix"] },
      { generic: "cyclobenzaprine", brands: ["Flexeril"] },
      { generic: "digoxin", brands: ["Lanoxin"] },
      { generic: "doxycycline", brands: ["Vibramycin"] },
      { generic: "duloxetine", brands: ["Cymbalta"] },
      { generic: "enalapril", brands: ["Vasotec"] },
      { generic: "escitalopram", brands: ["Lexapro"] },
      { generic: "esomeprazole", brands: ["Nexium"] },
      { generic: "ferrous sulfate", brands: [] },
      { generic: "fluoxetine", brands: ["Prozac"] },
      { generic: "fluticasone", brands: ["Flonase", "Flovent"] },
      { generic: "furosemide", brands: ["Lasix"] },
      { generic: "gabapentin", brands: ["Neurontin"] },
      { generic: "glipizide", brands: ["Glucotrol"] },
      { generic: "glyburide", brands: ["Diabeta", "Micronase"] },
      { generic: "hydralazine", brands: ["Apresoline"] },
      { generic: "hydrochlorothiazide", brands: ["Microzide"] },
      { generic: "ibuprofen", brands: ["Advil", "Motrin"] },
              { generic: "insulin aspart", brands: ["Novolog"] },
      { generic: "insulin glargine", brands: ["Lantus", "Basaglar"] },
      { generic: "insulin lispro", brands: ["Humalog"] },
      { generic: "irbesartan", brands: ["Avapro"] },
      { generic: "isosorbide mononitrate", brands: ["Imdur"] },
      { generic: "ketorolac", brands: ["Toradol"] },
      { generic: "levothyroxine", brands: ["Synthroid", "Levoxyl"] },
      { generic: "lisinopril", brands: ["Prinivil", "Zestril"] },
      { generic: "lorazepam", brands: ["Ativan"] },
      { generic: "losartan", brands: ["Cozaar"] },
      { generic: "melatonin", brands: [] },
      { generic: "meloxicam", brands: ["Mobic"] },
      { generic: "metformin", brands: ["Glucophage"] },
      { generic: "methotrexate", brands: ["Trexall"] },
      { generic: "metoprolol", brands: ["Lopressor", "Toprol XL"] },
      { generic: "montelukast", brands: ["Singulair"] },
      { generic: "naproxen", brands: ["Aleve", "Naprosyn"] },
      { generic: "nifedipine", brands: ["Procardia", "Adalat"] },
      { generic: "nystatin", brands: ["Mycostatin"] },
      { generic: "omeprazole", brands: ["Prilosec"] },
      { generic: "oxycodone", brands: ["OxyContin", "Roxicodone"] },
      { generic: "pantoprazole", brands: ["Protonix"] },
      {   generic:    "polyethylene glycol",  brands: ["MiraLAX","GaviLAX","GlycoLax","PEG 3350"] },
      { generic: "pravastatin", brands: ["Pravachol"] },
      { generic: "prednisone", brands: ["Deltasone"] },
      { generic: "propranolol", brands: ["Inderal"] },
      { generic: "quinapril", brands: ["Accupril"] },
      { generic: "ranitidine", brands: ["Zantac"] },
      { generic: "rosuvastatin", brands: ["Crestor"] },
      { generic: "sertraline", brands: ["Zoloft"] },
      { generic: "simvastatin", brands: ["Zocor"] },
      { generic: "sitagliptin", brands: ["Januvia"] },
      { generic: "sotalol", brands: ["Betapace"] },
      { generic: "spironolactone", brands: ["Aldactone"] },
      { generic: "sulfamethoxazole-trimethoprim", brands: ["Bactrim", "Septra"] },
      { generic: "tamsulosin", brands: ["Flomax"] },
      { generic: "tramadol", brands: ["Ultram"] },
      { generic: "trazodone", brands: ["Desyrel"] },
      { generic: "valacyclovir", brands: ["Valtrex"] },
      { generic: "valproic acid", brands: ["Depakene"] },
      { generic: "venlafaxine", brands: ["Effexor"] },
      { generic: "verapamil", brands: ["Calan", "Verelan"] },
      { generic: "warfarin", brands: ["Coumadin"] },
      { generic: "zolpidem", brands: ["Ambien"] },
      { generic: "amphetamine/dextroamphetamine", brands: ["Adderall", "Adderall XR"] },
      { generic: "alendronate", brands: ["Fosamax"] },
      { generic: "tadalafil", brands: ["Cialis"] },
      { generic: "fluticasone/umeclidinium/vilanterol", brands: ["Trelegy"] },
      { generic: "empagliflozin", brands: ["Jardiance"] },
      { generic: "semaglutide", brands: ["Ozempic", "Wegovy"] },
      { generic: "vitamin d", brands: ["Drisdol"] },
      { generic: "prednisolone", brands: ["Pred Forte"] },
      { generic: "enoxaparin", brands: ["Lovenox", "Clexane"] },
      { generic: "doxorubicin", brands: ["Adriamycin"] },
      { generic: "adalimumab", brands: ["Humira"] },
      { generic: "rivaroxaban", brands: ["Xarelto"] },
      { generic: "methylphenidate", brands: ["Ritalin", "Concerta"] },
      { generic: "memantine", brands: ["Namenda"] },
      { generic: "isosorbide", brands: [] },
      { generic: "isosorbide dinitrate", brands: [] }
    ];
	// ——— Map every brand name to its generic ———
    const brandToGenericMap = {};
    commonMedications.forEach(({ generic, brands }) => {
      brands.forEach(brand => {
        brandToGenericMap[brand.toLowerCase()] = generic.toLowerCase();
      });
    });

    // ——— Map every generic to its brands ———
    const genericToBrandMap = {};
    Object.entries(brandToGenericMap).forEach(([brand, generic]) => {
      if (!genericToBrandMap[generic]) genericToBrandMap[generic] = [];
      genericToBrandMap[generic].push(brand);
    });

  function normalizeMedicationName(name) {
  if (!name) return '';
  let n = name.toLowerCase().trim();

  /* 1 .  Convert any brand name that appears anywhere in the text
         (e.g. “symbicort 160/4.5”) to its generic. */
  for (const brand in brandToGenericMap) {
  const re = new RegExp('\\b' + brand + '\\b', 'gi');   // word‑boundary match
  n = n.replace(re, brandToGenericMap[brand]);          // swap **inside** the string
}


  /* 2 .  Strip common salt words */
  n = n.replace(/\b(sodium|hydrochloride|acetate|phosphate|carbonate)\b/g, '')
       .trim();

  /* 3 .  Remove timing / meal phrases that sneak into the name */
  n = n.replace(
  /\b(?:\d+\s*(?:min(?:ute)?s?|hr|hrs?|hours?)\s*)?(?:at|before|after|with|without)\s+(?:breakfast|lunch|dinner|meal(?:s)?|night|bedtime|morning|evening)\b/ig,
  ''
).trim();

  /* 4 .  Final cleanup */
  n = n.replace(/[^a-z0-9 ]+/g, '').replace(/\s+/g, ' ');
  return n;
}

    const unitVariants = {
  tablet:   ['tab','tabs','tablet','tablets','tab.','tablet.'],
  capsule:  ['cap','caps','capsule','capsules','caplet','cap.','gelcap','softgel','gel','sprinkle','sprinkles'],
  spray:    ['spray','sprays'],
  puff:     ['puff','puffs'],
  drop:     ['drop','drops','gtt','gtts','gt','drp'],
  patch:    ['patch','patches','transdermal patch'],
  injection:['shot','syringe','pen','inj','auto-injector'],
  lozenge:  ['lozenge','loz','troche'],
  suppository:['supp','suppositories'],
  solution: ['solution','sol','liq','liquid','oral sol'],
  ointment: ['ointment','oint','ung','cream','gel'],
  inhalation:['inhaler','inh','neb','nebulizer','mdi','dpi'],
  unit:     ['U','IU','units'],
  mL:       ['ml','mL','cc'],
  mcg:      ['μg','mcg','ug'],
  mg:       ['mg'],
  mEq:      ['meq', 'mEq', 'milliequivalents'],
  g:        ['g','gram','grams']
};


    let photo1Files = [];
    let photo2Files = [];
    let meds1 = [], meds2 = [];
    let hasTextInput1 = false; // Track if Photo 1 used text input
    let hasTextInput2 = false; // Track if Photo 2 used text input

    async function processFiles(files) {
      let allText = "";
      let lowConfidence = false;
      for (let file of files) {
        try {
          const result = await processFile(file);
//=== STEP 2  cleaned with keepOrderLines
const cleaned = keepOrderLines(result.text);
allText += "\n" + cleaned.join("\n");
//=== END STEP 2

          if (result.confidence < 0.8) {
            lowConfidence = true;
          }
        } catch (err) {
          console.error("Error processing file: ", err);
        }
      }
      if (lowConfidence) {
        showError("Warning: Some text was unclear and may not be accurate. Please review manually.");
      }
      return allText;
    }

function processFile(file) {
  return new Promise((resolve, reject) => {
    if (!file) {
      console.error('No file provided to processFile');
      reject(new Error("No file provided"));
      return;
    }
    console.log('Processing file:', file.name, file.type, file.size);
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        if (!e.target.result) {
          console.error('FileReader result is undefined');
          throw new Error('FileReader result is undefined');
        }
        const imageData = e.target.result;
        console.log('Sending image data:', imageData.substring(0, 100));
        const payload = { data: { image: imageData } };
        console.log('Payload being sent:', payload);
        const callOcrFunction = firebase.functions().httpsCallable('callOcrTest');
        const response = await callOcrFunction(payload);
        console.log('Received response from callOcrTest:', response);
        if (!response.data || typeof response.data !== 'object') {
          throw new Error('Invalid response from OCR function');
        }
        resolve(response.data);
      } catch (err) {
        console.error('Error in processFile:', err);
        reject(err);
      }
    };
    reader.onerror = () => {
      console.error('FileReader error:', reader.error);
      reject(new Error("File could not be read: " + reader.error));
    };
    reader.readAsDataURL(file);
  });
}
async function testCallOcr() {
  try {
    const callOcrFunction = firebase.functions().httpsCallable('callOcrTest');
    const payload = { data: { test: "Hello, world!" } };
    console.log('Testing callOcrTest with payload:', payload);
    const response = await callOcrFunction(payload);
    console.log('Test response from callOcrTest:', response);
  } catch (err) {
    console.error('Error in testCallOcr:', err);
  }
}
    /**
     * If a single line actually contains two orders (two doses),
     * split it into two.
     */
    function splitConcatOrders(line) {
      // look for two dose patterns in one line
      const doseRegex = /\d+\s*(?:mg|mcg|g|mL|tablet|capsule|puff|drop|unit|IU)\b/gi;
      const matches = [...line.matchAll(doseRegex)];
      if (matches.length > 1) {
        const splitAt = matches[1].index;
        return [
          line.slice(0, splitAt).trim(),
          line.slice(splitAt).trim()
        ];
      }
      return [ line ];
    }

    /**
     * If a “continuation” line didn’t itself name a drug,
     * glue it back onto the previous order.
     */
    function mergeMultiLineOrders(lines) {
      const merged = [];
      lines.forEach(l => {
        if (/^[a-z]/i.test(l) && /\d/.test(l)) {
          // starts like an order → new entry
          merged.push(l);
        } else if (merged.length) {
          // continuation → append
          merged[merged.length - 1] += ' ' + l;
        } else {
          // no previous → keep alone
          merged.push(l);
        }
      });
      return merged;
    }

    /**
     * Merge “Day 1…”, “Day 2…” lines (taper packs) back onto
     * the preceding order line.
     */
    function mergeTaperPackOrders(lines) {
      const out = [];
      lines.forEach(l => {
        if (/^day\s*\d+/i.test(l) && out.length) {
          out[out.length - 1] += ' ' + l;
        } else {
          out.push(l);
        }
      });
      return out;
    }

    // ←── END INSERT ──▶

//=== STEP 1  keepOrderLines helper =========================
function keepOrderLines(rawText) {
  const DEBUG_JUNK = false;   // flip to true to see what you drop

//=== STEP‑SPLITMULTI  ⬇︎ break “A … B …” lines into two =================
rawText = rawText
  .replace(/\s{2,}/g, '\n')               // two+ spaces  → new line
  .replace(/(?:,|;|\band\b)/gi, '\n');    // commas/“and” → new line
//=== END STEP‑SPLITMULTI =================================================

  return rawText
    .split(/\r?\n+/)                 // → separate lines
    .map(line => cleanLine(line))    // → trim weird endings
  .flatMap(splitConcatOrders)      // → split “lisinopril … polyethylene …”
    .filter(line => {
      const keep =
        isLikelyOrderLine(line) &&   // letters + numbers?
       ( containsKnownMedication(line) ||    // ↖ try drug list first
         /\d+\s*(mg|mcg|g|mL|units|tablet|capsule|puff|drop)\b/i.test(line) )
        && /\d/.test(line);          // must still have a digit
      if (!keep && DEBUG_JUNK) console.log('🗑️', line);
      return keep;
    });
}
//=== END STEP 1 ============================================

    function cleanLine(line) {
  	// 1) drop any “number.” or “number)” at the start
  	line = line.replace(/^\s*\d+[\.\)]\s*/, '');
  	// 2) remove trailing non-alphanumeric junk and trim
  	return line.replace(/[^a-z0-9]+$/i, '').trim();
}


// ——— remove trailing junk from merged lines ———
function pruneLine(line) {
  // keep dose → form → route → freq → PRN → “for … pain” or “moderate pain”
  // only strip off trailing garbage like “;” or OCR noise, but preserve any
  // remaining words (e.g. “for hypertension” or “heart failure”)
  return line.trim();
 }

    function isLikelyOrderLine(line) {
      //=== STEP 3  stricter test
if (line.length < 5) return false;
const good = (line.match(/[a-z0-9]/gi) || []).length;
return good / line.length >= 0.5;
//=== END STEP 3
    }

function containsKnownMedication(line) {
  const lower = line.toLowerCase();

  // 1) Critical meds always match
  if (criticalMeds.some(med => lower.includes(med))) return true;

  // 2) Any brand name in commonMedications also counts
  if (commonMedications.some(m =>
        m.brands.some(b => lower.includes(b.toLowerCase()))
      )) return true;

  // 3) Generic names or dose patterns as before
  return commonMedications.some(med => lower.includes(med.generic))
      || /\d+\s*(?:mg|mcg|units|puffs|tabs?|tablets?|capsules?)\b/.test(lower);
}

    // ——— Text normalizer — no more stat inside statin ———
function normalizeText(str) {
  let text = (str || '').toLowerCase()

    // your existing expansions…
    .replace(/\bnow\b/g, 'immediately')
    // only match "stat" when it's not embedded in another word
    .replace(/(?<![a-z])stat(?![a-z])/g, 'immediately')
    .replace(/\bqhs\b/g, 'at bedtime')
    .replace(/\bnightly\b/g, 'at bedtime')
    // NEW – map the common abbreviation
    .replace(/\bsob\b/g, 'shortness of breath')
    // …all the rest of your shorthand/frequency → full-text rules…

  // final cleanup:
  return text
    .replace(/\s+/g, ' ')
    .trim();
}


// ——— What changed? ———
function getChangeReason(orig, updated) {
  console.log('DEBUG getChangeReason: orig.drug=', orig.drug, 'updated.drug=', updated.drug);
  console.log('DEBUG getChangeReason: orig Parsed=', JSON.stringify(orig));
  console.log('DEBUG getChangeReason: updated Parsed=', JSON.stringify(updated));



  if (!orig || !updated) return 'Misc. Change';

  // 1) Taper packs (day N) always multi
  if (/\bday\s*\d+\b/i.test(orig.drug) || /\bday\s*\d+\b/i.test(updated.drug)) {
    return 'Multiple changes';
  }

  const norm = s => (s || '').toLowerCase().trim().replace(/\s+/g, ' ');
  const canon = f => {
    f = norm(f);
    return (f === '' || f === 'daily' || f === 'q24h') ? 'daily' : f;
  };

  // --- Start Debugging Conditions for Indication-Only Check ---
  const drugNameMatch = normalizeMedicationName(orig.drug) === normalizeMedicationName(updated.drug);
  const doseValueMatch = orig.dose?.value === updated.dose?.value;
  const doseUnitMatch = orig.dose?.unit === updated.dose?.unit;
  const frequencyMatch = canon(orig.frequency) === canon(updated.frequency);
  const timeOfDayMatch = norm(orig.timeOfDay) === norm(updated.timeOfDay); // << THE KEY ONE
  const formMatch = norm(orig.form) === norm(updated.form);
  const routeMatch = norm(orig.route) === norm(updated.route);
  const prnMatch = orig.prn === updated.prn;
  const indicationDiff = norm(orig.indication) !== norm(updated.indication);

  console.log('DEBUG Indication-Only Check Conditions:');
  console.log('  drugNameMatch:', drugNameMatch, `(${normalizeMedicationName(orig.drug)} vs ${normalizeMedicationName(updated.drug)})`);
  console.log('  doseValueMatch:', doseValueMatch, `(${orig.dose?.value} vs ${updated.dose?.value})`);
  console.log('  doseUnitMatch:', doseUnitMatch, `(${orig.dose?.unit} vs ${updated.dose?.unit})`);
  console.log('  frequencyMatch:', frequencyMatch, `(${canon(orig.frequency)} vs ${canon(updated.frequency)})`);
  console.log('  timeOfDayMatch:', timeOfDayMatch, '(orig:', orig.timeOfDay, 'vs upd:', updated.timeOfDay, ')');
  console.log('  formMatch:', formMatch, `(${norm(orig.form)} vs ${norm(updated.form)})`);
  console.log('  routeMatch:', routeMatch, `(${norm(orig.route)} vs ${norm(updated.route)})`);
  console.log('  prnMatch:', prnMatch, `(${orig.prn} vs ${updated.prn})`);
  console.log('  indicationDiff:', indicationDiff, `(${norm(orig.indication)} vs ${norm(updated.indication)})`);
  // --- End Debugging Conditions ---

let changes = [];
const add = lbl => { if (!changes.includes(lbl)) changes.push(lbl); };

/* ----------   2.a)  Salt / formulation changes   ---------- */

const trivialSalts = ['sodium','potassium','calcium','acetate',
                      'phosphate','carbonate','hydrochloride'];
const criticalSalts = ['succinate','tartrate','gluconate','chloride',
                       'anhydrous','choline','modified'];  // expand as needed

const origWords = norm(orig.drug).split(' ');
const updWords  = norm(updated.drug).split(' ');

const origSalt = origWords.find(w => trivialSalts.includes(w) || criticalSalts.includes(w));
const updSalt  = updWords .find(w => trivialSalts.includes(w) || criticalSalts.includes(w));

 /* -----------------------------------------------------------
    SALT‑SWAP  ►  treat as a change whenever the *core* drug
    (brand/generic minus any salt words) is the same.
   ----------------------------------------------------------- */
 const coreDrug = n => n.replace(/\b(?:sodium|potassium|calcium|acetate|phosphate|carbonate|hydrochloride|succinate|tartrate|gluconate|anhydrous|choline|modified)\b/gi,'').trim();
 const coreMatch = coreDrug(orig.drug) === coreDrug(updated.drug);

 if (coreMatch &&    doseValueMatch && doseUnitMatch &&
    frequencyMatch && timeOfDayMatch &&
    formMatch && routeMatch && prnMatch &&
    origSalt !== updSalt                      // something changed
){
  /* If swap involves a critical salt → flag it; else ignore */
  if (criticalSalts.includes(origSalt) || criticalSalts.includes(updSalt)) {
      return 'Salt form changed';             // real discrepancy
  }
  return 'Unchanged';                         // cosmetic only
}

 /* add the flag to the running list as well, so it shows up
    together with dose / frequency if those changed too */
 if (coreMatch && origSalt !== updSalt) {
   add('Salt form changed');
 }
 
// 2) **Indication-only**
  if (
    drugNameMatch &&
    doseValueMatch &&
    doseUnitMatch &&
    frequencyMatch &&
    timeOfDayMatch && // Uses the debugged variable
    formMatch &&
    routeMatch &&
    prnMatch &&
    indicationDiff
  ) {
    console.log('DEBUG: Matched Indication-only block.');
    return 'Indication changed';
  }
  console.log('DEBUG: Did NOT match Indication-only block.');

   // ——— 3) Time-of-day-only, but allow QOD→daily ———
// THIS IS YOUR EXISTING DEFINITION - KEEP IT AS IS
const isQodToDaily =
  canon(orig.frequency) === 'every other day' &&
  canon(updated.frequency) === 'daily';

// START OF ADDED LOGGING (goes *before* your existing if-statement for Block #3)
console.log("--- DEBUGGING BLOCK #3 ---");
console.log("Values feeding into Block #3 condition:");
console.log("  Orig Parsed (relevant parts): freq='", orig.frequency, "', tod='", orig.timeOfDay, "', indic='", orig.indication, "'");
console.log("  Updated Parsed (relevant parts): freq='", updated.frequency, "', tod='", updated.timeOfDay, "', indic='", updated.indication, "'");
console.log("  !timeOfDayMatch:", !timeOfDayMatch);
console.log("  drugNameMatch:", drugNameMatch);
console.log("  doseValueMatch:", doseValueMatch);
console.log("  doseUnitMatch:", doseUnitMatch);
console.log("  frequencyMatch:", frequencyMatch);
console.log("  isQodToDaily (from your definition above):", isQodToDaily); // Uses your existing isQodToDaily
console.log("  (frequencyMatch || isQodToDaily):", (frequencyMatch || isQodToDaily));
console.log("  formMatch:", formMatch);
console.log("  routeMatch:", routeMatch);
console.log("  prnMatch:", prnMatch);
console.log("  Indication Match (norm(orig.indication) === norm(updated.indication)):", norm(orig.indication) === norm(updated.indication));
// END OF ADDED LOGGING

// THIS IS YOUR EXISTING IF STATEMENT FOR BLOCK #3:
// Modify it by adding the console.log inside the if, and adding the else block.
if (
  !timeOfDayMatch &&
  drugNameMatch &&
  doseValueMatch &&
  doseUnitMatch &&
  (frequencyMatch || isQodToDaily) && // This uses your existing isQodToDaily
  formMatch &&
  routeMatch &&
  prnMatch &&
  norm(orig.indication) === norm(updated.indication)
) {
  // ADD THIS LOG INSIDE THE EXISTING IF
  console.log("--- BLOCK #3 CONDITION MET --- Returning 'Time of day changed'");
  return 'Time of day changed'; // Your existing return statement
}
// ADD THIS ELSE BLOCK TO YOUR EXISTING IF
else {
  console.log("--- BLOCK #3 CONDITION FAILED --- Proceeding to build 'changes' array.");
}

// REMOVE ANY DUPLICATE IF BLOCK FOR THIS LOGIC.
// The code should now flow directly to the 'let changes = [];' part
// if Block #3's condition was false.


// 4) Brand ↔ Generic
  {
    const a = normalizeMedicationName(orig.drug);
    const b = normalizeMedicationName(updated.drug);
    if (a === b) {
      const isA = brandToGenericMap[norm(orig.drug)];
      const isB = brandToGenericMap[norm(updated.drug)];
      if (Boolean(isA) !== Boolean(isB)) add('Brand/Generic changed');
    }
  }

// ----- Dose / quantity differences -----
const inhaled = o =>
  /inhal|puff|neb|mdi|dpi/.test(norm(o.form)) || /inhal/.test(norm(o.route));

const origDoseVal = typeof orig.dose?.value === 'number' ? orig.dose.value : -Infinity;
const updDoseVal  = typeof updated.dose?.value === 'number' ? updated.dose.value : -Infinity;

const origQty = orig.qty ?? 1;
const updQty  = updated.qty ?? 1;

/* ── 1) strength ( mg / mcg / mEq … ) changed ── */
if (origDoseVal !== updDoseVal || orig.dose?.unit !== updated.dose?.unit) {
  if (!(inhaled(orig) && inhaled(updated))) {    // keep your inhaler exemption
    add('Dose changed');
  }
}

/* ── 2) same strength, only #‑tablets / #‑puffs changed ── */
else if (origQty !== updQty) {
  add('Quantity changed');                       // << NEW LABEL
}

  // 6) Frequency
  if (canon(orig.frequency) !== canon(updated.frequency)) {
    // Avoid flagging "daily" vs "" as a frequency change if timeOfDay is used to imply daily
    if (!( (canon(orig.frequency)==='daily' && updated.frequency === '') ||
           (orig.frequency === '' && canon(updated.frequency)==='daily') )) {
        add('Frequency changed');
    }
  }
  // 7) Time-of-day (second pass) - only add if not already covered by exclusive ToD change
  if (!timeOfDayMatch) { // norm(orig.timeOfDay) !== norm(updated.timeOfDay)
    add('Time of day changed');
  }

/* ---------- 8) Form difference (revised) ---------- */
const formA = norm(orig.form);
const formB = norm(updated.form);

// flag only if BOTH sides name a form *and* they’re different
if (formA && formB && formA !== formB) {
  add('Form changed');
}


  // 9) PRN
  if (orig.prn !== updated.prn) {
    add('PRN changed');
  }
  // 10) Indication (catch ANY remaining indication diff)
  if (indicationDiff) { // norm(orig.indication) !== norm(updated.indication)
    add('Indication changed');
  }

  // collapse trivial TOD/freq double-hit
  if (changes.includes('Frequency changed') && changes.includes('Time of day changed') &&
    canon(orig.frequency) === 'daily' && canon(updated.frequency) === 'daily') {
    changes = changes.filter(c => c !== 'Frequency changed');
  }
  // collapse inhaler form/route double-hit
  if (changes.includes('Form changed') && changes.includes('Route changed') && inhaled(orig) && inhaled(updated)) { // check if both are inhaled
    changes = changes.filter(c => c !== 'Route changed'); // or form, depending on preference
  }

// --- New Rule for Stat/Immediately vs. Timed Dosing ---
const origFreqIsImmediately = norm(orig.frequency) === 'immediately';
const updatedFreqIsDaily = canon(updated.frequency) === 'daily';
const origTODIsEmpty = norm(orig.timeOfDay) === '';
const updatedTODIsSet = norm(updated.timeOfDay) !== '';

if (changes.includes('Frequency changed') && changes.includes('Time of day changed') &&
    origFreqIsImmediately && updatedFreqIsDaily && origTODIsEmpty && updatedTODIsSet) {
  changes = changes.filter(c => c !== 'Time of day changed');
  if (norm(orig.indication) === 'immediately' && norm(updated.indication) === '') {
    changes = changes.filter(c => c !== 'Indication changed');
  }
}
// --- End of New Rule ---

  console.log('DEBUG: changes array before final fallback:', JSON.stringify(changes));

  // Fallback "only indication changed" check (this is the redundant block)
  // Ensure this doesn't incorrectly override if multiple changes were genuinely detected
  if (changes.length > 1 || changes.length === 0) { // Only try this if the array logic didn't find a single specific change (excluding indication itself if it was the only one)
      if (
        drugNameMatch &&
        doseValueMatch &&
        doseUnitMatch &&
        frequencyMatch &&
        timeOfDayMatch &&
        formMatch &&
        routeMatch &&
        prnMatch &&
        indicationDiff // Crucially, indication MUST be different for this to make sense
      ) {
        console.log('DEBUG: Matched Fallback Indication-only block.');
        return 'Indication changed';
      } else if ( // All same AND indication is same (truly unchanged)
        drugNameMatch &&
        doseValueMatch &&
        doseUnitMatch &&
        frequencyMatch &&
        timeOfDayMatch &&
        formMatch &&
        routeMatch &&
        prnMatch &&
        !indicationDiff // Indication is also the same
      ) {
         console.log('DEBUG: Fallback found no changes (Misc. Change or Unchanged).');
         return 'Misc. Change'; // Or 'Unchanged' if you prefer that label
      }
  }
  console.log('DEBUG: Final changes array:', JSON.stringify(changes));

  if (changes.length === 0) return 'Misc. Change'; // Or 'Unchanged'
  if (changes.length === 1) return changes[0];
  return 'Multiple changes';
}

    function parseOrder(orderStr) {
  // Keep a copy of the original input for debugging if needed at the very end
  // const originalInputToParseOrder = orderStr;
  const originalRaw = orderStr;   // keep untouched copy
  orderStr = orderStr.replace(/[\u2010\u2011\u2012\u2013\u2014\u2015\u2212]/g, '-');
  orderStr = normalizeText(orderStr); // Normalizes "qhs" to "at bedtime", etc.

  let order = {
    drug: "",
    dose: { value: null, unit: '', total: null },
    qty: null,
    route: "",
    frequency: "",
    timeOfDay: "",
    administration: "",
    prn: false,
    form: "",
    indication: ""
  };

  // 1. Extract Time-of-Day and common morning/evening/night shorthands
//    Also sets frequency if implied by the shorthand (e.g., qam is daily)
const timeOfDayMappings = [
  { regex: /\bdaily\s+in\s+(the\s+)?morning\b/i, timeOfDay: 'morning', frequency: 'daily', originalTermRegexPos: 0 },
  { regex: /\bqam\b/i, timeOfDay: 'morning', frequency: 'daily', originalTerm: 'qam' },
  { regex: /\bevery\s+morning\b/i, timeOfDay: 'morning', frequency: 'daily', originalTermRegexPos: 0 }, // MOVED UP
  { regex: /\b(in\s+the\s+)?morning\b/i, timeOfDay: 'morning', originalTermRegexPos: 0 },                 // NOW AFTER "every morning"

  { regex: /\bqpm\b/i, timeOfDay: 'evening', frequency: 'daily', originalTerm: 'qpm' },
  { regex: /\bevery\s+evening\b/i, timeOfDay: 'evening', frequency: 'daily', originalTermRegexPos: 0 }, // MOVED UP
  { regex: /\b(in\s+the\s+)?evening\b/i, timeOfDay: 'evening', originalTermRegexPos: 0 },                 // NOW AFTER "every evening"

  { regex: /\bqhs\b/i, timeOfDay: 'bedtime', frequency: 'daily', originalTerm: 'qhs' },
  { regex: /\bnightly\b/i,   timeOfDay: 'bedtime', frequency: 'daily', originalTerm: 'nightly' },
  { regex: /\bevery\s+night\b/i, timeOfDay: 'bedtime', frequency: 'daily', originalTermRegexPos: 0 },    // MOVED UP
  { regex: /\b(at\s+)?bedtime\b/i, timeOfDay: 'bedtime', originalTermRegexPos: 0 },                       // Stays
  { regex: /\bat\s+night\b/i, timeOfDay: 'bedtime', frequency: 'daily', originalTermRegexPos: 0 },
  { regex: /\bnight\b/i, timeOfDay: 'bedtime', originalTermRegexPos: 0 }                                  // Stays, general "night" last for bedtime
];

let todProcessed = false;
for (const mapping of timeOfDayMappings) {
  const match = orderStr.match(mapping.regex);
  if (match) {
    order.timeOfDay = mapping.timeOfDay;
    
// Determine the exact string that was matched to replace it accurately
    orderStr = orderStr.replace(match[0], '').trim(); // Replace the entire matched part

    if (mapping.frequency && !order.frequency) { // Only set frequency if not already set by a more specific term
      order.frequency = mapping.frequency;
    }
    todProcessed = true;
    // console.log(`DEBUG parseOrder Step 1 (TimeShorthand): tod="<span class="math-inline">\{order\.timeOfDay\}", freq\="</span>{order.frequency}", orderStr="${orderStr}"`);
    break; // Processed one, move on
  }
}

// If a time of day was found (e.g. "morning") but frequency wasn't set by a specific shorthand (like qam, every morning)
// then assume it's a daily frequency.
if (order.timeOfDay && !order.frequency) {
    order.frequency = 'daily';
    // console.log(`DEBUG parseOrder Step 1 (Implied Daily Freq): tod="<span class="math-inline">\{order\.timeOfDay\}", freq\="</span>{order.frequency}"`);
}

/* ——— NEW: capture “before / after breakfast|lunch|dinner”
          with an optional numeric offset ——— */
if (!order.timeOfDay) {
  const mealTiming =
    orderStr.match(/\b(?:\d+\s*(?:min(?:ute)?s?|hr|hrs?|hours?)\s*)?(before|after)\s+(breakfast|lunch|dinner)\b/i);
  if (mealTiming) {
    order.timeOfDay = mealTiming[0].replace(/\s+/g, ' ').trim();
    if (!order.frequency) order.frequency = 'daily';      // give it a default
    orderStr = orderStr.replace(mealTiming[0], '').trim(); // strip the phrase

    /* ——— ALSO strip a trailing “daily” so it doesn’t sink into the drug name ——— */
    orderStr = orderStr.replace(/\bdaily\b/i, '').trim();
  }
}

// only strip “every” for time-of-day phrases
orderStr = orderStr
  .replace(/\bevery\s+(morning|evening|night)\b/gi, '$1')
  .trim();


  // 2. Extract Administration (with/without food/water)
  const adminMatch = orderStr.match(
  new RegExp(
    String.raw`\b(?:with|w\/)\s*(?:meals?|food|water|juice|liquid)\b|` +
    String.raw`\b(?:without|w\/o)\s*(?:meals?|food|water|juice|liquid)\b|` +
    String.raw`\b(?:before|after)\s*(?:meals?|food)\b`,
    'i'
  )
);


  if (adminMatch) {
    const prefix = adminMatch[0].toLowerCase().startsWith('with') ? 'with ' : 'without ';
    const noun = (adminMatch[1] || adminMatch[2] || '').toLowerCase();
    order.administration = prefix + noun;
    orderStr = orderStr.replace(adminMatch[0], '').trim();
    // console.log(`DEBUG parseOrder Step 2 (Admin): order.administration="${order.administration}", orderStr="${orderStr}"`);
  }

    // 3. Extract PRN  ── now catches “as needed”
  const prnRegex = /\b(?:prn|as\s+needed)\b/i;
  if (prnRegex.test(orderStr)) {
    order.prn = true;
    orderStr = orderStr.replace(prnRegex, '').trim();

    // console.log(`DEBUG parseOrder Step 3 (PRN): order.prn=${order.prn}, orderStr="${orderStr}"`);
  }

  // 4. Extract Indications - This is a critical section
  // Attempt to find "for [text]" first, as it's a strong indication marker.
  // Example: "for moderate pain", "for blood pressure"
  const forIndicationRegex = /\bfor\s+([a-zA-Z0-9\s\/.-]+)/i;
  let forIndicationMatchResult = orderStr.match(forIndicationRegex);
  if (forIndicationMatchResult && forIndicationMatchResult[1]) {
    const potentialIndication = forIndicationMatchResult[1].trim().toLowerCase();
    order.indication = potentialIndication;
    orderStr = orderStr.replace(forIndicationMatchResult[0], '').trim(); // Remove "for [indication]"
    // console.log(`DEBUG parseOrder Step 4a (For Indication): order.indication="${order.indication}", orderStr="${orderStr}"`);
  }

  // If no "for" indication, check for specific keywords like "pain", "shortness of breath"
  // This needs to be careful not to grab parts of drug names.
  if (!order.indication) {
    // Matches phrases like "moderate pain", "acute pain", or just "pain" if it's clearly an indication
    const painIndicRegex = /\b((?:[a-zA-Z]+(?:\s+[a-zA-Z]+)*)?\s*pain)\b/i;
    const painIndicMatch = orderStr.match(painIndicRegex);
    // Ensure the match is not just the drug name itself if the drug name contains "pain"
    if (painIndicMatch && painIndicMatch[0] && painIndicMatch.index > 0) { // Check index > 0 to avoid matching if "pain" is the start (could be drug)
      // Further check: make sure we are not grabbing "drugname pain" if "pain" is part of a common suffix for the drug.
      // This is complex. For now, a simple match:
      let matchedPainStr = painIndicMatch[0].trim().toLowerCase();
      order.indication = matchedPainStr;
      orderStr = orderStr.replace(painIndicMatch[0], '').trim();
      // console.log(`DEBUG parseOrder Step 4b (Pain Indication): order.indication="${order.indication}", orderStr="${orderStr}"`);
    }
  }

  if (!order.indication) {
    const sobMatch = orderStr.match(/\bshortness of breath\b/i); // "SOB" is already expanded by normalizeText
    if (sobMatch) {
      order.indication = 'shortness of breath';
      orderStr = orderStr.replace(sobMatch[0], '').trim();
      // console.log(`DEBUG parseOrder Step 4c (SOB Indication): order.indication="${order.indication}", orderStr="${orderStr}"`);
    }
  }
  // At this point, for your new order, order.indication should ideally be "moderate pain"
  // and orderStr should be "atorvastatin 40 mg tablet po" (or similar for other drugs)

  // console.log(`DEBUG parseOrder: After indication attempts: orderStr="${orderStr}", indication="${order.indication}"`);

  // 5. Extract Dose (mg/kg, combo-dose, then general unit parsing)
  const weightMatch = orderStr.match(/(\d+(?:\.\d+)?)\s*mg\/kg\b/i);
  if (weightMatch) {
    order.dose = { value: parseFloat(weightMatch[1]), unit: 'mg/kg', total: null }; // total might need patient weight
    orderStr = orderStr.replace(weightMatch[0], '').trim();
  } else {
    const comboMatch = orderStr.match(/(\d+)\s*-\s*(\d+)\s*mg\b/);
    if (comboMatch) {
      order.dose = {
        value: [parseInt(comboMatch[1], 10), parseInt(comboMatch[2], 10)],
        unit: 'mg',
        total: null // Or sum them: parseInt(comboMatch[1], 10) + parseInt(comboMatch[2], 10)
      };
      orderStr = orderStr.replace(comboMatch[0], '').trim();
    } else {
      // General dose unit parsing
const allUnits = Object.values(unitVariants).flat();
let unitMatchesFound = [];
for (let u of allUnits) {
  if (typeof u !== 'string' || !u) continue;
  const re = new RegExp(`(\\d+(?:\\.\\d+)?)\\s*${u.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\b`, 'ig');
  let m;
  while ((m = re.exec(orderStr)) !== null) {
    unitMatchesFound.push({ idx: m.index, qty: +m[1], rawUnit: u, matchStr: m[0] });
  }
}

if (unitMatchesFound.length > 0) {
  const precedence = ['mcg','mg','g','mEq','unit','mL',
                      'tablet','capsule','patch','puff','drop'];

  const hits = unitMatchesFound.map(m => {
    const stdUnit = Object.entries(unitVariants)
          .find(([std, arr]) => arr.includes(m.rawUnit))?.[0] || m.rawUnit;
    return { ...m, stdUnit, score: precedence.indexOf(stdUnit) };
  });

  hits.sort((a, b) => {
    if (a.score !== b.score) return a.score - b.score;  // better unit first
    return a.idx - b.idx;                               // tie → earlier hit
  });

  const bestMatch = hits[0];
  order.dose = { value: bestMatch.qty,
                 unit:  bestMatch.stdUnit,
                 total: bestMatch.qty };

  orderStr = orderStr.replace(bestMatch.matchStr, '').trim();
  // …and drop any leftover verb that preceded the dose phrase
  orderStr = orderStr.replace(/\b(?:give|take|administer)\b\s*/i, '').trim();
}
// Fallback if unitMatchesLoop didn't set a dose value but a number is present

      else if (!order.dose.value) {
         const doseUnitsForFallback = ['mcg','mg','g','ml','cc','unit','units','tsp','tbsp','drop','spray','puff','patch','lozenge','suppository','tablet','capsule','each','dose'];
         const fallbackDoseRegex = new RegExp(`(\\d+(?:\\.\\d+)?)(?:\\s*(${doseUnitsForFallback.join('|')})(?:s|es)?\\b)?`, 'i');
         // This regex tries to find a number, optionally followed by a unit.
         // Example: "1", "1 tablet", "10 mg"
         const fallbackMatch = orderStr.match(fallbackDoseRegex);
         if (fallbackMatch && fallbackMatch[1]) {
            const qty = parseFloat(fallbackMatch[1]);
            let unit = (fallbackMatch[2] || '').toLowerCase();
            let formFromUnit = "";

            if (unit) {
                // Normalize unit from unitVariants
                const foundStdUnit = Object.entries(unitVariants).find(([std, arr])=> arr.includes(unit));
                if(foundStdUnit) unit = foundStdUnit[0];

                // Check if this "unit" is actually a form
                if (unitVariants.tablet.includes(unit)) { formFromUnit = 'tablet'; unit = 'tablet';} // or keep unit as 'tablet'
                else if (unitVariants.capsule.includes(unit)) { formFromUnit = 'capsule'; unit = 'capsule';}
                // ... (add other form-like units)

                order.dose = { value: qty, unit: unit, total: qty };
                orderStr = orderStr.replace(fallbackMatch[0], '').trim();
                if(formFromUnit && !order.form) order.form = formFromUnit;
                // console.log(`DEBUG parseOrder Step 5 (Dose - fallbackDoseRegex): dose=${JSON.stringify(order.dose)}, orderStr="${orderStr}"`);
            }
         }
      }
    }
  }

  // Normalize dose units (mcg/g to mg) AFTER all dose parsing attempts
  if (order.dose.value !== null && typeof order.dose.value === 'number') { // Check if value is a number
    if (order.dose.unit === 'mcg') {
      order.dose.value = order.dose.value / 1000;
      if (order.dose.total != null) order.dose.total = order.dose.total / 1000;
      order.dose.unit = 'mg';
    } else if (order.dose.unit === 'g') {
      order.dose.value = order.dose.value * 1000;
      if (order.dose.total != null) order.dose.total = order.dose.total * 1000;
      order.dose.unit = 'mg';
    }
    // Round mg values
    if (order.dose.unit === 'mg') {
      order.dose.value = Math.round(order.dose.value * 1000) / 1000;
      if (order.dose.total != null) {
        order.dose.total = Math.round(order.dose.total * 1000) / 1000;
      }
    }
  }
  // console.log(`DEBUG parseOrder: After dose normalization: dose=${JSON.stringify(order.dose)}, orderStr="${orderStr}"`);

  /* -------- capture count per dose (e.g. “give 2 tablets”) -------- */
  if (order.qty === null) {
    const q = originalRaw.match(/\b(?:give|take|administer)\s+(\d+(?:\.\d+)?)\s*(?:tab|tabs?|tablet|tablets|cap|caps?|capsule|capsules)\b/i);
    if (q) order.qty = parseFloat(q[1]);
  }
  /* ---------------------------------------------------------------- */

// 6. Extract Form (if not already identified by dose parsing)
if (!order.form) {
  // New, more specific form words list - longest phrases first
  const formDefinitions = [
    { term: 'extended-release tablet', canonical: 'extended-release tablet' },
    { term: 'delayed-release tablet', canonical: 'delayed-release tablet' },
    { term: 'chewable tablet', canonical: 'chewable tablet' },
    { term: 'effervescent tablet', canonical: 'effervescent tablet' },
    { term: 'sublingual tablet', canonical: 'sublingual tablet' },
    { term: 'oral disintegrating tablet', canonical: 'oral disintegrating tablet' },
    { term: 'odt', canonical: 'oral disintegrating tablet' }, // ODT
    { term: 'tablet', canonical: 'tablet' },
    { term: 'extended-release capsule', canonical: 'extended-release capsule' },
    { term: 'delayed-release capsule', canonical: 'delayed-release capsule' },
    { term: 'capsule', canonical: 'capsule' },
    { term: 'caplet', canonical: 'caplet' },
    { term: 'softgel', canonical: 'softgel' },
    { term: 'patch', canonical: 'patch' }, { term: 'patches', canonical: 'patch' },
    { term: 'lozenge', canonical: 'lozenge' },
    { term: 'suppository', canonical: 'suppository' },
    { term: 'spray', canonical: 'spray' },
    { term: 'puff', canonical: 'puff' },
    { term: 'drop', canonical: 'drop' }, { term: 'drops', canonical: 'drop' },
    { term: 'suspension', canonical: 'suspension' },
    { term: 'solution', canonical: 'solution' },
    { term: 'elixir', canonical: 'elixir' },
    { term: 'syrup', canonical: 'syrup' },
    { term: 'liquid', canonical: 'liquid' },
    { term: 'cream', canonical: 'cream' },
    { term: 'ointment', canonical: 'ointment' },
    { term: 'gel', canonical: 'gel' },
    { term: 'inhaler', canonical: 'inhaler' },
    { term: 'mdi', canonical: 'inhaler' },
    { term: 'nebule', canonical: 'nebule' }, { term: 'nebulizer solution', canonical: 'nebule'}
  ];

  // Build regex from sorted form terms (longest first to ensure correct matching)
  const sortedFormTerms = formDefinitions.map(fd => fd.term).sort((a, b) => b.length - a.length);
  // Escape terms for regex and join with |
  const formRegexPattern = sortedFormTerms.map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
  const formRegex = new RegExp(`\\b(${formRegexPattern})\\b`, 'i');
  const formMatch = orderStr.match(formRegex);

  if (formMatch && formMatch[1]) {
    const matchedTerm = formMatch[1].toLowerCase();
    // Find the definition again using the matched term (case-insensitive find)
    const definition = formDefinitions.find(fd => fd.term.toLowerCase() === matchedTerm);
    if (definition) {
      order.form = definition.canonical;
      orderStr = orderStr.replace(formMatch[0], '').trim();
      // console.log(`DEBUG parseOrder Step 6 (Form): order.form="<span class="math-inline">\{order\.form\}", orderStr\="</span>{orderStr}"`);
    }
  }
} 


  // 7. Extract Route
  const routes = [
    { standard: "po", variations: ["po", "oral", "by mouth"] }, { standard: "sl", variations: ["sl", "sublingual"] },
    { standard: "buccal", variations: ["buccal"] }, { standard: "pr", variations: ["pr", "rectal", "rectally"] },
    { standard: "ng", variations: ["ng", "nasogastric", "ng tube"] }, { standard: "og", variations: ["og", "orogastric"] },
    { standard: "gastrostomy", variations: ["gastrostomy", "g-tube", "peg tube"] }, { standard: "jejunostomy", variations: ["jejunostomy", "j-tube"] },
    { standard: "iv", variations: ["iv", "intravenous", "intravenously"] }, { standard: "im", variations: ["im", "intramuscular", "intramuscularly"] },
    { standard: "subq", variations: ["subq", "sc", "subcutaneous", "subcutaneously"] }, { standard: "id", variations: ["id", "intradermal"] },
    { standard: "io", variations: ["io", "intraosseous"] }, { standard: "intrathecal", variations: ["intrathecal"] },
    { standard: "epidural", variations: ["epidural"] }, { standard: "topical", variations: ["topical", "topically", "apply to skin"] },
    { standard: "transdermal", variations: ["transdermal"] }, { standard: "ophthalmic", variations: ["ophthalmic", "in eye", "eye drop"] },
    { standard: "otic", variations: ["otic", "in ear", "ear drop"] }, { standard: "nasal", variations: ["nasal", "intranasal", "in nose", "nasal spray"] },
    { standard: "vaginal", variations: ["vaginal", "vaginally"] }, { standard: "urethral", variations: ["urethral"] },
    { standard: "intrauterine", variations: ["intrauterine"] }, { standard: "inhalation", variations: ["inhalation", "inhaled", "inh", "mdi", "dpi", "nebulized", "neb"] },
    { standard: "intraperitoneal", variations: ["intraperitoneal"] }, { standard: "intraarticular", variations: ["intraarticular", "intra-articular"] },
    { standard: "intrapleural", variations: ["intrapleural"] }, { standard: "intravesical", variations: ["intravesical"] },
    { standard: "implantable", variations: ["implantable"] }
  ];
  if (!order.route) {
    for (const routeDef of routes) {
      for (const variation of routeDef.variations) {
        const routeRegex = new RegExp(`\\b${variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
        if (routeRegex.test(orderStr)) {
          order.route = routeDef.standard;
          orderStr = orderStr.replace(routeRegex, '').trim();
          break;
        }
      }
      if (order.route) break;
    }
    // console.log(`DEBUG parseOrder Step 7 (Route): order.route="${order.route}", orderStr="${orderStr}"`);
  }


  // 8. Extract Frequency

// Explicitly check for "immediately" first, as it's a specific frequency from "stat" or "now"
const immediatelyPattern = /\bimmediately\b/i;
if (!order.frequency && immediatelyPattern.test(orderStr)) {
    order.frequency = "immediately";
    orderStr = orderStr.replace(immediatelyPattern, '').trim();
    // console.log(`DEBUG parseOrder Step 8a (Immediately): order.frequency="<span class="math-inline">\{order\.frequency\}", orderStr\="</span>{orderStr}"`);
}
// Now proceed with other frequency checks if not "immediately"
if (!order.frequency) { // <<<< ADD THIS OPENING 'if' and its brace
  
  const qhMatch = orderStr.match(/\bq(\d+)h\b/i);
  if (qhMatch) {
    order.frequency = `q${qhMatch[1]}h`;
    orderStr = orderStr.replace(qhMatch[0], '').trim();
  } else {
    
    // *** NEW CHECK FOR qXhrs ***
    const qhrsMatch = orderStr.match(/\bq(\d+)(?:hrs|hr)\b/i); // Match q<number>hrs or q<number>hr
    if (qhrsMatch) {
        order.frequency = `q${qhrsMatch[1]}h`; // Normalize to qXh
        orderStr = orderStr.replace(qhrsMatch[0], '').trim();
        // console.log(`DEBUG parseOrder Step 8b (qXhrs): freq="<span class="math-inline">\{order\.frequency\}", orderStr\="</span>{orderStr}"`);
    } else { // This 'else' means qXhrs also failed
        const everyHours = orderStr.match(/\bevery\s*(\d+)\s*hours?\b/i);
        if (everyHours) {
          order.frequency = `q${everyHours[1]}h`;
          orderStr = orderStr.replace(everyHours[0], '').trim();
        } else {
          const freqMapping = { /* ... your existing map ... */
              "once daily": "daily", "once a day": "daily", "1 times daily": "daily", "daily": "daily", "od": "daily", "qd": "daily",
              "twice daily": "twice daily", "2 times daily": "twice daily", "bid": "twice daily",
              "three times daily": "three times daily", "3 times daily": "three times daily", "tid": "three times daily",
              "four times daily": "four times daily", "4 times daily": "four times daily", "qid": "four times daily",
              "every other day": "every other day", "qod": "every other day",
              "stat": "immediately", "now": "immediately",
              "weekly": "weekly", "once a week": "weekly",
              "monthly": "monthly", "once a month": "monthly"
          };
          const sortedFreqKeys = Object.keys(freqMapping).sort((a, b) => b.length - a.length);
          for (const key of sortedFreqKeys) {
            const pattern = new RegExp(`\\b${key.replace(/\s+/g, '\\s+')}\\b`, 'i');
            // Check !order.frequency again inside the loop
            if (!order.frequency && pattern.test(orderStr)) {
              order.frequency = freqMapping[key];
              orderStr = orderStr.replace(pattern, '').trim();
              break;
            }
          }
        }
	}
    }
}
// ... (end of Step 8 for frequency parsing)
  if (!order.frequency && order.timeOfDay) {
    order.frequency = 'daily';
  }
  // console.log(`DEBUG parseOrder Step 8 (Frequency): order.frequency="${order.frequency}", orderStr="${orderStr}"`);

// --- START OF NEW STEP 9 ---
// 9. Final Drug Name and Indication Assignment from remaining orderStr

orderStr = orderStr.trim();
// One last aggressive cleanup of leading non-alphanumeric characters or isolated numbers/units from orderStr
orderStr = orderStr.replace(/^[^a-zA-Z0-9]+/, '').trim(); // Remove leading non-alphanumeric
orderStr = orderStr.replace(/^(\d+(?:\.\d+)?\s*([a-zA-Zμ]+([eE][qQ])?)s?)\s*(?=[a-zA-Z]|$)/i, '').trim(); // Remove leading number/unit if followed by text or end

if (!order.drug && orderStr.length > 0) {
    // If order.drug has not been set by a very specific pattern earlier,
    // assume the entire remaining orderStr is the drug name.
    // Specific indication phrases like "for [text]" should have been parsed already.
    order.drug = orderStr;
} else if (order.drug && orderStr.length > 0 && !order.indication) {
    // If order.drug WAS set by an earlier specific rule,
    // and there's still text in orderStr, and indication is empty,
    // this remaining text is likely an indication or part of a complex instruction.
    order.indication = orderStr;
}
// If both order.drug and order.indication were already set, any remaining orderStr is considered unparsed.

// Cleanup and standardize drug name
if (order.drug) {
    let drugName = order.drug;
    // Attempt to remove common, very generic trailing words that are not part of the core drug name
    // This list can be expanded carefully.
    const genericTrailingWords = /\s+(tablet|capsule|solution|suspension|injection|ointment|cream|syrup|elixir|powder|inhale[rd]?|spray|oral|for oral use|for use|extended release|delayed release|modified release|er|xr|sr|dr|chewable|effervescent)$/i;
    drugName = drugName.replace(genericTrailingWords, '').trim();
    drugName = drugName.replace(genericTrailingWords, '').trim(); // Apply twice for patterns like "extended release tablet"

    order.drug = drugName
        .replace(/[^a-zA-Z0-9\/\s-]+/g, ' ') // Allow alphanumeric, slash, hyphen, space
        .replace(/\s\s+/g, ' ')             // Collapse multiple spaces
        .trim()
        .toLowerCase();                     // Ensure drug name is lowercase
} else {
    order.drug = ""; // Default to empty string if no drug found
}

// Cleanup and standardize indication
if (order.indication) {
    order.indication = order.indication
        .replace(/\s\s+/g, ' ')
        .trim()
        .toLowerCase();

    // Clear indication if it looks like a dose strength that was misparsed (safeguard)
    const looksLikeOnlyDoseStrength = /^(\d+(\.\d+)?(\/\d+(\.\d+)?)?\s*([a-zA-Zμ]+([eE][qQ])?)s?)$/i;
    if (looksLikeOnlyDoseStrength.test(order.indication)) {
        // console.log(`DEBUG parseOrder: Clearing indication that is just a dose strength: "${order.indication}" for drug "${order.drug}"`);
        order.indication = "";
    }
    // Add more specific cleanups for indication if needed, but be cautious not to remove valid text.
    const veryGenericIndicationRemnants = /^(po|sc|iv|im|sl|subq|tablet|cap|unit|puff|gtt|mg|mcg|ml|cc|daily|bid|tid|qid|qhs|prn|stat)$/i;
    if (veryGenericIndicationRemnants.test(order.indication) && order.indication.split(' ').length <= 2) {
        order.indication = "";
    }

} else {
    order.indication = ""; // Default to empty string
}
// --- END OF NEW STEP 9 ---

  // console.log('FINAL DEBUG Parsed order:', { /* input: originalInputToParseOrder, */ parsed: order });
  return order;
}

    function levenshteinDistance(a, b) {
      const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
      for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
      for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
      for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
          const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j][i - 1] + 1,
            matrix[j - 1][i] + 1,
            matrix[j - 1][i - 1] + indicator
          );
        }
      }
      return matrix[b.length][a.length];
    }

    function similarity(a, b) {
      const distance = levenshteinDistance(a, b);
      const maxLen = Math.max(a.length, b.length);
      return 1 - distance / maxLen;
    }

/* ===========================================================
   Find every contra‑indicated pair present in the full list
   =========================================================== */
function findContraIndications(allOrders) {
  const medsFound  = allOrders
        .map(o => coreDrugName(o.parsed.drug))   // << one canonical key
        .filter(Boolean);                        // drop blanks / junk
  const uniqueMeds = [...new Set(medsFound)];
  const warnings = [];

  uniqueMeds.forEach(med => {
    const badList = drugContraindications[med];
    if (!badList || badList.length === 0) return;

    badList.forEach(bad => {
      if (uniqueMeds.includes(bad)) {
        const key = [med, bad].sort().join(' + ');   // avoid duplicates A+B / B+A
        if (!warnings.find(w => w.key === key)) {
          warnings.push({ key, a: med, b: bad });
        }
      }
    });
  });

  return warnings;          // array like [{key:'atorvastatin + gemfibrozil', a:'atorvastatin', b:'gemfibrozil'}]
}

    function ordersAreEqual(a, b) {
  // 1) drug name
  const normA = normalizeMedicationName(a.drug);
  const normB = normalizeMedicationName(b.drug);
  const drugSimilarity = normA && normB
    ? similarity(normA, normB)
    : (normA === normB ? 1 : 0);
  if (drugSimilarity < 0.85) return false;

  // 2) dose (including combos)
  if (Array.isArray(a.dose.value) || Array.isArray(b.dose.value)) {
    if (!Array.isArray(a.dose.value) || !Array.isArray(b.dose.value)) return false;
    if (a.dose.value.length !== b.dose.value.length) return false;
    for (let i = 0; i < a.dose.value.length; i++) {
      if (a.dose.value[i] !== b.dose.value[i]) return false;
    }
    if (a.dose.unit !== b.dose.unit) return false;
  } else {
    const totalA = (a.dose.total != null ? a.dose.total : a.dose.value);
    const totalB = (b.dose.total != null ? b.dose.total : b.dose.value);
    if (totalA !== totalB || a.dose.unit !== b.dose.unit) return false;
  }

  // 3) route
  if (a.route !== b.route) return false;

    /// 4) frequency  — treat “daily”, “q24h”, and blank as the same
	const canonFreq = f => {
 	 f = (f || '').toLowerCase().trim();
 	 return (f === '' || f === 'daily' || f === 'q24h') ? 'daily' : f;
	};

	const fA = canonFreq(a.frequency);
	const fB = canonFreq(b.frequency);

	// exact “qNh” forms (q4h, q6h, …) must match numerically
	const qA = fA.match(/^q(\d+)h$/);
	const qB = fB.match(/^q(\d+)h$/);

	if (qA && qB) {
  	if (+qA[1] !== +qB[1]) return false;
	} else if (fA !== fB) {
  	// fall back to fuzzy text similarity for phrases like “twice daily”
  	const freqSim = similarity(fA, fB);
  	if (freqSim < 0.85) return false;
}

  // ─── normalize time-of-day equivalence ───
const normalizeTOD = t => {
  if (!t) return '';
  t = t.toLowerCase().trim(); // Added .trim()
  if (t === 'morning' || t === 'qam' || t === 'am' || t.includes('in morning') || t.includes('in the am')) return 'morning';
  if (t === 'evening' || t === 'pm' || t.includes('in evening') || t.includes('in the pm')) return 'evening';
  if (t === 'bedtime' || t === 'night' || t === 'qhs' || t.includes('at bedtime')) return 'bedtime';
  return t;
};

  if (normalizeTOD(a.timeOfDay) !== normalizeTOD(b.timeOfDay)) {
    return false;
  }
  // ────────────────────────────────────────────

  // 5) dosage form must match …
  if ((a.form || '') !== (b.form || '')) return false;
  // 6) PRN flag …
  if (a.prn !== b.prn) return false;


// ——— ENSURE PAIN INDICATION MATCHES ———
if ((a.indication || b.indication) && a.indication !== b.indication) {
  return false;
}
// ——————————————————————————————

  // 7) quantity per dose
  const qtyA = a.qty ?? 1;
  const qtyB = b.qty ?? 1;
  if (qtyA !== qtyB) return false;

  return true;
}

    function compareOrders(list1, list2) {
      let unchanged = [];
      let removed = [];
      let added = [];
      let matched2 = new Array(list2.length).fill(false);
      for (let orderObj1 of list1) {
        let found = false;
        for (let i = 0; i < list2.length; i++) {
          if (!matched2[i] && ordersAreEqual(orderObj1.parsed, list2[i].parsed)) {
            matched2[i] = true;
            unchanged.push({             //  ← NEW: remember BOTH originals
                              orig: orderObj1,           //     from the facility list
                              new : list2[i]             //     from the hospital list
                              });
            found = true;
            break;
          }
        }
        if (!found) removed.push(orderObj1);
      }
      for (let i = 0; i < list2.length; i++) {
        if (!matched2[i]) added.push(list2[i]);
      }
//=== STEP‑MERGESAME  ⬇︎ stop double‑counting identical meds =============
for (let i = removed.length - 1; i >= 0; i--) {
  const r = removed[i];
  const j = added.findIndex(a => ordersAreEqual(r.parsed, a.parsed));
  if (j !== -1) {
    unchanged.push({ orig: r, new: added[j] });
    removed.splice(i, 1);          // pull it from “removed”
    added.splice(j, 1);            // pull it from “added”
  }
}
//=== END STEP‑MERGESAME ===============================================

      return { unchanged, removed, added };
    }

    function isCriticalOrder(orderObj) {
      const text = orderObj.original.toLowerCase();
      return criticalMeds.some(med => text.includes(med));
    }

    function showScreen(screenId) {
      document.getElementById('error-message').textContent = '';
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      updateProgress(screenId);
    }

    function updateProgress(screenId) {
        // reset steps & lines
  ['step1','step2','step3','step4'].forEach(id=>{
    document.getElementById(id).classList.remove('filled','current');
  });
  ['line1-2','line2-3','line3-4'].forEach(id=>{
    document.getElementById(id).classList.remove('filled');
  });


      if (screenId === 'disclaimer-screen') {
        document.getElementById('step1').classList.add('current');
      } else if (screenId === 'photo1-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('current');
        document.getElementById('line1-2').classList.add('filled');
      } else if (screenId === 'photo2-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('current');
        document.getElementById('line1-2').classList.add('filled');
        document.getElementById('line2-3').classList.add('filled');
      } else if (screenId === 'results-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
        document.getElementById('step4').classList.add('filled');
        document.getElementById('line1-2').classList.add('filled');
        document.getElementById('line2-3').classList.add('filled');
        document.getElementById('line3-4').classList.add('filled');
      }
    }

    function showLoading(msg) {
      const ld = document.getElementById('loading'),
            lt = document.getElementById('loading-text');
      ld.style.display = 'flex';
      lt.textContent = msg;
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
    }

    function acknowledgeDisclaimer() {
      showScreen('photo1-screen');
    }

    function handlePhoto1(files) {
      if (!files || files.length === 0) return;
      photo1Files = photo1Files.concat(Array.from(files));
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto1UI();
    }

    function handleAdditionalPhoto1(files) {
      if (!files || files.length === 0) return;
      photo1Files = photo1Files.concat(Array.from(files));
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto1UI();
      document.getElementById('photo1-capture2').value = "";
      document.getElementById('photo1-upload2').value = "";
    }

    function updatePhoto1UI() {
  // 1) grab the “You can take a photo…” paragraph
  const instr1 = document.querySelector('#photo1-screen .upload-instructions');
  // 2) hide it as soon as you've added ≥1 photo OR used the text‐paste path
  instr1.style.display = (photo1Files.length > 0 || hasTextInput1)
    ? 'none'
    : 'block';

  // Update count & Next-button state:
  document.getElementById('photo1-status').textContent =
    photo1Files.length + (photo1Files.length === 1
      ? " photo added."
      : " photos added.");
  document.getElementById('photo1-next').disabled =
    photo1Files.length === 0;

  // Refresh thumbnails:
  updatePreview('photo1-preview', photo1Files, 1);

  if (photo1Files.length > 0) {
    // Show prompt with **Next** bold:
    const prompt1 = document.getElementById('photo1-prompt');
    prompt1.style.display = 'block';
    prompt1.innerHTML =
      `Photo ${photo1Files.length} of 5 added. ` +
      `Add another photo (up to 5) to complete your list, or click ` +
      `<strong>Next</strong> to continue.`;

    // Swap out buttons:
    document.getElementById('initial-photo1-options').style.display = 'none';
    document.getElementById('additional-photo1-option').style.display = 'flex';
  } else {
    // No photos → back to start
    document.getElementById('photo1-prompt').style.display = 'none';
    document.getElementById('initial-photo1-options').style.display = 'flex';
    document.getElementById('additional-photo1-option').style.display = 'none';
  }

  // Clear file inputs so you can re-select the same file if needed:
  document.getElementById('photo1-capture').value = "";
  document.getElementById('photo1-upload').value = "";
}



    function handlePhoto2(files) {
      if (!files || files.length === 0) return;
      photo2Files = photo2Files.concat(Array.from(files));
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto2UI();
    }

    function handleAdditionalPhoto2(files) {
      if (!files || files.length === 0) return;
      photo2Files = photo2Files.concat(Array.from(files));
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto2UI();
      document.getElementById('photo2-capture2').value = "";
      document.getElementById('photo2-upload2').value = "";
    }

    function updatePhoto2UI() {
    // 1) grab the “You can take a photo…” paragraph on screen 2
  const instr2 = document.querySelector('#photo2-screen .upload-instructions');
  // 2) hide it as soon as you've added ≥1 photo OR used the paste path
  instr2.style.display = (photo2Files.length > 0 || hasTextInput2)
    ? 'none'
    : 'block';

  // Update count & Compare-button state:
  document.getElementById('photo2-status').textContent =
    photo2Files.length + (photo2Files.length === 1
      ? " photo added."
      : " photos added.");
  document.getElementById('photo2-compare').disabled =
    photo2Files.length === 0;

  // Refresh thumbnails:
  updatePreview('photo2-preview', photo2Files, 2);

  if (photo2Files.length > 0) {
    // Show prompt with **Compare** bold:
    const prompt2 = document.getElementById('photo2-prompt');
    prompt2.style.display = 'block';
    prompt2.innerHTML =
      `Photo ${photo2Files.length} of 5 added. ` +
      `Add another photo (up to 5) to complete your list, or click ` +
      `<strong>Compare</strong> to continue.`;

    // Swap out buttons:
    document.getElementById('initial-photo2-options').style.display = 'none';
    document.getElementById('additional-photo2-option').style.display = 'flex';
  } else {
    // No photos → back to start
    document.getElementById('photo2-prompt').style.display = 'none';
    document.getElementById('initial-photo2-options').style.display = 'flex';
    document.getElementById('additional-photo2-option').style.display = 'none';
  }

  // Clear file inputs
  document.getElementById('photo2-capture').value = "";
  document.getElementById('photo2-upload').value = "";
}

    function updatePreview(previewId, files, listNumber) {
      const container = document.getElementById(previewId);
      container.innerHTML = "";
      files.forEach((file, index) => {
        const thumbnailDiv = document.createElement('div');
        thumbnailDiv.className = 'thumbnail-container';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '<span class="material-icons">close</span>';
        deleteBtn.onclick = () => deletePhoto(listNumber, index);
        thumbnailDiv.appendChild(img);
        thumbnailDiv.appendChild(deleteBtn);
        container.appendChild(thumbnailDiv);
      });
    }

    function deletePhoto(listNumber, index) {
      if (listNumber === 1) {
        photo1Files.splice(index, 1);
        updatePhoto1UI();
      } else if (listNumber === 2) {
        photo2Files.splice(index, 1);
        updatePhoto2UI();
      }
    }

    function handleTextInput1() {
      const text = document.getElementById('photo1-text-input').value.trim();
      if (!text) {
        showError('Please paste a medication list before submitting.');
        return;
      }
      // Clear any old status
      document.getElementById('photo1-status').textContent = 'List pasted.';
      hasTextInput1 = true;
      let lines = text.split(/\r?\n+/).map(line => cleanLine(line));
	lines = mergeMultiLineOrders(lines);
	lines = mergeTaperPackOrders(lines);
	// prune off any trailing non-order text
	// lines = lines.map(line => pruneLine(line));
	lines = lines.filter(line => 
		isLikelyOrderLine(line) && containsKnownMedication(line)
		);


      console.log('Raw lines after filtering:', lines); // Debug log
      lines = [...new Set(lines)];
      if (lines.length === 0) {
        showError('No valid medication orders detected in the pasted list. Please try again.');
        return;
      }
      meds1 = lines.map(med => {
        try {
          const parsed = parseOrder(med);
          if (!parsed || typeof parsed !== 'object') {
            console.warn('Parse failed for:', med, 'returning default object');
            return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
          }
          return { original: med, parsed: parsed };
        } catch (e) {
          console.error('Error parsing line:', med, e.stack || e);
          return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
        }
      });
      console.log('Medications from First List (Text Input):', meds1);
      document.getElementById('photo1-status').textContent = 'Proceeding to second list...';
      document.getElementById('initial-photo1-options').style.display = 'none';
      document.getElementById('additional-photo1-option').style.display = 'none';
      document.getElementById('photo1-prompt').style.display = 'none';
      showError('');
      showScreen('photo2-screen');
    }

    function handleTextInput2() {
      const text = document.getElementById('photo2-text-input').value.trim();
      if (!text) {
        showError('Please paste a medication list before submitting.');
        return;
      }
      // Clear any old status
      document.getElementById('photo2-status').textContent = 'List pasted.';
      hasTextInput2 = true;
          let lines = text.split(/\r?\n+/).map(line => cleanLine(line));
    	lines = mergeMultiLineOrders(lines);
	lines = mergeTaperPackOrders(lines);
	// prune off any trailing non-order text
	// lines = lines.map(line => pruneLine(line));
    	lines = lines.filter(line => 
		isLikelyOrderLine(line) && containsKnownMedication(line)
		);

      console.log('Raw lines after filtering:', lines); // Debug log
      lines = [...new Set(lines)];
      if (lines.length === 0) {
        showError('No valid medication orders detected in the pasted list. Please try again.');
        return;
      }
      meds2 = lines.map(med => {
        try {
          const parsed = parseOrder(med);
          if (!parsed || typeof parsed !== 'object') {
            console.warn('Parse failed for:', med, 'returning default object');
            return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
          }
          return { original: med, parsed: parsed };
        } catch (e) {
          console.error('Error parsing line:', med, e.stack || e);
          return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
        }
      });
      console.log('Medications from Second List (Text Input):', meds2);
      document.getElementById('photo2-compare').disabled = false;
      document.getElementById('initial-photo2-options').style.display = 'none';
      document.getElementById('additional-photo2-option').style.display = 'flex';
      document.getElementById('photo2-prompt').style.display = 'block';
      document.getElementById('photo2-prompt').textContent = 'You may add a photo or click Compare to continue.';
      showError('');
    }

    async function goToPhoto2() {
      if (!hasTextInput1 && (!photo1Files || photo1Files.length === 0)) {
        showError('Please select at least one photo or submit a medication list.');
        return;
      }
      if (!hasTextInput1) {
        showLoading('Processing first image(s)...');
        try {
          let combinedText = await processFiles(photo1Files);
                      let lines = combinedText.split(/\r?\n+/).map(line => cleanLine(line));
      		lines = mergeMultiLineOrders(lines);
		lines = mergeTaperPackOrders(lines);
		// prune off any trailing non-order text
		// lines = lines.map(line => pruneLine(line));
//=== STEP 4  removed – keepOrderLines already filtered


          console.log('Raw lines from OCR:', lines); // Debug log
          lines = [...new Set(lines)];
          if (lines.length === 0) {
            hideLoading();
            showError('No valid medication orders detected in the first photos. Please try again.');
            return;
          }
          meds1 = lines.map(med => {
            try {
              const parsed = parseOrder(med);
              if (!parsed || typeof parsed !== 'object') {
                console.warn('Parse failed for:', med, 'returning default object');
                return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
              }
              return { original: med, parsed: parsed };
            } catch (e) {
              console.error('Error parsing line:', med, e.stack || e);
              return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
            }
          });
          console.log('Medications from First List:', meds1);
          hideLoading();
          showScreen('photo2-screen');
        } catch (err) {
          console.error('OCR Error:', err);
          hideLoading();
          showError('Error extracting text from the first photos. Please try again.');
        }
      }
    }

    async function comparePhotos() {
      if (!hasTextInput2 && (!photo2Files || photo2Files.length === 0)) {
        showError('Please select at least one photo or submit a medication list.');
        return;
      }
      if (!hasTextInput2) {
        showLoading('Processing second image(s)...');
        try {
          let combinedText = await processFiles(photo2Files);
                let lines = combinedText.split(/\r?\n+/).map(line => cleanLine(line));
      		lines = mergeMultiLineOrders(lines);
		lines = mergeTaperPackOrders(lines);
		// prune off any trailing non-order text
		// lines = lines.map(line => pruneLine(line));
//=== STEP 4  removed – keepOrderLines already filtered

          console.log('Raw lines from OCR:', lines); // Debug log
          lines = [...new Set(lines)];
          if (lines.length === 0) {
            hideLoading();
            showError('No valid medication orders detected in the second photos. Please try again.');
            return;
          }
          meds2 = lines.map(med => {
            try {
              const parsed = parseOrder(med);
              if (!parsed || typeof parsed !== 'object') {
                console.warn('Parse failed for:', med, 'returning default object');
                return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
              }
              return { original: med, parsed: parsed };
            } catch (e) {
              console.error('Error parsing line:', med, e.stack || e);
              return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
            }
          });
          console.log('Medications from Second List:', meds2);
          hideLoading();
          compareAndShowResults();
        } catch (err) {
          console.error('OCR Error:', err);
          hideLoading();
          showError('Error extracting text from the second photos. Please try again.');
        }
      } else {
        compareAndShowResults();
      }
    }

// === CORE‑DRUG helper (global) ===
const coreDrugName = n => (n || '')
  .toLowerCase()

  /* 1️⃣  salts / formulations */
  .replace(/\b(?:sodium|potassium|calcium|acetate|phosphate|carbonate|hydrochloride|succinate|tartrate|gluconate|chloride|anhydrous|choline|modified)\b/gi, '')

  /* 2️⃣  dosage‑form words (NEW) */
  .replace(/\b(?:tab|tabs?|tablet|tablets?|cap|caps?|capsule|capsules?|caplet|patch|patches|puff|puffs|drop|drops|spray|sprays|lozenge|suppository|solution|suspension|ointment|cream|gel|inhaler|inhalation|neb|mdi|dpi)\b/gi, '')

  /* 3️⃣  throw away scheduling words that sometimes stick to the drug   */
  .replace(/\b(?:daily|nightly|morning|evening|bedtime|qam|qpm|qhs|am|pm|q\d+h)\b/gi, '')
  
/* 3️⃣  stray numbers */
  .replace(/\b\d+\b/g, '')

  /* 4️⃣  punctuation / extra spaces */
  .replace(/[^a-z0-9\s/-]+/g, ' ')
  .replace(/\s+/g, ' ')
  .trim();

function compareAndShowResults() {
    let { unchanged, removed, added } = compareOrders(meds1, meds2);
        
//=== STEP-MERGE-REMOVED-ADDED (enhanced) ======================
const merged = [];
const addedMap = Object.create(null);

// --- START DEBUG LOGS FOR addedMap POPULATION ---
console.log("--- Building addedMap (Primary Merge Step) ---");
added.forEach(a => {
  const originalDrugString = a.original; // For logging
  const parsedDrugField = a.parsed.drug;
   const normalizedKeyForMap =
   coreDrugName(parsedDrugField)                     // base generic
     .replace(/\b(inhaler|inhalation|neb|mdi|dpi)\b/gi, '') // strip route words
     .trim();
  console.log(`  [addedMap]: Adding: Original Str: "${originalDrugString}" --> Parsed Drug: "${parsedDrugField}" --> Normalized Key: "${normalizedKeyForMap}"`);
  addedMap[normalizedKeyForMap] = a; 
});
console.log("--- Finished building addedMap. Keys: ", Object.keys(addedMap));
// --- END DEBUG LOGS FOR addedMap POPULATION ---

// --- START DEBUG LOGS FOR removed.filter (Primary Merge Step) ---
console.log("--- Filtering 'removed' list (Primary Merge Step) ---");
removed = removed.filter(r => {
  const originalRemovedDrugString = r.original; // For logging
  const parsedRemovedDrugField = r.parsed.drug;
  const lookupKey =
   coreDrugName(parsedRemovedDrugField)
     .replace(/\b(inhaler|inhalation|neb|mdi|dpi)\b/gi, '')
     .trim();
  console.log(`  [removed.filter]: Processing Removed: Original Str: "${originalRemovedDrugString}" --> Parsed Drug: "${parsedRemovedDrugField}" --> Lookup Key: "${lookupKey}"`);
  
  const match = addedMap[lookupKey];
  
  if (!match) {
    console.log(`    NO MATCH found in addedMap for key: "${lookupKey}". Item "${originalRemovedDrugString}" remains in 'removed' list for now.`);
    return true; // Keep in 'removed' list if no match
  } else {
    console.log(`    MATCH FOUND for key: "${lookupKey}" (Matches added item: "${match.original}"). Merging.`);
    const reason = getChangeReason(r.parsed, match.parsed);
    merged.push({ orig: r, new: match, reason: reason });
    delete addedMap[lookupKey]; // Remove from map as it's now matched
    return false; // Remove from 'removed' list as it's merged
  }
});
console.log("--- Finished filtering 'removed' list ---");
// --- END DEBUG LOGS FOR removed.filter ---

added = Object.values(addedMap); // Update 'added' to only those not merged
//=== END STEP-MERGE-REMOVED-ADDED ==============================


//=== STEP‑FIX  skip any blank or junk entries =========================
const notBlank = obj =>
  obj && obj.original && obj.original.trim().length > 0;

unchanged = unchanged.filter(pair => notBlank(pair.orig) && notBlank(pair.new));
removed   = removed  .filter(notBlank);
added     = added    .filter(notBlank);
//=== END STEP‑FIX ======================================================

// ---------------------------------------------
//  CI scan **only** on the ACTIVE (hospital) list
// ---------------------------------------------
const activeOrders =
      meds2
      .concat( unchanged.map(p => p.new) );

const ciAlerts = findContraIndications(activeOrders);

/* build a highlight-set containing BOTH
   the raw names *and* their stripped cores */
const ciSet = new Set(
  ciAlerts.flatMap(w => {
    return [
      w.a,              // e.g. "simvastatin"
      w.b,              // e.g. "ketoconazole"
      coreDrugName(w.a),// e.g. "simvastatin"
      coreDrugName(w.b) // e.g. "ketoconazole"
    ];
  })
);


// ---------------------------------------------

    // Build a numbered, four-column table of changes
    let html = `
        <table class="changes-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Original Order (Facility)</th>
                    <th>New Order (Hospital)</th>
                    <th>Suspected Change</th>
                </tr>
            </thead>
            <tbody>
    `;

    let idx = 1;

    // Process removed orders (potential changes or removals)

// ‑‑‑ FIRST: show the neatly‑merged pairs ‑‑‑
merged.forEach(pair => {
  const crit = isCriticalOrder(pair.new);
    html += `
    <tr class="
          ${crit ? 'critical' : ''}
          ${ciSet.has(coreDrugName(pair.orig.parsed.drug)) ||
              ciSet.has(coreDrugName(pair.new.parsed.drug))
            ? 'ci-row' : ''}">
      <td>${idx++}</td>
      <td>${pair.orig.original}</td>
      <td>${pair.new.original}</td>
      <td>${pair.reason}</td>
    </tr>`;

});
    
removed.forEach(r => {
        console.group(`🔍 Comparing removed: ${r.original}`);
        console.log('   current added[]:', added.map(a => a.original));
        const lowerRem = r.original.toLowerCase();
        let match = null;
        let changeType = null;

        // 1) Brand → generic?
        const brandKey = Object.keys(brandToGenericMap).find(b => lowerRem.includes(b));
        if (brandKey) {
            changeType = 'Generic Medication';
            const gen = brandToGenericMap[brandKey];
            match = added.find(a => normalizeMedicationName(a.parsed.drug) === gen);
        }

        // 2) Generic → brand?
        if (!match) {
            const genKey = normalizeMedicationName(r.parsed.drug);
            const brandList = genericToBrandMap[genKey] || [];
            for (let brand of brandList) {
                const regex = new RegExp(`\\b${brand}\\b`, 'i');
                const found = added.find(a => regex.test(a.original));
                if (found) {
                    changeType = 'Brand Medication';
                    match = found;
                    break;
                }
            }
        }

        // 3) Substring match (fallback, less precise)
        if (!match) {
            const drugName = r.parsed.drug.toLowerCase();
            match = added.find(a => a.original.toLowerCase().includes(drugName));
            if (match) {
                changeType = getChangeReason(r.parsed, match.parsed);
    	// very novice-friendly override for “only indication” cases
   	 const origInd = (r.parsed.indication || '').toLowerCase().trim();
   	 const newInd  = (match.parsed.indication || '').toLowerCase().trim();
   	 if (
     	 normalizeMedicationName(r.parsed.drug) === normalizeMedicationName(match.parsed.drug)
      	&& r.parsed.dose.value === match.parsed.dose.value
      	&& r.parsed.dose.unit  === match.parsed.dose.unit
     	 && origInd !== newInd
    	) {
      	changeType = 'Indication changed';
    	}
                console.log(`   → substring matched "${drugName}" to`, match.original);
            }
        }

        const crit = false;         // removed orders aren’t active any more

           // 4) Brand ↔ generic swap (also catch an indication tweak)
   if (match && (changeType === 'Generic Medication' || changeType === 'Brand Medication')) {
     // build a list of reasons
     const reasons = [ changeType ];
     if ((r.parsed.indication || '').toLowerCase().trim()
       !== (match.parsed.indication || '').toLowerCase().trim()) {
       reasons.push('Indication changed');
     }
            html += `
            <tr class="
                  ${crit ? 'critical' : ''}
                  ${ciSet.has(coreDrugName(r.parsed.drug)) ||
                     (match && ciSet.has(coreDrugName(match.parsed.drug)))
                    ? 'ci-row' : ''}">
         <td>${idx++}</td>
         <td>${r.original}</td>
         <td>${match.original}</td>
         <td>${reasons.join(', ')}</td>
       </tr>
     `;
     added = added.filter(a => a !== match);
     console.groupEnd();
     return;
   }

        // 5) Dose / freq / form / route / PRN / admin reasons
        if (match) {
            // Use getChangeReason to determine the specific change
            const reason = getChangeReason(r.parsed, match.parsed);
            html += `
                <tr class="${crit ? 'critical' : ''}">
                    <td>${idx++}</td>
                    <td>${r.original}</td>
                    <td>${match.original}</td>
                    <td>${reason}</td>
                </tr>
            `;
            added = added.filter(a => a !== match);
            console.groupEnd();
            return;
        }

        // 6) Same-drug match
        const sameDrug = added.find(a =>
            normalizeMedicationName(a.parsed.drug) === normalizeMedicationName(r.parsed.drug)
        );
        if (sameDrug) {
            const reason = getChangeReason(r.parsed, sameDrug.parsed);
            html += `
                <tr class="${crit ? 'critical' : ''}">
                    <td>${idx++}</td>
                    <td>${r.original}</td>
                    <td>${sameDrug.original}</td>
                    <td>${reason}</td>
                </tr>
            `;
            added = added.filter(a => a !== sameDrug);
            console.groupEnd();
            return;
        }

        // 7) Pure removal
        html += `
            <tr class="${crit ? 'critical' : ''}">
                <td>${idx++}</td>
                <td>${r.original}</td>
                <td></td>
                <td>Removed</td>
            </tr>
        `;
        console.groupEnd();
    });

    // Unchanged ‑‑→ now re‑evaluate for brand/generic etc.
    unchanged.forEach(u => {
       const reason = getChangeReason(u.orig.parsed, u.new.parsed);
       const label  = (reason === 'Misc. Change') ? 'Unchanged' : reason;

            html += `
    <tr class="
          ${(label !== 'Unchanged' && (isCriticalOrder(u.orig)||isCriticalOrder(u.new))) ? 'critical' : ''}
          ${ciSet.has(coreDrugName(u.orig.parsed.drug)) ||
              ciSet.has(coreDrugName(u.new.parsed.drug))
            ? 'ci-row' : ''}">
                <td>${idx++}</td>
                 <td>${u.orig.original}</td>
                 <td>${u.new.original}</td>
                 <td>${label}</td>
             </tr>
        `;
      });


        // Added orders
    added.forEach(a => {
      const crit = isCriticalOrder(a);
      html += `
        <tr class="${crit ? 'critical' : ''} ${ciSet.has(coreDrugName(a.parsed.drug)) ? 'ci-row' : ''}">
          <td>${idx++}</td>
          <td></td>
          <td>${a.original}</td>
          <td>Added</td>
        </tr>
      `;
    });

    html += `
            </tbody>
        </table>
    `;

    // ─── Append CI block below the table ───
    if (ciAlerts.length) {
      html += `
        <h3 style="margin-top:1.5rem; color: red; font-weight: bold;">
      Potential Contraindications
    </h3>
        <ul>
          ${ciAlerts.map(w =>
            `<li><strong>${w.a}</strong> should NOT be used with <strong>${w.b}</strong></li>`
          ).join('')}
        </ul>
        <p style="font-size:0.85rem;">
          These flags are a quick screen and do <em>not</em> replace clinical judgement.
        </p>
      `;
    }


    document.getElementById('results-content').innerHTML = html;
   
 // make the current CI list available for exportToPDF()
    window.currentContraAlerts = ciAlerts;

    showScreen('results-screen');
}

    async function exportToPDF() {
  // 1) grab your table
  const table = document.querySelector('.changes-table');
  // 2) init jsPDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

  // 3) optional: add a title
  pdf.setFontSize(14);
  pdf.text('Comparison Results', 40, 40);

  // 4) render the table with AutoTable
  pdf.autoTable({
    html: table,
    startY: 60,
    theme: 'grid',
    headStyles: { fillColor: [240,240,240] },
    styles: {
      fontSize: 9,
      cellPadding: 4,
      overflow: 'linebreak'
    },
    // ensure no row ever splits across pages:
    pageBreak: 'avoid',
    didDrawPage: (data) => {
      // here you could add page numbers, headers, etc.
    }
  });

  // ——— Draw the CI header & list below the table ———
  const finalY = pdf.lastAutoTable.finalY + 20;
  if (window.currentContraAlerts?.length) {
    // 1) Section title
    pdf.setFontSize(12);
    pdf.text("Potential Contra-Indications", 40, finalY);

    // 2) Each warning item
    pdf.setFontSize(10);
    window.currentContraAlerts.forEach((w, i) => {
      pdf.text(
        `• ${w.a} should NOT be used with ${w.b}`,
        40,
        finalY + 15 + i * 12
      );
    });

    // 3) Footnote
    pdf.setFontSize(9);
    pdf.text(
      "These flags are a quick screen and do not replace clinical judgement.",
      40,
      finalY + 15 + window.currentContraAlerts.length * 12 + 10
    );
  }

  // 5) save the PDF
  pdf.save('MedRec_Report.pdf');
}


function printResults() {
  // 1) make sure we’re on the results screen
  showScreen('results-screen');

  // 2) give the browser a moment to apply your @media print CSS
  setTimeout(() => {
    window.print();
  }, 100);
}

    function startOver() {
      photo1Files = [];
      photo2Files = [];
      meds1 = [];
      meds2 = [];
      hasTextInput1 = false;
      hasTextInput2 = false;
      document.getElementById('photo1-capture').value = '';
      document.getElementById('photo1-upload').value = '';
      document.getElementById('photo1-capture2').value = '';
      document.getElementById('photo1-upload2').value = '';
      document.getElementById('photo2-capture').value = '';
      document.getElementById('photo2-upload').value = '';
      document.getElementById('photo2-capture2').value = '';
      document.getElementById('photo2-upload2').value = '';
      document.getElementById('photo1-text-input').value = '';
      document.getElementById('photo2-text-input').value = '';
      document.getElementById('photo1-status').textContent = '';
      document.getElementById('photo2-status').textContent = '';
      document.getElementById('photo1-next').disabled = true;
      document.getElementById('photo2-compare').disabled = true;
      document.getElementById('results-content').innerHTML = '';
      document.getElementById('photo1-preview').innerHTML = "";
      document.getElementById('photo2-preview').innerHTML = "";
      document.getElementById('photo1-prompt').style.display = 'none';
      document.getElementById('initial-photo1-options').style.display = 'flex';
      document.getElementById('additional-photo1-option').style.display = 'none';
      document.getElementById('photo2-prompt').style.display = 'none';
      document.getElementById('initial-photo2-options').style.display = 'flex';
      document.getElementById('additional-photo2-option').style.display = 'none';
      showScreen('disclaimer-screen');
    }

    // Tooltip toggle for mobile
    document.querySelectorAll('.tooltip').forEach(tooltip => {
      tooltip.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = tooltip.classList.contains('active');
        document.querySelectorAll('.tooltip').forEach(t => t.classList.remove('active'));
        if (!isActive) {
          tooltip.classList.add('active');
        }
      });
    });

    document.addEventListener('click', () => {
      document.querySelectorAll('.tooltip').forEach(tooltip => {
        tooltip.classList.remove('active');
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      hideLoading();
      updateProgress('disclaimer-screen');
    });
  </script>

</body>
</html>
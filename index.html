<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedRec 2.0</title>
  <style>
    /* Basic Layout */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .screen {
      display: none;
      width: 100%;
      text-align: center;
    }
    .screen.active {
      display: block;
    }
    /* Card Styling */
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
      padding: 1rem;
      margin: 0.5rem 0;
      width: 100%;
      box-sizing: border-box;
    }
    /* Buttons & Inputs */
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      border-radius: 15px;
      width: 100%;
      max-width: 300px;
      display: block;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.2s ease;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    /* Hide native file inputs */
    input[type="file"] {
      display: none;
    }
    .photo-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin: 1rem 0;
      width: 100%;
    }
    .photo-actions button {
      width: 100%;
      max-width: 300px;
      margin: 0;
    }
    .disclaimer-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1rem 0;
      width: 100%;
    }
    .disclaimer-actions button {
      width: 100%;
      max-width: 300px;
    }
    .upload-instructions {
      font-size: 0.9rem;
      margin: 0.5rem 1rem;
      color: #555;
    }
    .upload-prompt {
      font-size: 0.9rem;
      margin: 0.5rem 1rem;
      color: #333;
    }
    .preview-container {
      text-align: center;
      margin: 0.5rem 0 1rem;
    }
    .preview-container img {
      width: 80px;
      height: auto;
      margin: 0.25rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #error-message {
      color: red;
      text-align: center;
      margin: 1rem 0;
    }
    .critical {
      color: red;
      font-weight: bold;
    }
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
      position: relative;
    }
    .progress-step {
      width: 30px;
      height: 30px;
      background-color: #cccccc;
      border: 1px solid #999;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: all 0.3s ease;
    }
    .progress-step.filled {
      background-color: #66b0ff;
      border: 1px solid #0056b3;
      color: white;
    }
    .progress-step.current {
      background-color: #007bff;
      border: 3px solid #0056b3;
      color: white;
    }
    .progress-line-container {
      position: absolute;
      top: 50%;
      left: 15px;
      right: 15px;
      height: 2px;
      z-index: 0;
      display: flex;
      justify-content: space-between;
    }
    .progress-line {
      flex: 1;
      height: 2px;
      background-color: #cccccc;
      margin: 0 5px;
    }
    .progress-line.filled {
      background-color: #66b0ff;
    }
    #loading {
      display: none;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.5rem;
      text-align: center;
      z-index: 2000;
    }
    #loading-text {
      margin-bottom: 0.25rem;
    }
    #loading-progress {
      width: 80%;
      max-width: 300px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin: 0.5rem 0;
    }
    h3 {
      margin-top: 1rem;
    }
    p.disclaimer-text {
      text-align: justify;
      max-width: 500px;
      margin: 0 auto;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
      color: #007bff;
      margin-left: 5px;
      font-size: 0.9rem;
    }
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: white;
      text-align: center;
      border-radius: 5px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltip-text,
    .tooltip.active .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1>MedRec 2.0</h1>
    <div class="progress-bar">
      <div class="progress-line-container">
        <div class="progress-line" id="line1-2"></div>
        <div class="progress-line" id="line2-3"></div>
        <div class="progress-line" id="line3-4"></div>
      </div>
      <div class="progress-step" id="step1">1</div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-step" id="step3">3</div>
      <div class="progress-step" id="step4">4</div>
    </div>
  </header>
  <main>
    <div id="error-message"></div>
    <!-- Disclaimer Screen -->
    <div id="disclaimer-screen" class="screen active">
      <h2>Disclaimer</h2>
      <div class="card">
        <p class="disclaimer-text">
          ***HIPAA Warning***: DO NOT UPLOAD IMAGES CONTAINING IDENTIFIABLE INFORMATION. This app is intended for use by personnel authorized to handle Protected Health Information (PHI). Users are responsible for ensuring compliance with HIPAA regulations, including safeguarding resident/patient data and restricting access to authorized personnel only. Unauthorized disclosure of PHI may result in disciplinary action and legal consequences.
        </p>
      </div>
      <div class="disclaimer-actions">
        <button onclick="acknowledgeDisclaimer()">I Understand</button>
      </div>
    </div>
    <!-- Photo 1 Screen -->
    <div id="photo1-screen" class="screen">
      <div class="card">
        <h2>
          Take or Upload First Photo(s)
          <span class="tooltip" id="tooltip1">
            (?)
            <span class="tooltip-text">Tip: Crop out anything not part of the medication list</span>
          </span>
        </h2>
        <p class="upload-instructions">For best results, please take a clear photo of the medication list text only. Avoid excessive background, unrelated papers, or images.</p>
        <div id="initial-photo1-options" class="photo-actions">
          <button onclick="document.getElementById('photo1-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo1-upload').click()">Upload Photo</button>
        </div>
        <div id="additional-photo1-option" class="photo-actions" style="display: none;">
          <button onclick="document.getElementById('photo1-capture2').click()">Take Another Photo</button>
          <button onclick="document.getElementById('photo1-upload2').click()">Upload Another Photo</button>
        </div>
      </div>
      <input type="file" id="photo1-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto1(this.files)">
      <input type="file" id="photo1-upload" accept="image/*" multiple onchange="handlePhoto1(this.files)">
      <input type="file" id="photo1-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto1(this.files)">
      <input type="file" id="photo1-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto1(this.files)">
      <div id="photo1-preview" class="preview-container"></div>
      <p id="photo1-status">No photo added.</p>
      <p id="photo1-prompt" class="upload-prompt" style="display: none;">You may add another photo or click Next to continue.</p>
      <div class="photo-actions">
        <button id="photo1-next" onclick="goToPhoto2()" disabled>Next</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Photo 2 Screen -->
    <div id="photo2-screen" class="screen">
      <div class="card">
        <h2>
          Take or Upload Second Photo(s)
          <span class="tooltip" id="tooltip2">
            (?)
            <span class="tooltip-text">Tip: Crop out anything not part of the medication list</span>
          </span>
        </h2>
        <p class="upload-instructions">For best results, please take a clear photo of the medication list text only. Avoid excessive background, unrelated papers, or images.</p>
        <div id="initial-photo2-options" class="photo-actions">
          <button onclick="document.getElementById('photo2-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo2-upload').click()">Upload Photo</button>
        </div>
        <div id="additional-photo2-option" class="photo-actions" style="display: none;">
          <button onclick="document.getElementById('photo2-capture2').click()">Take Another Photo</button>
          <button onclick="document.getElementById('photo2-upload2').click()">Upload Another Photo</button>
        </div>
      </div>
      <input type="file" id="photo2-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto2(this.files)">
      <input type="file" id="photo2-upload" accept="image/*" multiple onchange="handlePhoto2(this.files)">
      <input type="file" id="photo2-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto2(this.files)">
      <input type="file" id="photo2-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto2(this.files)">
      <div id="photo2-preview" class="preview-container"></div>
      <p id="photo2-status">No photo added.</p>
      <p id="photo2-prompt" class="upload-prompt" style="display: none;">You may add another photo or click Compare to continue.</p>
      <div class="photo-actions">
        <button id="photo2-compare" onclick="comparePhotos()" disabled>Compare</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Results Screen -->
    <div id="results-screen" class="screen">
      <h2>Comparison Results</h2>
      <p>Changes listed in <span class="critical">bold red</span> are critical medications and should be reconciled with the provider within <span class="critical">4 hours</span> of discovery.</p>
      <div class="card">
        <div id="results-content"></div>
      </div>
      <div class="photo-actions">
        <button onclick="exportResults()">Export Results</button>
        <button onclick="printResults()">Print Results</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
  </main>
  <div id="loading">
    <p id="loading-text">Processing...</p>
    <progress id="loading-progress" max="100"></progress>
  </div>
  <script>
    const criticalMeds = [
      'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban', 'heparin', 'enoxaparin',
      'clopidogrel', 'ticagrelor', 'prasugrel', 'insulin regular', 'insulin glargine', 'insulin detemir',
      'insulin lispro', 'insulin aspart', 'insulin degludec', 'glipizide', 'glyburide', 'glimepiride',
      'repaglinide', 'nateglinide', 'metformin', 'morphine', 'hydromorphone', 'oxycodone', 'fentanyl',
      'methadone', 'tramadol', 'codeine', 'buprenorphine', 'phenytoin', 'carbamazepine', 'valproic acid',
      'phenobarbital', 'lamotrigine', 'levetiracetam', 'digoxin', 'amiodarone', 'sotalol', 'diltiazem',
      'verapamil', 'metoprolol', 'atenolol', 'carvedilol', 'furosemide', 'bumetanide', 'torsemide',
      'spironolactone', 'hydrochlorothiazide', 'chlorthalidone', 'potassium chloride', 'magnesium sulfate',
      'calcium gluconate', 'calcium chloride', 'sodium bicarbonate', 'phosphate', 'hydralazine', 'clonidine',
      'isosorbide mononitrate', 'isosorbide dinitrate', 'nitroglycerin', 'haloperidol', 'risperidone',
      'olanzapine', 'quetiapine', 'aripiprazole', 'ziprasidone', 'lorazepam', 'diazepam', 'clonazepam',
      'temazepam', 'midazolam', 'zolpidem', 'prednisone', 'methylprednisolone', 'dexamethasone',
      'hydrocortisone', 'levothyroxine', 'liothyronine', 'tacrolimus', 'cyclosporine', 'mycophenolate',
      'azathioprine', 'vancomycin', 'gentamicin', 'tobramycin', 'amikacin', 'ciprofloxacin', 'levofloxacin',
      'moxifloxacin', 'azithromycin', 'clarithromycin', 'erythromycin', 'amoxicillin',
      'amoxicillin-clavulanate', 'ceftriaxone', 'cefepime', 'ceftazidime', 'cefdinir', 'cephalexin',
      'piperacillin-tazobactam', 'penicillin vk', 'dicloxacillin', 'nafcillin', 'meropenem', 'ertapenem',
      'imipenem-cilastatin', 'doxycycline', 'minocycline', 'tetracycline', 'linezolid',
      'sulfamethoxazole-trimethoprim', 'nitrofurantoin', 'metronidazole', 'clindamycin', 'fosfomycin',
      'daptomycin', 'tigecycline', 'carbidopa/levodopa', 'entacapone', 'selegiline', 'rasagiline', 'lithium',
      'theophylline', 'clozapine', 'methotrexate', 'allopurinol', 'colchicine', 'tamsulosin', 'finasteride',
      'denosumab', 'zoledronic acid', 'teriparatide', 'alendronate', 'risedronate', 'acetazolamide',
      'bethanechol', 'bethanechol chloride', 'donepezil', 'rivastigmine', 'galantamine', 'memantine',
      'naltrexone', 'naloxone', 'flumazenil', 'desmopressin', 'octreotide', 'erythropoietin', 'filgrastim',
      'calcitriol', 'ergocalciferol', 'cholecalciferol', 'pyridostigmine', 'propranolol', 'labetalol',
      'isosorbide', 'nicardipine', 'nitroprusside', 'ivabradine', 'sacubitril', 'valsartan',
      'atorvastatin', 'rosuvastatin', 'simvastatin'
    ];
    let photo1Files = [];
    let photo2Files = [];
    let meds1 = [], meds2 = [];
    async function processFiles(files) {
      let allText = "";
      let lowConfidence = false;
      for (let file of files) {
        try {
          const result = await processFile(file);
          allText += "\n" + result.text;
          if (result.confidence < 0.8) {
            lowConfidence = true;
          }
        } catch (err) {
          console.error("Error processing file: ", err);
        }
      }
      if (lowConfidence) {
        showError("Warning: Some text was unclear and may not be accurate. Please review manually.");
      }
      return allText;
    }
    function processFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Image = e.target.result;
          try {
            const response = await fetch('https://us-central1-medrec-ocr.cloudfunctions.net/ocr', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: base64Image })
            });
            const { text, confidence, error } = await response.json();
            if (error) reject(error);
            else if (!text) reject('No text detected');
            else resolve({ text, confidence: confidence || 1.0 });
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject("File could not be read.");
        reader.readAsDataURL(file);
      });
    }
    function cleanLine(line) {
      return line.replace(/[^a-z0-9]+$/i, '').trim();
    }
    function isLikelyOrderLine(line) {
      if (line.length < 3) return false;
      let alphaNumCount = (line.match(/[a-z0-9]/gi) || []).length;
      let ratio = alphaNumCount / line.length;
      return ratio >= 0.4;
    }
    function normalizeText(str) {
      return str.toLowerCase()
        .replace(/p\.?o\.?/g, 'po')
        .replace(/q\.?d\.?/g, 'daily')
        .replace(/b\.?i\.?d\.?/g, 'twice daily')
        .replace(/\s+/g, ' ')
        .replace(/[^\w\s\/-]/g, '')
        .trim();
    }
    function parseOrder(orderStr) {
      orderStr = normalizeText(orderStr);
      let doseMatch = orderStr.match(/(\d+)\s*mg/);
      let dose = doseMatch ? parseInt(doseMatch[1]) : null;
      let route = orderStr.includes("po") ? "po" : "";
      const freqMapping = {
        "every other morning": "every other morning",
        "every other afternoon": "every other afternoon",
        "every other evening": "every other evening",
        "every other night": "every other night",
        "every morning": "every morning",
        "every afternoon": "every afternoon",
        "every evening": "every evening",
        "every night": "every night",
        "once daily": "daily",
        "daily": "daily",
        "qd": "daily",
        "q.d.": "daily",
        "twice daily": "twice daily"
      };
      let frequency = "";
      let freqKeys = Object.keys(freqMapping).sort((a, b) => b.length - a.length);
      for (let key of freqKeys) {
        if (orderStr.includes(key)) {
          frequency = freqMapping[key];
          orderStr = orderStr.replace(key, '');
          break;
        }
      }
      if (doseMatch) {
        orderStr = orderStr.replace(doseMatch[0], '');
      }
      if (route) {
        orderStr = orderStr.replace(/\bpo\b/, '');
      }
      let name = orderStr.trim();
      return { name, dose, route, frequency };
    }
    function levenshteinDistance(a, b) {
      const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
      for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
      for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
      for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
          const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j][i - 1] + 1,
            matrix[j - 1][i] + 1,
            matrix[j - 1][i - 1] + indicator
          );
        }
      }
      return matrix[b.length][a.length];
    }
    function similarity(a, b) {
      const distance = levenshteinDistance(a, b);
      const maxLen = Math.max(a.length, b.length);
      return 1 - distance / maxLen;
    }
    function ordersAreEqual(a, b) {
      if (a.dose !== b.dose) return false;
      if (a.route !== b.route) return false;
      const freqSimilarity = a.frequency && b.frequency ? similarity(a.frequency, b.frequency) : (a.frequency === b.frequency ? 1 : 0);
      if (freqSimilarity < 0.85) return false;
      const nameSimilarity = a.name && b.name ? similarity(a.name, b.name) : (a.name === b.name ? 1 : 0);
      if (nameSimilarity < 0.85) return false;
      return true;
    }
    function compareOrders(list1, list2) {
      let unchanged = [];
      let removed = [];
      let added = [];
      let matched2 = new Array(list2.length).fill(false);
      for (let orderObj1 of list1) {
        let found = false;
        for (let i = 0; i < list2.length; i++) {
          if (!matched2[i] && ordersAreEqual(orderObj1.parsed, list2[i].parsed)) {
            matched2[i] = true;
            unchanged.push(orderObj1);
            found = true;
            break;
          }
        }
        if (!found) removed.push(orderObj1);
      }
      for (let i = 0; i < list2.length; i++) {
        if (!matched2[i]) added.push(list2[i]);
      }
      return { unchanged, removed, added };
    }
    function isCriticalOrder(parsedOrder) {
      if (!parsedOrder.name) return false;
      return criticalMeds.some(med => parsedOrder.name.includes(med));
    }
    function showScreen(screenId) {
      document.getElementById('error-message').textContent = '';
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      updateProgress(screenId);
    }
    function updateProgress(screenId) {
      document.getElementById('step1').classList.remove('filled', 'current');
      document.getElementById('step2').classList.remove('filled', 'current');
      document.getElementById('step3').classList.remove('filled', 'current');
      document.getElementById('step4').classList.remove('filled', 'current');
      document.getElementById('line1-2').classList.remove('filled');
      document.getElementById('line2-3').classList.remove('filled');
      document.getElementById('line3-4').classList.remove('filled');

      if (screenId === 'disclaimer-screen') {
        document.getElementById('step1').classList.add('current');
      } else if (screenId === 'photo1-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('current');
        document.getElementById('line1-2').classList.add('filled');
      } else if (screenId === 'photo2-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('current');
        document.getElementById('line1-2').classList.add('filled');
        document.getElementById('line2-3').classList.add('filled');
      } else if (screenId === 'results-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
        document.getElementById('step4').classList.add('filled');
        document.getElementById('line1-2').classList.add('filled');
        document.getElementById('line2-3').classList.add('filled');
        document.getElementById('line3-4').classList.add('filled');
      }
    }
    function showLoading(msg) {
      const ld = document.getElementById('loading'),
            lt = document.getElementById('loading-text');
      ld.style.display = 'flex';
      lt.textContent = msg;
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
    }
    function acknowledgeDisclaimer() {
      showScreen('photo1-screen');
    }
    function handlePhoto1(files) {
      if (!files || files.length === 0) return;
      photo1Files = photo1Files.concat(Array.from(files));
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo1-status').textContent = photo1Files.length + (photo1Files.length === 1 ? " photo added." : " photos added.");
      document.getElementById('photo1-next').disabled = false;
      updatePreview('photo1-preview', photo1Files);
      document.getElementById('photo1-prompt').style.display = 'block';
      document.getElementById('photo1-prompt').textContent = "You may add another photo or click Next to continue.";
      document.getElementById('initial-photo1-options').style.display = 'none';
      document.getElementById('additional-photo1-option').style.display = 'flex';
      document.getElementById('photo1-capture').value = "";
      document.getElementById('photo1-upload').value = "";
    }
    function handleAdditionalPhoto1(files) {
      if (!files || files.length === 0) return;
      photo1Files = photo1Files.concat(Array.from(files));
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo1-status').textContent = photo1Files.length + (photo1Files.length === 1 ? " photo added." : " photos added.");
      updatePreview('photo1-preview', photo1Files);
      document.getElementById('photo1-capture2').value = "";
      document.getElementById('photo1-upload2').value = "";
    }
    function handlePhoto2(files) {
      if (!files || files.length === 0) return;
      photo2Files = photo2Files.concat(Array.from(files));
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo2-status').textContent = photo2Files.length + (photo2Files.length === 1 ? " photo added." : " photos added.");
      document.getElementById('photo2-compare').disabled = false;
      updatePreview('photo2-preview', photo2Files);
      document.getElementById('initial-photo2-options').style.display = 'none';
      document.getElementById('additional-photo2-option').style.display = 'flex';
      document.getElementById('photo2-prompt').style.display = 'block';
      document.getElementById('photo2-prompt').textContent = "You may add another photo or click Compare to continue.";
      document.getElementById('photo2-capture').value = "";
      document.getElementById('photo2-upload').value = "";
    }
    function handleAdditionalPhoto2(files) {
      if (!files || files.length === 0) return;
      photo2Files = photo2Files.concat(Array.from(files));
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo2-status').textContent = photo2Files.length + (photo2Files.length === 1 ? " photo added." : " photos added.");
      updatePreview('photo2-preview', photo2Files);
      document.getElementById('photo2-capture2').value = "";
      document.getElementById('photo2-upload2').value = "";
    }
    function updatePreview(previewId, files) {
      const container = document.getElementById(previewId);
      container.innerHTML = "";
      files.forEach(file => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        container.appendChild(img);
      });
    }
    async function goToPhoto2() {
      if (!photo1Files || photo1Files.length === 0) {
        showError('Please select at least one photo.');
        return;
      }
      showLoading('Processing first image(s)...');
      try {
        let combinedText = await processFiles(photo1Files);
        let lines = combinedText.split(/[\n,]+/).map(line => cleanLine(line)).filter(isLikelyOrderLine);
        lines = [...new Set(lines)];
        meds1 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
        console.log('Medications from Photo 1:', meds1);
        hideLoading();
        showScreen('photo2-screen');
      } catch (err) {
        console.error('OCR Error:', err);
        hideLoading();
        showError('Error extracting text from the first photos. Please try again.');
      }
    }
    async function comparePhotos() {
      if (!photo2Files || photo2Files.length === 0) {
        showError('Please select at least one photo.');
        return;
      }
      showLoading('Processing second image(s)...');
      try {
        let combinedText = await processFiles(photo2Files);
        let lines = combinedText.split(/[\n,]+/).map(line => cleanLine(line)).filter(isLikelyOrderLine);
        lines = [...new Set(lines)];
        meds2 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
        console.log('Medications from Photo 2:', meds2);
        hideLoading();
        compareAndShowResults();
      } catch (err) {
        console.error('OCR Error:', err);
        hideLoading();
        showError('Error extracting text from the second photos. Please try again.');
      }
    }
    function compareAndShowResults() {
      const { unchanged, removed, added } = compareOrders(meds1, meds2);
      let html = '';
      if (removed.length > 0) {
        html += '<h3>Removed:</h3><ul>';
        removed.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (added.length > 0) {
        html += '<h3>Added:</h3><ul>';
        added.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (unchanged.length > 0) {
        html += '<h3>Unchanged:</h3><ul>';
        unchanged.forEach(orderObj => {
          html += `<li>${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      document.getElementById('results-content').innerHTML = html;
      showScreen('results-screen');
    }
    function exportResults() {
      const resultsDiv = document.getElementById('results-content');
      let textContent = '';
      const sections = resultsDiv.querySelectorAll('h3');
      sections.forEach(section => {
        const sectionTitle = section.textContent;
        textContent += `${sectionTitle}\n`;
        const items = section.nextElementSibling.querySelectorAll('li');
        items.forEach(item => {
          const isCritical = item.classList.contains('critical') ? '[Critical] ' : '';
          textContent += `- ${isCritical}${item.textContent}\n`;
        });
        textContent += '\n';
      });
      textContent = `Comparison Results\n\nChanges listed in bold red are critical medications and should be reconciled with the provider within 4 hours of discovery.\n\n${textContent}`;
      const blob = new Blob([textContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'MedRec_Comparison_Results.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }
    function printResults() {
      const resultsDiv = document.getElementById('results-content').innerHTML;
      const note = document.querySelector('#results-screen p').innerHTML;
      const printContent = `
        <h2>Comparison Results</h2>
        <p>${note}</p>
        ${resultsDiv}
      `;
      const iframe = document.createElement('iframe');
      document.body.appendChild(iframe);
      iframe.style.display = 'none';
      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(`
        <html>
          <head>
            <title>Print MedRec Results</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h2 { text-align: center; }
              p { text-align: center; }
              .critical { color: red; font-weight: bold; }
              ul { padding-left: 20px; }
              li { margin: 5px 0; }
            </style>
          </head>
          <body>
            ${printContent}
          </body>
        </html>
      `);
      doc.close();
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
      document.body.removeChild(iframe);
    }
    function startOver() {
      photo1Files = [];
      photo2Files = [];
      meds1 = [];
      meds2 = [];
      document.getElementById('photo1-capture').value = '';
      document.getElementById('photo1-upload').value = '';
      document.getElementById('photo1-capture2').value = '';
      document.getElementById('photo1-upload2').value = '';
      document.getElementById('photo2-capture').value = '';
      document.getElementById('photo2-upload').value = '';
      document.getElementById('photo2-capture2').value = '';
      document.getElementById('photo2-upload2').value = '';
      document.getElementById('photo1-status').textContent = 'No photo added.';
      document.getElementById('photo2-status').textContent = 'No photo added.';
      document.getElementById('photo1-next').disabled = true;
      document.getElementById('photo2-compare').disabled = true;
      document.getElementById('results-content').innerHTML = '';
      document.getElementById('photo1-preview').innerHTML = "";
      document.getElementById('photo2-preview').innerHTML = "";
      document.getElementById('photo1-prompt').style.display = 'none';
      document.getElementById('initial-photo1-options').style.display = 'flex';
      document.getElementById('additional-photo1-option').style.display = 'none';
      document.getElementById('photo2-prompt').style.display = 'none';
      document.getElementById('initial-photo2-options').style.display = 'flex';
      document.getElementById('additional-photo2-option').style.display = 'none';
      showScreen('disclaimer-screen');
    }
    // Tooltip toggle for mobile
    document.querySelectorAll('.tooltip').forEach(tooltip => {
      tooltip.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = tooltip.classList.contains('active');
        document.querySelectorAll('.tooltip').forEach(t => t.classList.remove('active'));
        if (!isActive) {
          tooltip.classList.add('active');
        }
      });
    });
    document.addEventListener('click', () => {
      document.querySelectorAll('.tooltip').forEach(tooltip => {
        tooltip.classList.remove('active');
      });
    });
    document.addEventListener('DOMContentLoaded', () => {
      hideLoading();
      updateProgress('disclaimer-screen');
    });
  </script>
</body>
</html>
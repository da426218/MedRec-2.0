<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedRec 2.0</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      border-radius: 5px;
      width: 100%;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    input[type="file"] {
      display: block;
      margin: 1rem auto;
      width: 100%;
      max-width: 300px;
    }
    #progress-bar {
      width: 100%;
      margin: 1rem 0;
    }
    #error-message {
      color: red;
      text-align: center;
      margin: 1rem 0;
    }
    .critical {
      color: red;
      font-weight: bold;
    }
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
      position: relative;
    }
    .progress-step {
      width: 30px;
      height: 30px;
      background-color: #cccccc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }
    .progress-step.filled {
      background-color: #007bff;
      color: white;
    }
    .progress-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #cccccc;
      z-index: 0;
    }
    /* Loading overlay starts hidden */
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #loading-text {
      color: white;
      margin-bottom: 1rem;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin: 0.5rem 0;
    }
    h3 {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>MedRec 2.0</h1>
    <div class="progress-bar">
      <div class="progress-line"></div>
      <div class="progress-step" id="step1">1</div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-step" id="step3">3</div>
      <div class="progress-step" id="step4">4</div>
    </div>
  </header>
  <main>
    <div id="error-message"></div>

    <!-- Disclaimer Screen -->
    <div id="disclaimer-screen" class="screen active">
      <h2>Disclaimer</h2>
      <p>This app does not store any photos or medication data. It is not HIPAA compliant and should not be used for official medical purposes. Results may be inaccurate and should be verified by a healthcare professional.</p>
      <button onclick="acknowledgeDisclaimer()">I Understand</button>
    </div>

    <!-- Photo 1 Screen -->
    <div id="photo1-screen" class="screen">
      <h2>Take or Upload First Photo</h2>
      <input type="file" id="photo1-capture" accept="image/*" capture="environment" onchange="handlePhoto1(this.files[0])">
      <input type="file" id="photo1-upload" accept="image/*" onchange="handlePhoto1(this.files[0])">
      <p id="photo1-status">No photo selected.</p>
      <button id="photo1-next" onclick="goToPhoto2()" disabled>Next</button>
    </div>

    <!-- Photo 2 Screen -->
    <div id="photo2-screen" class="screen">
      <h2>Take or Upload Second Photo</h2>
      <input type="file" id="photo2-capture" accept="image/*" capture="environment" onchange="handlePhoto2(this.files[0])">
      <input type="file" id="photo2-upload" accept="image/*" onchange="handlePhoto2(this.files[0])">
      <p id="photo2-status">No photo selected.</p>
      <button id="photo2-compare" onclick="comparePhotos()" disabled>Compare</button>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="screen">
      <h2>Comparison Results</h2>
      <div id="results-content"></div>
      <button onclick="startOver()">Start Over</button>
    </div>
  </main>
  <div id="loading">
    <p id="loading-text">Processing...</p>
    <progress id="progress-bar" max="100"></progress>
  </div>

  <script>
    // --- Order Parsing & Comparison Functions ---
    const criticalMeds = [
      'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban', 'heparin', 'enoxaparin',
      'clopidogrel', 'ticagrelor', 'prasugrel', 'insulin regular', 'insulin glargine', 'insulin detemir',
      'insulin lispro', 'insulin aspart', 'insulin degludec', 'glipizide', 'glyburide', 'glimepiride',
      'repaglinide', 'nateglinide', 'metformin', 'morphine', 'hydromorphone', 'oxycodone', 'fentanyl',
      'methadone', 'tramadol', 'codeine', 'buprenorphine', 'phenytoin', 'carbamazepine', 'valproic acid',
      'phenobarbital', 'lamotrigine', 'levetiracetam', 'digoxin', 'amiodarone', 'sotalol', 'diltiazem',
      'verapamil', 'metoprolol', 'atenolol', 'carvedilol', 'furosemide', 'bumetanide', 'torsemide',
      'spironolactone', 'hydrochlorothiazide', 'chlorthalidone', 'potassium chloride', 'magnesium sulfate',
      'calcium gluconate', 'calcium chloride', 'sodium bicarbonate', 'phosphate', 'hydralazine', 'clonidine',
      'isosorbide mononitrate', 'isosorbide dinitrate', 'nitroglycerin', 'haloperidol', 'risperidone',
      'olanzapine', 'quetiapine', 'aripiprazole', 'ziprasidone', 'lorazepam', 'diazepam', 'clonazepam',
      'temazepam', 'midazolam', 'zolpidem', 'prednisone', 'methylprednisolone', 'dexamethasone',
      'hydrocortisone', 'levothyroxine', 'liothyronine', 'tacrolimus', 'cyclosporine', 'mycophenolate',
      'azathioprine', 'vancomycin', 'gentamicin', 'tobramycin', 'amikacin', 'ciprofloxacin', 'levofloxacin',
      'moxifloxacin', 'azithromycin', 'clarithromycin', 'erythromycin', 'amoxicillin',
      'amoxicillin-clavulanate', 'ceftriaxone', 'cefepime', 'ceftazidime', 'cefdinir', 'cephalexin',
      'piperacillin-tazobactam', 'penicillin vk', 'dicloxacillin', 'nafcillin', 'meropenem', 'ertapenem',
      'imipenem-cilastatin', 'doxycycline', 'minocycline', 'tetracycline', 'linezolid',
      'sulfamethoxazole-trimethoprim', 'nitrofurantoin', 'metronidazole', 'clindamycin', 'fosfomycin',
      'daptomycin', 'tigecycline', 'carbidopa/levodopa', 'entacapone', 'selegiline', 'rasagiline', 'lithium',
      'theophylline', 'clozapine', 'methotrexate', 'allopurinol', 'colchicine', 'tamsulosin', 'finasteride',
      'denosumab', 'zoledronic acid', 'teriparatide', 'alendronate', 'risedronate', 'acetazolamide',
      'bethanechol', 'bethanechol chloride', 'donepezil', 'rivastigmine', 'galantamine', 'memantine',
      'naltrexone', 'naloxone', 'flumazenil', 'desmopressin', 'octreotide', 'erythropoietin', 'filgrastim',
      'calcitriol', 'ergocalciferol', 'cholecalciferol', 'pyridostigmine', 'propranolol', 'labetalol',
      'isosorbide', 'nicardipine', 'nitroprusside', 'ivabradine', 'sacubitril', 'valsartan',
      'atorvastatin', 'rosuvastatin', 'simvastatin'
    ];
    let photo1, photo2, meds1, meds2;
    // Clean trailing punctuation/symbols.
    function cleanLine(line) {
      return line.replace(/[^a-z0-9]+$/i, '').trim();
    }
    // Filter out lines that likely aren't orders.
    function isLikelyOrderLine(line) {
      if (line.length < 3) return false;
      let alphaNumCount = (line.match(/[a-z0-9]/gi) || []).length;
      let ratio = alphaNumCount / line.length;
      if (ratio < 0.4) return false;
      return true;
    }
    // Parse an order into its components.
    function parseOrder(orderStr) {
      orderStr = orderStr.toLowerCase().trim().replace(/\s+/g, ' ');
      let doseMatch = orderStr.match(/(\d+)\s*mg/);
      let dose = doseMatch ? parseInt(doseMatch[1]) : null;
      let route = orderStr.includes("po") ? "po" : "";
      const freqMapping = {
        "every other morning": "every other morning",
        "every other afternoon": "every other afternoon",
        "every other evening": "every other evening",
        "every other night": "every other night",
        "every morning": "every morning",
        "every afternoon": "every afternoon",
        "every evening": "every evening",
        "every night": "every night",
        "once daily": "daily",
        "daily": "daily",
        "qd": "daily",
        "q.d.": "daily",
        "twice daily": "twice daily"
      };
      let frequency = "";
      let freqKeys = Object.keys(freqMapping).sort((a, b) => b.length - a.length);
      for (let key of freqKeys) {
        if (orderStr.includes(key)) {
          frequency = freqMapping[key];
          orderStr = orderStr.replace(key, '');
          break;
        }
      }
      if (doseMatch) {
        orderStr = orderStr.replace(doseMatch[0], '');
      }
      if (route) {
        orderStr = orderStr.replace(/\bpo\b/, '');
      }
      let name = orderStr.trim();
      return { name, dose, route, frequency };
    }
    function ordersAreEqual(a, b) {
      if (a.dose !== b.dose) return false;
      if (a.route !== b.route) return false;
      if (a.frequency !== b.frequency) return false;
      if (a.name && b.name && a.name !== b.name) return false;
      return true;
    }
    function compareOrders(list1, list2) {
      let unchanged = [];
      let removed = [];
      let added = [];
      let matched2 = new Array(list2.length).fill(false);
      for (let orderObj1 of list1) {
        let found = false;
        for (let i = 0; i < list2.length; i++) {
          if (!matched2[i] && ordersAreEqual(orderObj1.parsed, list2[i].parsed)) {
            matched2[i] = true;
            unchanged.push(orderObj1);
            found = true;
            break;
          }
        }
        if (!found) removed.push(orderObj1);
      }
      for (let i = 0; i < list2.length; i++) {
        if (!matched2[i]) added.push(list2[i]);
      }
      return { unchanged, removed, added };
    }
    function isCriticalOrder(parsedOrder) {
      return parsedOrder.name && criticalMeds.includes(parsedOrder.name);
    }
    // --- UI and OCR Flow ---
    function showScreen(screenId) {
      document.getElementById('error-message').textContent = '';
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      updateProgress(screenId);
    }
    function updateProgress(screenId) {
      document.getElementById('step1').classList.remove('filled');
      document.getElementById('step2').classList.remove('filled');
      document.getElementById('step3').classList.remove('filled');
      document.getElementById('step4').classList.remove('filled');
      if (screenId === 'disclaimer-screen') {
        document.getElementById('step1').classList.add('filled');
      } else if (screenId === 'photo1-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
      } else if (screenId === 'photo2-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
      } else if (screenId === 'results-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
        document.getElementById('step4').classList.add('filled');
      }
    }
    function showLoading(msg) {
      const ld = document.getElementById('loading'),
            lt = document.getElementById('loading-text');
      ld.style.display = 'flex';
      lt.textContent = msg;
      document.getElementById('progress-bar').value = 0;
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
    }
    function acknowledgeDisclaimer() {
      showScreen('photo1-screen');
    }
    function handlePhoto1(file) {
      if (!file) return;
      photo1 = file;
      document.getElementById('photo1-status').textContent = 'Photo selected: ' + file.name;
      document.getElementById('photo1-next').disabled = false;
    }
    async function goToPhoto2() {
      if (!photo1) {
        showError('Please select a photo first.');
        return;
      }
      showLoading('Processing first image...');
      try {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Image = e.target.result;
          const response = await fetch('https://us-central1-medrec-ocr.cloudfunctions.net/ocr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64Image })
          });
          const { text, error } = await response.json();
          if (error) throw new Error(error);
          if (!text) throw new Error('No text detected');
          const lines = text.split(/[\n,]+/).map(line => cleanLine(line)).filter(isLikelyOrderLine);
          meds1 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
          console.log('Medications from Photo 1:', meds1);
          hideLoading();
          showScreen('photo2-screen');
        };
        reader.readAsDataURL(photo1);
      } catch (err) {
        console.error('OCR Error:', err);
        hideLoading();
        showError('Error extracting text from the first photo. Please try again.');
      }
    }
    function handlePhoto2(file) {
      if (!file) return;
      photo2 = file;
      document.getElementById('photo2-status').textContent = 'Photo selected: ' + file.name;
      document.getElementById('photo2-compare').disabled = false;
    }
    async function comparePhotos() {
      if (!photo2) {
        showError('Please select a photo first.');
        return;
      }
      showLoading('Processing second image...');
      try {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Image = e.target.result;
          const response = await fetch('https://us-central1-medrec-ocr.cloudfunctions.net/ocr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64Image })
          });
          const { text, error } = await response.json();
          if (error) throw new Error(error);
          if (!text) throw new Error('No text detected');
          const lines = text.split(/[\n,]+/).map(line => cleanLine(line)).filter(isLikelyOrderLine);
          meds2 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
          console.log('Medications from Photo 2:', meds2);
          hideLoading();
          compareAndShowResults();
        };
        reader.readAsDataURL(photo2);
      } catch (err) {
        console.error('OCR Error:', err);
        hideLoading();
        showError('Error extracting text from the second photo. Please try again.');
      }
    }
    function compareAndShowResults() {
      const { unchanged, removed, added } = compareOrders(meds1, meds2);
      let html = '';
      if (removed.length > 0) {
        html += '<h3>Removed:</h3><ul>';
        removed.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (added.length > 0) {
        html += '<h3>Added:</h3><ul>';
        added.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (unchanged.length > 0) {
        html += '<h3>Unchanged:</h3><ul>';
        unchanged.forEach(orderObj => {
          html += `<li>${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      document.getElementById('results-content').innerHTML = html;
      showScreen('results-screen');
    }
    function startOver() {
      photo1 = photo2 = meds1 = meds2 = null;
      document.getElementById('photo1-capture').value = '';
      document.getElementById('photo1-upload').value = '';
      document.getElementById('photo2-capture').value = '';
      document.getElementById('photo2-upload').value = '';
      document.getElementById('photo1-status').textContent = 'No photo selected.';
      document.getElementById('photo2-status').textContent = 'No photo selected.';
      document.getElementById('photo1-next').disabled = true;
      document.getElementById('photo2-compare').disabled = true;
      document.getElementById('results-content').innerHTML = '';
      showScreen('disclaimer-screen');
    }
    updateProgress('disclaimer-screen');
  </script>
</body>
</html>
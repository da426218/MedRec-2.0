<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedRec 2.0</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Basic Layout */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 0.5rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 185px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-sizing: border-box;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .screen {
      display: none;
      width: 100%;
      text-align: center;
    }
    .screen.active {
      display: block;
    }
    /* Card Styling */
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
      padding: 1rem;
      margin: 0.5rem 0;
      width: 100%;
      box-sizing: border-box;
    }
    /* Buttons & Inputs */
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      border-radius: 15px;
      width: 100%;
      max-width: 300px;
      display: block;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.2s ease;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    /* Hide native file inputs */
    input[type="file"] {
      display: none;
    }
    .photo-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin: 1rem 0;
      width: 100%;
    }
    .photo-actions button {
      width: 100%;
      max-width: 300px;
      margin: 0;
    }
    .disclaimer-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1rem 0;
      width: 100%;
    }
    .disclaimer-actions button {
      width: 100%;
      max-width: 300px;
    }
    .upload-instructions {
      font-size: 0.9rem;
      margin: 0.5rem 1rem;
      color: #555;
    }
    .upload-prompt {
      font-size: 0.9rem;
      margin: 0.5rem 1rem;
      color: #333;
    }
    .preview-container {
      text-align: center;
      margin: 0.5rem 0 1rem;
    }
    .thumbnail-container {
      position: relative;
      display: inline-block;
      margin: 0.25rem;
    }
    .thumbnail-container img {
      width: 80px;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    /* ============== delete (close) chip ============== */
    .delete-btn {
      position: absolute;
      top: -6px;                   /* sticks out a little */
      right: -6px;
      width: 24px;                 /* exact circle */
      height: 24px;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ff4d4d;         /* red chip */
      color: #fff;                 /* white “X” */
      font-size: 18px;             /* icon size */
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,.25);
      transition: background .15s ease;
      padding: 0;                  /* override global button padding */
    }
    .delete-btn:hover {
      background: #d73838;         /* darker on hover */
    }
    /* make the glyph a touch smaller and centred */
    .delete-btn .material-icons {
      font-size: 18px;             /* icon ≈ 75 % of circle */
      line-height: 1;
    }
    #error-message {
      color: red;
      text-align: center;
      margin: 1rem 0;
    }
    .critical {
      color: red;
      font-weight: bold;
    }
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0.5rem 0;
      margin-top: -40px;
      position: relative;
    }
    .progress-step {
      width: 30px;
      height: 30px;
      background-color: #cccccc;
      border: 1px solid #999;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: all 0.3s ease;
    }
    .progress-step.filled {
      background-color: #66b0ff;
      border: 1px solid #0056b3;
      color: white;
    }
    .progress-step.current {
      background-color: #007bff;
      border: 3px solid #0056b3;
      color: white;
    }
    .progress-line-container {
      position: absolute;
      top: 50%;
      left: 15px;
      right: 15px;
      height: 2px;
      z-index: 0;
      display: flex;
      justify-content: space-between;
    }
    .progress-line {
      flex: 1;
      height: 2px;
      background-color: #cccccc;
      margin: 0 5px;
    }
    .progress-line.filled {
      background-color: #66b0ff;
    }
    #loading {
      display: none;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.5rem;
      text-align: center;
      z-index: 2000;
    }
    #loading-text {
      margin-bottom: 0.25rem;
    }
    #loading-progress {
      width: 80%;
      max-width: 300px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin: 0.5rem 0;
    }
    h3 {
      margin-top: 1rem;
    }
    p.disclaimer-text {
      text-align: justify;
      max-width: 500px;
      margin: 0 auto;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
      color: #007bff;
      margin-left: 5px;
      font-size: 0.9rem;
    }
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: white;
      text-align: center;
      border-radius: 5px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltip-text,
    .tooltip.active .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    #medrec-logo {
      height: 180px;
      width: auto;
      display: block;
      margin: 0 auto;
      position: relative;
      top: -10px;
      z-index: 1001;
    }
    /* New styles for text input */
    .text-input-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      width: 100%;
    }
    textarea {
      width: 100%;
      max-width: 300px;
      height: 100px;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: none;
      font-family: Arial, sans-serif;
      font-size: 0.9rem;
    }
    textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }
  </style>
</head>
<body>
  <header>
    <img src="MedRec%20Logo.png" alt="MedRec 2.0 Logo" id="medrec-logo">
    <div class="progress-bar">
      <div class="progress-line-container">
        <div class="progress-line" id="line1-2"></div>
        <div class="progress-line" id="line2-3"></div>
        <div class="progress-line" id="line3-4"></div>
      </div>
      <div class="progress-step" id="step1">1</div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-step" id="step3">3</div>
      <div class="progress-step" id="step4">4</div>
    </div>
  </header>
  <main>
    <div id="error-message"></div>
    <!-- Disclaimer Screen -->
    <div id="disclaimer-screen" class="screen active">
      <h2>Disclaimer</h2>
      <div class="card">
        <p class="disclaimer-text">
          <strong>HIPAA Warning: DO NOT UPLOAD IMAGES CONTAINING IDENTIFIABLE INFORMATION.</strong> This app is intended for use by personnel authorized to handle Protected Health Information (PHI). Users are responsible for ensuring compliance with HIPAA regulations, including safeguarding resident/patient data and restricting access to authorized personnel only. Unauthorized disclosure of PHI may result in disciplinary action and legal consequences.

          <em>Note:</em> MedRec 2.0 is a support tool and does not guarantee 100% accuracy in identifying medication differences. Final verification must be completed by qualified clinical personnel.
        </p>
      </div>
      <div class="disclaimer-actions">
        <button onclick="acknowledgeDisclaimer()">I Understand</button>
      </div>
    </div>
    <!-- Photo 1 Screen -->
    <div id="photo1-screen" class="screen">
      <div class="card">
        <h2>Enter First Medication List</h2>
        <p class="upload-instructions">You can take a photo, upload a photo, or paste your medication list below.</p>
        <div id="initial-photo1-options" class="photo-actions">
          <button onclick="document.getElementById('photo1-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo1-upload').click()">Upload Photo</button>
          <div class="text-input-container">
            <textarea id="photo1-text-input" placeholder="Paste your medication list here..."></textarea>
            <button onclick="handleTextInput1()">Submit List</button>
          </div>
        </div>
        <div id="additional-photo1-option" class="photo-actions" style="display: none;">
          <button onclick="document.getElementById('photo1-capture2').click()">Take Another Photo</button>
          <button onclick="document.getElementById('photo1-upload2').click()">Upload Another Photo</button>
        </div>
      </div>
      <input type="file" id="photo1-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto1(this.files)">
      <input type="file" id="photo1-upload" accept="image/*" multiple onchange="handlePhoto1(this.files)">
      <input type="file" id="photo1-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto1(this.files)">
      <input type="file" id="photo1-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto1(this.files)">
      <div id="photo1-preview" class="preview-container"></div>
      <p id="photo1-status"></p>
      <p id="photo1-prompt" class="upload-prompt" style="display: none;"></p>
      <div class="photo-actions">
        <button id="photo1-next" onclick="goToPhoto2()" disabled>Next</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Photo 2 Screen -->
    <div id="photo2-screen" class="screen">
      <div class="card">
        <h2>Enter Second Medication List</h2>
        <p class="upload-instructions">You can take a photo, upload a photo, or paste your medication list below.</p>
        <div id="initial-photo2-options" class="photo-actions">
          <button onclick="document.getElementById('photo2-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo2-upload').click()">Upload Photo</button>
          <div class="text-input-container">
            <textarea id="photo2-text-input" placeholder="Paste your medication list here..."></textarea>
            <button onclick="handleTextInput2()">Submit List</button>
          </div>
        </div>
        <div id="additional-photo2-option" class="photo-actions" style="display: none;">
          <button onclick="document.getElementById('photo2-capture2').click()">Take Another Photo</button>
          <button onclick="document.getElementById('photo2-upload2').click()">Upload Another Photo</button>
        </div>
      </div>
      <input type="file" id="photo2-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto2(this.files)">
      <input type="file" id="photo2-upload" accept="image/*" multiple onchange="handlePhoto2(this.files)">
      <input type="file" id="photo2-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto2(this.files)">
      <input type="file" id="photo2-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto2(this.files)">
      <div id="photo2-preview" class="preview-container"></div>
      <p id="photo2-status"></p>
      <p id="photo2-prompt" class="upload-prompt" style="display: none;"></p>
      <div class="photo-actions">
        <button id="photo2-compare" onclick="comparePhotos()" disabled>Compare</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Results Screen -->
    <div id="results-screen" class="screen">
      <h2>Comparison Results</h2>
      <p>Changes listed in <span class="critical">bold red</span> are critical medications and should be reconciled with the provider within <span class="critical">4 hours</span> of discovery.</p>
      <div class="card">
        <div id="results-content"></div>
      </div>
      <div class="photo-actions">
        <button onclick="exportResults()">Export Results</button>
        <button onclick="printResults()">Print Results</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
  </main>
  <div id="loading">
    <p id="loading-text">Processing...</p>
    <progress id="loading-progress" max="100"></progress>
  </div>
  <script>
    const criticalMeds = [
      'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban', 'heparin', 'enoxaparin',
      'clopidogrel', 'ticagrelor', 'prasugrel', 'insulin regular', 'insulin glargine', 'insulin detemir',
      'insulin lispro', 'insulin aspart', 'insulin degludec', 'glipizide', 'glyburide', 'glimepiride',
      'repaglinide', 'nateglinide', 'metformin', 'morphine', 'hydromorphone', 'oxycodone', 'fentanyl',
      'methadone', 'tramadol', 'codeine', 'buprenorphine', 'phenytoin', 'carbamazepine', 'valproic acid',
      'phenobarbital', 'lamotrigine', 'levetiracetam', 'digoxin', 'amiodarone', 'sotalol', 'diltiazem',
      'verapamil', 'metoprolol', 'atenolol', 'carvedilol', 'furosemide', 'bumetanide', 'torsemide',
      'spironolactone', 'hydrochlorothiazide', 'chlorthalidone', 'potassium chloride', 'magnesium sulfate',
      'calcium gluconate', 'calcium chloride', 'sodium bicarbonate', 'phosphate', 'hydralazine', 'clonidine',
      'isosorbide mononitrate', 'isosorbide dinitrate', 'nitroglycerin', 'haloperidol', 'risperidone',
      'olanzapine', 'quetiapine', 'aripiprazole', 'ziprasidone', 'lorazepam', 'diazepam', 'clonazepam',
      'temazepam', 'midazolam', 'zolpidem', 'prednisone', 'methylprednisolone', 'dexamethasone',
      'hydrocortisone', 'levothyroxine', 'liothyronine', 'tacrolimus', 'cyclosporine', 'mycophenolate',
      'azathioprine', 'vancomycin', 'gentamicin', 'tobramycin', 'amikacin', 'ciprofloxacin', 'levofloxacin',
      'moxifloxacin', 'azithromycin', 'clarithromycin', 'erythromycin', 'amoxicillin',
      'amoxicillin-clavulanate', 'ceftriaxone', 'cefepime', 'ceftazidime', 'cefdinir', 'cephalexin',
      'piperacillin-tazobactam', 'penicillin vk', 'dicloxacillin', 'nafcillin', 'meropenem', 'ertapenem',
      'imipenem-cilastatin', 'doxycycline', 'minocycline', 'tetracycline', 'linezolid',
      'sulfamethoxazole-trimethoprim', 'nitrofurantoin', 'metronidazole', 'clindamycin', 'fosfomycin',
      'daptomycin', 'tigecycline', 'carbidopa/levodopa', 'entacapone', 'selegiline', 'rasagiline', 'lithium',
      'theophylline', 'clozapine', 'methotrexate', 'allopurinol', 'colchicine', 'tamsulosin', 'finasteride',
      'denosumab', 'zoledronic acid', 'teriparatide', 'alendronate', 'risedronate', 'acetazolamide',
      'bethanechol', 'bethanechol chloride', 'donepezil', 'rivastigmine', 'galantamine', 'memantine',
      'naltrexone', 'naloxone', 'flumazenil', 'desmopressin', 'octreotide', 'erythropoietin', 'filgrastim',
      'calcitriol', 'ergocalciferol', 'cholecalciferol', 'pyridostigmine', 'propranolol', 'labetalol',
      'isosorbide', 'nicardipine', 'nitroprusside', 'ivabradine', 'sacubitril', 'valsartan',
      'atorvastatin', 'rosuvastatin', 'simvastatin', 'Norco', 'oxycodone/acetaminophen', 'codeine/acetaminophen', 'tramadol/acetaminophen', 'acetaminophen/caffeine/dihydrocodeine', 'aspirin/caffeine/dihydrocodeine', 'aspirin/codeine', 'ibuprofen/oxycodone', 'acetaminophen/butalbital/caffeine', 'aspirin/butalbital/caffeine', 'acetaminophen/butalbital', 'methylphenidate', 'amphetamine/dextroamphetamine', 'hydrocodone/pseudoephedrine', 'hydrocodone/chlorpheniramine', 'hydrocodone/homatropine', 'busulfan', 'doxorubicin', 'adalimumab', 'acetaminophen/isometheptene/dichloralphenazone', 'ultracet', 'percocet', 'roxicet', 'endocet', 'tylenol #3', 'zamicet', 'vicodin', 'lortab', 'panlor ss', 'trezix', 'synalgos-dc', 'empirin with codeine', 'combunox', 'fioricet', 'esgic', 'zebutal', 'fiorinal', 'bupap', 'rezira', 'tussionex', 'hycomine', 'hydromet', 'midrin'



    ].map(med => med.toLowerCase());

    const commonMedications = [
      { generic: "hydrocodone/acetaminophen", brands: ["Norco", "Vicodin", "Lortab", "Zamicet"] },
      { generic: "oxycodone/acetaminophen",  brands: ["Percocet", "Xartemis XR", "Roxicet", "Endocet"] },
               { generic: "codeine/acetaminophen",     brands: ["Tylenol #3"] },
               { generic: "tramadol/acetaminophen",    brands: ["Ultracet"] },
               { generic: "acetaminophen/caffeine/dihydrocodeine", brands: ["Panlor SS", "Trezix"] },
               { generic: "aspirin/caffeine/dihydrocodeine",       brands: ["Synalgos-DC"] },
               { generic: "aspirin/codeine",            brands: ["Empirin with codeine"] },
               { generic: "acetaminophen/butalbital/caffeine", brands: ["Fioricet", "Esgic", "Zebutal"] },
               { generic: "aspirin/butalbital/caffeine", brands: ["Fiorinal"] },
               { generic: "acetaminophen/butalbital",   brands: ["Bupap"] },
               { generic: "hydrocodone/pseudoephedrine", brands: ["Rezira"] },
               { generic: "hydrocodone/chlorpheniramine", brands: ["Tussionex", "Hycomine"] },
               { generic: "hydrocodone/homatropine",    brands: ["Hydromet"] },
               { generic: "busulfan",                   brands: ["Myleran"] },
               { generic: "acetaminophen/isometheptene/dichloralphenazone", brands: ["Midrin"] },
               { generic: "ibuprofen/oxycodone",        brands: ["Combunox"] },
      { generic: "acetaminophen", brands: ["Tylenol"] },
      { generic: "albuterol", brands: ["Ventolin", "ProAir", "Proventil", "salbutamol"] },
      { generic: "allopurinol", brands: ["Zyloprim"] },
      { generic: "alprazolam", brands: ["Xanax"] },
      { generic: "amlodipine", brands: ["Norvasc"] },
      { generic: "amoxicillin", brands: ["Amoxil", "Trimox"] },
      { generic: "aspirin", brands: ["Bayer", "Ecotrin"] },
      { generic: "atenolol", brands: ["Tenormin"] },
      { generic: "atorvastatin", brands: ["Lipitor"] },
      { generic: "azithromycin", brands: ["Zithromax", "Z-Pak"] },
      { generic: "bisoprolol", brands: ["Zebeta"] },
      { generic: "budesonide", brands: ["Pulmicort", "Rhinocort"] },
      { generic: "cefuroxime", brands: ["Ceftin", "Zinacef"] },
      { generic: "cephalexin", brands: ["Keflex"] },
      { generic: "cetirizine", brands: ["Zyrtec"] },
      { generic: "ciprofloxacin", brands: ["Cipro"] },
      { generic: "citalopram", brands: ["Celexa"] },
      { generic: "clindamycin", brands: ["Cleocin"] },
      { generic: "clonazepam", brands: ["Klonopin"] },
      { generic: "clopidogrel", brands: ["Plavix"] },
      { generic: "cyclobenzaprine", brands: ["Flexeril"] },
      { generic: "digoxin", brands: ["Lanoxin"] },
      { generic: "doxycycline", brands: ["Vibramycin"] },
      { generic: "duloxetine", brands: ["Cymbalta"] },
      { generic: "enalapril", brands: ["Vasotec"] },
      { generic: "escitalopram", brands: ["Lexapro"] },
      { generic: "esomeprazole", brands: ["Nexium"] },
      { generic: "ferrous sulfate", brands: [] },
      { generic: "fluoxetine", brands: ["Prozac"] },
      { generic: "fluticasone", brands: ["Flonase", "Flovent"] },
      { generic: "furosemide", brands: ["Lasix"] },
      { generic: "gabapentin", brands: ["Neurontin"] },
      { generic: "glipizide", brands: ["Glucotrol"] },
      { generic: "glyburide", brands: ["Diabeta", "Micronase"] },
      { generic: "hydralazine", brands: ["Apresoline"] },
      { generic: "hydrochlorothiazide", brands: ["Microzide"] },
      { generic: "ibuprofen", brands: ["Advil", "Motrin"] },
      { generic: "insulin glargine", brands: ["Lantus", "Basaglar"] },
      { generic: "insulin lispro", brands: ["Humalog"] },
      { generic: "irbesartan", brands: ["Avapro"] },
      { generic: "isosorbide mononitrate", brands: ["Imdur"] },
      { generic: "ketorolac", brands: ["Toradol"] },
      { generic: "levothyroxine", brands: ["Synthroid", "Levoxyl"] },
      { generic: "lisinopril", brands: ["Prinivil", "Zestril"] },
      { generic: "lorazepam", brands: ["Ativan"] },
      { generic: "losartan", brands: ["Cozaar"] },
      { generic: "melatonin", brands: [] },
      { generic: "meloxicam", brands: ["Mobic"] },
      { generic: "metformin", brands: ["Glucophage"] },
      { generic: "methotrexate", brands: ["Trexall"] },
      { generic: "metoprolol", brands: ["Lopressor", "Toprol XL"] },
      { generic: "montelukast", brands: ["Singulair"] },
      { generic: "naproxen", brands: ["Aleve", "Naprosyn"] },
      { generic: "nifedipine", brands: ["Procardia", "Adalat"] },
      { generic: "nystatin", brands: ["Mycostatin"] },
      { generic: "omeprazole", brands: ["Prilosec"] },
      { generic: "oxycodone", brands: ["OxyContin", "Roxicodone"] },
      { generic: "pantoprazole", brands: ["Protonix"] },
      { generic: "pravastatin", brands: ["Pravachol"] },
      { generic: "prednisone", brands: ["Deltasone"] },
      { generic: "propranolol", brands: ["Inderal"] },
      { generic: "quinapril", brands: ["Accupril"] },
      { generic: "ranitidine", brands: ["Zantac"] },
      { generic: "rosuvastatin", brands: ["Crestor"] },
      { generic: "sertraline", brands: ["Zoloft"] },
      { generic: "simvastatin", brands: ["Zocor"] },
      { generic: "sitagliptin", brands: ["Januvia"] },
      { generic: "sotalol", brands: ["Betapace"] },
      { generic: "spironolactone", brands: ["Aldactone"] },
      { generic: "sulfamethoxazole-trimethoprim", brands: ["Bactrim", "Septra"] },
      { generic: "tamsulosin", brands: ["Flomax"] },
      { generic: "tramadol", brands: ["Ultram"] },
      { generic: "trazodone", brands: ["Desyrel"] },
      { generic: "valacyclovir", brands: ["Valtrex"] },
      { generic: "valproic acid", brands: ["Depakene"] },
      { generic: "venlafaxine", brands: ["Effexor"] },
      { generic: "verapamil", brands: ["Calan", "Verelan"] },
      { generic: "warfarin", brands: ["Coumadin"] },
      { generic: "zolpidem", brands: ["Ambien"] },
      { generic: "amphetamine/dextroamphetamine", brands: ["Adderall", "Adderall XR"] },
      { generic: "alendronate", brands: ["Fosamax"] },
      { generic: "tadalafil", brands: ["Cialis"] },
      { generic: "fluticasone/umeclidinium/vilanterol", brands: ["Trelegy"] },
      { generic: "empagliflozin", brands: ["Jardiance"] },
      { generic: "semaglutide", brands: ["Ozempic", "Wegovy"] },
      { generic: "vitamin d", brands: ["Drisdol"] },
      { generic: "prednisolone", brands: ["Pred Forte"] },
      { generic: "enoxaparin", brands: ["Lovenox", "Clexane"] },
      { generic: "doxorubicin", brands: ["Adriamycin"] },
      { generic: "adalimumab", brands: ["Humira"] },
      { generic: "rivaroxaban", brands: ["Xarelto"] },
      { generic: "methylphenidate", brands: ["Ritalin", "Concerta"] },
      { generic: "memantine", brands: ["Namenda"] },
      { generic: "isosorbide", brands: [] },
      { generic: "isosorbide dinitrate", brands: [] }
    ];

    const unitVariants = {
  tablet:   ['tab','tabs','tablet','tablets','tab.','tablet.'],
  capsule:  ['cap','caps','capsule','capsules','caplet','cap.','gelcap','softgel','gel','sprinkle','sprinkles'],
  spray:    ['spray','sprays'],
  puff:     ['puff','puffs'],
  drop:     ['drop','drops','gtt','gtts','gt','drp'],
  patch:    ['patch','patches','transdermal patch'],
  injection:['shot','syringe','pen','inj','auto-injector'],
  lozenge:  ['lozenge','loz','troche'],
  suppository:['supp','suppositories'],
  solution: ['solution','sol','liq','liquid','oral sol'],
  ointment: ['ointment','oint','ung','cream','gel'],
  inhalation:['inhaler','inh','neb','nebulizer','mdi','dpi'],
  unit:     ['U','IU','units'],
  mL:       ['ml','mL','cc'],
  mcg:      ['μg','mcg','ug'],
  mg:       ['mg'],
  g:        ['g','gram','grams']
};


    let photo1Files = [];
    let photo2Files = [];
    let meds1 = [], meds2 = [];
    let hasTextInput1 = false; // Track if Photo 1 used text input
    let hasTextInput2 = false; // Track if Photo 2 used text input

    async function processFiles(files) {
      let allText = "";
      let lowConfidence = false;
      for (let file of files) {
        try {
          const result = await processFile(file);
          allText += "\n" + result.text;
          if (result.confidence < 0.8) {
            lowConfidence = true;
          }
        } catch (err) {
          console.error("Error processing file: ", err);
        }
      }
      if (lowConfidence) {
        showError("Warning: Some text was unclear and may not be accurate. Please review manually.");
      }
      return allText;
    }

    function processFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Image = e.target.result;
          try {
            const response = await fetch('https://us-central1-medrec-ocr.cloudfunctions.net/ocr', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: base64Image })
            });
            const { text, confidence, error } = await response.json();
            if (error) reject(error);
            else if (!text) reject('No text detected');
            else resolve({ text, confidence: confidence || 1.0 });
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject("File could not be read.");
        reader.readAsDataURL(file);
      });
    }

    function cleanLine(line) {
      return line.replace(/[^a-z0-9]+$/i, '').trim();
    }

    function isLikelyOrderLine(line) {
      if (line.length < 3) return false;
      let alphaNumCount = (line.match(/[a-z0-9]/gi) || []).length;
      let ratio = alphaNumCount / line.length;
      return ratio >= 0.4;
    }

function containsKnownMedication(line) {
  const lower = line.toLowerCase();

  // 1) Critical meds always match
  if (criticalMeds.some(med => lower.includes(med))) return true;

  // 2) Any brand name in commonMedications also counts
  if (commonMedications.some(m =>
        m.brands.some(b => lower.includes(b.toLowerCase()))
      )) return true;

  // 3) Generic names or dose patterns as before
  return commonMedications.some(med => lower.includes(med.generic))
      || /\d+\s*(?:mg|mcg|units|puffs|tabs?|tablets?|capsules?)\b/.test(lower);
}

    function normalizeText(str) {
  let text = str.toLowerCase()
    .replace(/\bone\b/g, '1')
    .replace(/\btwo\b/g, '2')
    .replace(/\bthree\b/g, '3')
    .replace(/\bfour\b/g, '4')
    .replace(/\bfive\b/g, '5');

  return text
    .replace(/p\.?o\.?/g, 'po')
    .replace(/q\.?d\.?/g, 'daily')
    .replace(/b\.?i\.?d\.?/g, 'twice daily')
    .replace(/\bqhs\b/g, 'at bedtime')
    .replace(/\bevery night\b/g, 'at bedtime')
    .replace(/hrs/g, 'hours')
    .replace(/μg/g, 'mcg')
    .replace(/ml/g, 'mL')
    .replace(/[^\w\s\/-]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}


function normalizeMedicationName(name) {
  if (!name) return "";
  const lowerName = name.toLowerCase();

  // 1) Critical meds stay as-is
  for (let med of criticalMeds) {
    if (lowerName.includes(med)) return med;
  }

  // 2) Generic or brand → generic
  for (const {generic, brands} of commonMedications) {
    if (lowerName.includes(generic))      return generic;
    if (brands.some(b => lowerName.includes(b.toLowerCase()))) {
      return generic;
    }
  }

  // 3) Fallback to raw text
  return lowerName;
}

    function parseOrder(orderStr) {
      orderStr = orderStr.replace(/[\u2010\u2011\u2012\u2013\u2014\u2015\u2212]/g, '-');
      orderStr = normalizeText(orderStr);

let order = {
  drug: "",
  dose: { value: null, unit: '', total: null },
  route: "",
  frequency: "",
  prn: false,
  form: "",
  indication: ""
};

// ——— TRACK PAIN INDICATION ———
const indicMatch = orderStr.match(/\bfor\s+(?:(mild|moderate|severe)\s+)?pain\b/i);
if (indicMatch) {
  // indicMatch[1] will be "mild", "moderate", "severe", or undefined
  order.indication = (indicMatch[1] ? indicMatch[1].toLowerCase() + " " : "") + "pain";
  orderStr = orderStr.replace(indicMatch[0], "").trim();
}

// ——— ADD for combo doses like “10-325 mg” ———
const comboMatch = orderStr.match(/(\d+)\s*-\s*(\d+)\s*mg\b/);
if (comboMatch) {
  order.dose = {
    value: [parseInt(comboMatch[1], 10), parseInt(comboMatch[2], 10)],
    unit: 'mg',
    total: null
  };
  orderStr = orderStr.replace(comboMatch[0], '').trim();
}
// ——————————————————————————————————————



      try {
        // Build a flat list of all unit synonyms
        const allUnits = Object.values(unitVariants).flat();

        // Find every occurrence of "<number> <unit>" for those variants
        let unitMatches = [];
        for (let u of allUnits) {
          const re = new RegExp(`(\\d+)\\s*${u}\\b`, 'ig');
          let m;
          while ((m = re.exec(orderStr)) !== null) {
            unitMatches.push({ idx: m.index, qty: +m[1], rawUnit: u });
          }
        }

        // If we found any, pick the one that comes last in the line
        if (!Array.isArray(order.dose.value) && unitMatches.length) {
          const best = unitMatches.reduce((a, b) => b.idx > a.idx ? b : a);
          const stdUnit = Object.entries(unitVariants)
            .find(([std, arr]) => arr.includes(best.rawUnit))?.[0];
          if (stdUnit) {
            order.dose = { value: best.qty, unit: stdUnit, total: best.qty };
            orderStr = orderStr.replace(new RegExp(`${best.qty}\\s*${best.rawUnit}\\b`, 'i'), '').trim();
          } else {
            console.warn('No standard unit found for raw unit:', best.rawUnit, 'in:', orderStr);
          }
        } else {
          console.warn('No unit matches found in:', orderStr);
        }

        // 1. Extract "sprays per nostril" first
        const sprayPerNostril = orderStr.match(/(\d+)\s+sprays?\s+per\s+nostril/i);
        if (sprayPerNostril) {
          const n = parseInt(sprayPerNostril[1], 10);
          order.dose = { value: n, unit: 'spray', total: n * 2 };
          order.route = "nasal";
          orderStr = orderStr.replace(sprayPerNostril[0], '').trim();
        }

        // 2. Generic unit pattern
        const unitRegex = new RegExp(`(\\d+)\\s*(${Object.values(unitVariants).flat().join('|')})\\b`, 'i');
        const unitMatch = orderStr.match(unitRegex);
        if (unitMatch && !order.dose.value) {
          const qty = parseInt(unitMatch[1], 10);
          const rawUnit = unitMatch[2].toLowerCase();
          const stdUnit = Object.entries(unitVariants).find(([key, arr]) => arr.includes(rawUnit))?.[0];
          if (stdUnit) {
            order.dose = { value: qty, unit: stdUnit, total: qty };
            orderStr = orderStr.replace(unitMatch[0], '').trim();
          } else {
            console.warn('No standard unit found for:', rawUnit, 'in:', orderStr);
          }
        }

        // 3. Fallback to standard dose extraction
        if (!order.dose.value) {
          let leadingDoseMatch = orderStr.match(/(\d+)\s+(sprays|spray|capsules|capsule|puffs|puff|drops|drop|[μmcgnmLgtspbIumeqmol%\/]+)/i);
          if (leadingDoseMatch) {
            order.dose = {
              value: parseFloat(leadingDoseMatch[1]),
              unit: leadingDoseMatch[2] || '',
              total: parseFloat(leadingDoseMatch[1])
            };
            orderStr = orderStr.replace(leadingDoseMatch[0], '').trim();
          } else {
            console.warn('No leading dose match found in:', orderStr);
          }
        }

        // Adjust for "per nostril", "per eye", "per ear" if not already handled
        if (order.dose.value && !order.sprayCountPerNostril && (orderStr.match(/\bper nostril\b/i) || orderStr.match(/\bper eye\b/i) || orderStr.match(/\bper ear\b/i))) {
          order.dose.total = order.dose.value * 2;
          orderStr = orderStr.replace(/\bper nostril\b/i, '').replace(/\bper eye\b/i, '').replace(/\bper ear\b/i, '').trim();
        }

        // Normalize the unit
const units = {
  'mcg':      ['mcg','μg'],
  'mg':       ['mg'],
  'g':        ['g'],
  'mL':       ['mL','ml'],
  'L':        ['L'],
  'tsp':      ['tsp','teaspoon'],
  'tbsp':     ['tbsp','tablespoon'],
  'drop':     ['drop','drops','gtt'],
  'spray':    ['spray','sprays'],
  'puff':     ['puff','puffs'],
  'unit':     ['unit','units'],
  'IU':       ['IU','international units'],
  'mEq':      ['mEq','milliequivalents'],
  'mmol':     ['mmol','millimoles'],
  'mg/mL':    ['mg/mL'],
  'mcg/mL':   ['mcg/mL'],
  '%':        ['%'],
  'patch':    ['patch','patches'],
  'applicator':['applicator','applicators'],
  'ampule':   ['ampule','ampules'],
  'vial':     ['vial','vials'],
  'capsule':  ['cap','caps','capsule','capsules','caplet','cap.','gelcap','softgel','gel','sprinkle','sprinkles'],
  'tablet':   ['tab','tabs','tablet','tablets','tab.','tablet.'],
  'lozenge':  ['lozenge','lozenges'],
  'suppository':['suppository','suppositories']
};

        if (order.dose.unit) {
          for (let [standard, variations] of Object.entries(units)) {
            if (variations.includes(order.dose.unit)) {
              order.dose.unit = standard;
              break;
            }
          }
        }
     // ——— DETECT TABLET vs CAPSULE ———
     const formMatch = orderStr.match(/\b(caplet|capsule|tablet)\b/i);
     if (formMatch) {
       order.form = formMatch[1].toLowerCase();    // “tablet” or “capsule” or “caplet”
       orderStr = orderStr.replace(formMatch[0], '').trim();
     }
     // ——————————————————————————————

        // Define routes with their possible variations
        const routes = [
          { standard: "po", variations: ["po", "oral"] },
          { standard: "sl", variations: ["sl", "sublingual"] },
          { standard: "buccal", variations: ["buccal"] },
          { standard: "pr", variations: ["pr", "rectal"] },
          { standard: "ng", variations: ["ng", "nasogastric"] },
          { standard: "og", variations: ["og", "orogastric"] },
          { standard: "gastrostomy", variations: ["gastrostomy"] },
          { standard: "jejunostomy", variations: ["jejunostomy"] },
          { standard: "iv", variations: ["iv", "intravenous"] },
          { standard: "im", variations: ["im", "intramuscular"] },
          { standard: "subq", variations: ["subq", "sc", "subcutaneous"] },
          { standard: "id", variations: ["id", "intradermal"] },
          { standard: "io", variations: ["io", "intraosseous"] },
          { standard: "intrathecal", variations: ["intrathecal"] },
          { standard: "epidural", variations: ["epidural"] },
          { standard: "topical", variations: ["topical"] },
          { standard: "transdermal", variations: ["transdermal"] },
          { standard: "ophthalmic", variations: ["ophthalmic"] },
          { standard: "otic", variations: ["otic"] },
          { standard: "nasal", variations: ["nasal"] },
          { standard: "vaginal", variations: ["vaginal"] },
          { standard: "urethral", variations: ["urethral"] },
          { standard: "intrauterine", variations: ["intrauterine"] },
          { standard: "inhalation", variations: ["inhalation", "mdi", "dpi", "nebulized"] },
          { standard: "intranasal", variations: ["intranasal"] },
          { standard: "intraperitoneal", variations: ["intraperitoneal"] },
          { standard: "intraarticular", variations: ["intraarticular", "intra-articular"] },
          { standard: "intrapleural", variations: ["intrapleural"] },
          { standard: "intravesical", variations: ["intravesical"] },
          { standard: "implantable", variations: ["implantable"] }
        ];

        if (!order.route) {
          for (const routeDef of routes) {
            for (const variation of routeDef.variations) {
              if (orderStr.includes(variation)) {
                order.route = routeDef.standard;
                orderStr = orderStr.replace(new RegExp(`\\b${variation}\\b`, 'i'), '');
                break;
              }
            }
            if (order.route) break;
          }
        }

        // Handle PRN ("as needed" or "prn")
        if (/\bprn\b/i.test(orderStr) || /as needed/i.test(orderStr)) {
          order.prn = true;
          orderStr = orderStr
            .replace(/\bprn\b/ig, "")
            .replace(/as needed/ig, "")
            .trim();
        }

        // Handle "every X hours" patterns
        const everyHoursMatch = orderStr.match(/every\s+(\d+)\s*hours/i);
        if (everyHoursMatch) {
          const hours = parseInt(everyHoursMatch[1]);
          order.frequency = `q${hours}h`;
          orderStr = orderStr.replace(everyHoursMatch[0], '');
        } else {
          const freqMapping = {
            "every other morning": "every other morning",
            "every other afternoon": "every other afternoon",
            "every other evening": "every other evening",
            "every other night": "every other night",
            "every morning": "every morning",
            "every afternoon": "every afternoon",
            "every evening": "every evening",
            "every night": "every night",
            "once daily": "daily",
            "daily": "daily",
            "qd": "daily",
            "q.d.": "daily",
            "twice daily": "twice daily",
            "bid": "twice daily",
            "tid": "three times daily",
            "qid": "four times daily",
            "qhs": "at bedtime",
            "stat": "immediately"
          };
          let freqKeys = Object.keys(freqMapping).sort((a, b) => b.length - a.length);
          for (let key of freqKeys) {
            if (orderStr.includes(key)) {
              order.frequency = freqMapping[key];
              orderStr = orderStr.replace(key, '');
              break;
            }
          }
        }

        order.drug = orderStr.trim() || orderStr.split(/\s+/)[0] || '';

        // Debugging for all orders
        console.log('Parsed order:', { original: orderStr, parsed: order });

        return order;
      } catch (e) {
        console.error('Error parsing order:', orderStr, e.stack || e);
         return { 
      drug: orderStr || '', 
      dose: { value: null, unit: '', total: null }, 
      route: '', 
      frequency: '', 
      prn: false, 
      form: '', 
      indication: '' 
    };
   }
}

    function levenshteinDistance(a, b) {
      const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
      for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
      for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
      for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
          const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j][i - 1] + 1,
            matrix[j - 1][i] + 1,
            matrix[j - 1][i - 1] + indicator
          );
        }
      }
      return matrix[b.length][a.length];
    }

    function similarity(a, b) {
      const distance = levenshteinDistance(a, b);
      const maxLen = Math.max(a.length, b.length);
      return 1 - distance / maxLen;
    }

    function ordersAreEqual(a, b) {
  // 1) drug name
  const normA = normalizeMedicationName(a.drug);
  const normB = normalizeMedicationName(b.drug);
  const drugSimilarity = normA && normB
    ? similarity(normA, normB)
    : (normA === normB ? 1 : 0);
  if (drugSimilarity < 0.85) return false;

  // 2) dose (including combos)
  if (Array.isArray(a.dose.value) || Array.isArray(b.dose.value)) {
    if (!Array.isArray(a.dose.value) || !Array.isArray(b.dose.value)) return false;
    if (a.dose.value.length !== b.dose.value.length) return false;
    for (let i = 0; i < a.dose.value.length; i++) {
      if (a.dose.value[i] !== b.dose.value[i]) return false;
    }
    if (a.dose.unit !== b.dose.unit) return false;
  } else {
    const totalA = (a.dose.total != null ? a.dose.total : a.dose.value);
    const totalB = (b.dose.total != null ? b.dose.total : b.dose.value);
    if (totalA !== totalB || a.dose.unit !== b.dose.unit) return false;
  }

  // 3) route
  if (a.route !== b.route) return false;

  // 4) frequency (“qXh” exact or fuzzy)
  const qA = a.frequency.match(/^q(\d+)h$/);
  const qB = b.frequency.match(/^q(\d+)h$/);
  if (qA && qB) {
    if (parseInt(qA[1]) !== parseInt(qB[1])) return false;
  } else {
    const freqSim = (a.frequency && b.frequency)
      ? similarity(a.frequency, b.frequency)
      : (a.frequency === b.frequency ? 1 : 0);
    if (freqSim < 0.85) return false;
  }
   // 5) dosage form must match (tablet ≠ capsule)
   if ((a.form || "") !== (b.form || "")) return false;
  // 6) PRN flag
  if (a.prn !== b.prn) return false;

// ——— ENSURE PAIN INDICATION MATCHES ———
if ((a.indication || b.indication) && a.indication !== b.indication) {
  return false;
}
// ——————————————————————————————

  return true;
}

    function compareOrders(list1, list2) {
      let unchanged = [];
      let removed = [];
      let added = [];
      let matched2 = new Array(list2.length).fill(false);
      for (let orderObj1 of list1) {
        let found = false;
        for (let i = 0; i < list2.length; i++) {
          if (!matched2[i] && ordersAreEqual(orderObj1.parsed, list2[i].parsed)) {
            matched2[i] = true;
            unchanged.push(orderObj1);
            found = true;
            break;
          }
        }
        if (!found) removed.push(orderObj1);
      }
      for (let i = 0; i < list2.length; i++) {
        if (!matched2[i]) added.push(list2[i]);
      }
      return { unchanged, removed, added };
    }

    function isCriticalOrder(orderObj) {
      const text = orderObj.original.toLowerCase();
      return criticalMeds.some(med => text.includes(med));
    }

    function showScreen(screenId) {
      document.getElementById('error-message').textContent = '';
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      updateProgress(screenId);
    }

    function updateProgress(screenId) {
      document.getElementById('step1').classList.remove('filled', 'current');
      document.getElementById('step2').classList.remove('filled', 'current');
      document.getElementById('step3').classList.remove('filled', 'current');
      document.getElementById('step4').classList.remove('filled', 'current');
      document.getElementById('line1-2').classList.remove('filled');
      document.getElementById('line2-3').classList.remove('filled');
      document.getElementById('line3-4').classList.remove('filled');

      if (screenId === 'disclaimer-screen') {
        document.getElementById('step1').classList.add('current');
      } else if (screenId === 'photo1-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('current');
        document.getElementById('line1-2').classList.add('filled');
      } else if (screenId === 'photo2-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('current');
        document.getElementById('line1-2').classList.add('filled');
        document.getElementById('line2-3').classList.add('filled');
      } else if (screenId === 'results-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
        document.getElementById('step4').classList.add('filled');
        document.getElementById('line1-2').classList.add('filled');
        document.getElementById('line2-3').classList.add('filled');
        document.getElementById('line3-4').classList.add('filled');
      }
    }

    function showLoading(msg) {
      const ld = document.getElementById('loading'),
            lt = document.getElementById('loading-text');
      ld.style.display = 'flex';
      lt.textContent = msg;
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
    }

    function acknowledgeDisclaimer() {
      showScreen('photo1-screen');
    }

    function handlePhoto1(files) {
      if (!files || files.length === 0) return;
      photo1Files = photo1Files.concat(Array.from(files));
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto1UI();
    }

    function handleAdditionalPhoto1(files) {
      if (!files || files.length === 0) return;
      photo1Files = photo1Files.concat(Array.from(files));
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto1UI();
      document.getElementById('photo1-capture2').value = "";
      document.getElementById('photo1-upload2').value = "";
    }

    function updatePhoto1UI() {
  // Hide the “take/upload/paste” line as soon as there's ≥1 photo:
  const instr1 = document.querySelector('#photo1-screen .upload-instructions');
  instr1.style.display = photo1Files.length > 0 ? 'none' : 'block';

  // Update count & Next-button state:
  document.getElementById('photo1-status').textContent =
    photo1Files.length + (photo1Files.length === 1
      ? " photo added."
      : " photos added.");
  document.getElementById('photo1-next').disabled =
    photo1Files.length === 0;

  // Refresh thumbnails:
  updatePreview('photo1-preview', photo1Files, 1);

  if (photo1Files.length > 0) {
    // Show prompt with **Next** bold:
    const prompt1 = document.getElementById('photo1-prompt');
    prompt1.style.display = 'block';
    prompt1.innerHTML =
      `Photo ${photo1Files.length} of 5 added. ` +
      `Add another photo (up to 5) to complete your list, or click ` +
      `<strong>Next</strong> to continue.`;

    // Swap out buttons:
    document.getElementById('initial-photo1-options').style.display = 'none';
    document.getElementById('additional-photo1-option').style.display = 'flex';
  } else {
    // No photos → back to start
    document.getElementById('photo1-prompt').style.display = 'none';
    document.getElementById('initial-photo1-options').style.display = 'flex';
    document.getElementById('additional-photo1-option').style.display = 'none';
  }

  // Clear file inputs so you can re-select the same file if needed:
  document.getElementById('photo1-capture').value = "";
  document.getElementById('photo1-upload').value = "";
}



    function handlePhoto2(files) {
      if (!files || files.length === 0) return;
      photo2Files = photo2Files.concat(Array.from(files));
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto2UI();
    }

    function handleAdditionalPhoto2(files) {
      if (!files || files.length === 0) return;
      photo2Files = photo2Files.concat(Array.from(files));
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0,5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      updatePhoto2UI();
      document.getElementById('photo2-capture2').value = "";
      document.getElementById('photo2-upload2').value = "";
    }

    function updatePhoto2UI() {
  // Hide original instructions once you have ≥1 photo:
  const instr2 = document.querySelector('#photo2-screen .upload-instructions');
  instr2.style.display = photo2Files.length > 0 ? 'none' : 'block';

  // Update count & Compare-button state:
  document.getElementById('photo2-status').textContent =
    photo2Files.length + (photo2Files.length === 1
      ? " photo added."
      : " photos added.");
  document.getElementById('photo2-compare').disabled =
    photo2Files.length === 0;

  // Refresh thumbnails:
  updatePreview('photo2-preview', photo2Files, 2);

  if (photo2Files.length > 0) {
    // Show prompt with **Compare** bold:
    const prompt2 = document.getElementById('photo2-prompt');
    prompt2.style.display = 'block';
    prompt2.innerHTML =
      `Photo ${photo2Files.length} of 5 added. ` +
      `Add another photo (up to 5) to complete your list, or click ` +
      `<strong>Compare</strong> to continue.`;

    // Swap out buttons:
    document.getElementById('initial-photo2-options').style.display = 'none';
    document.getElementById('additional-photo2-option').style.display = 'flex';
  } else {
    // No photos → back to start
    document.getElementById('photo2-prompt').style.display = 'none';
    document.getElementById('initial-photo2-options').style.display = 'flex';
    document.getElementById('additional-photo2-option').style.display = 'none';
  }

  // Clear file inputs
  document.getElementById('photo2-capture').value = "";
  document.getElementById('photo2-upload').value = "";
}

    function updatePreview(previewId, files, listNumber) {
      const container = document.getElementById(previewId);
      container.innerHTML = "";
      files.forEach((file, index) => {
        const thumbnailDiv = document.createElement('div');
        thumbnailDiv.className = 'thumbnail-container';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '<span class="material-icons">close</span>';
        deleteBtn.onclick = () => deletePhoto(listNumber, index);
        thumbnailDiv.appendChild(img);
        thumbnailDiv.appendChild(deleteBtn);
        container.appendChild(thumbnailDiv);
      });
    }

    function deletePhoto(listNumber, index) {
      if (listNumber === 1) {
        photo1Files.splice(index, 1);
        updatePhoto1UI();
      } else if (listNumber === 2) {
        photo2Files.splice(index, 1);
        updatePhoto2UI();
      }
    }

    function handleTextInput1() {
      const text = document.getElementById('photo1-text-input').value.trim();
      if (!text) {
        showError('Please paste a medication list before submitting.');
        return;
      }
      // Clear any old status
      document.getElementById('photo1-status').textContent = 'List pasted.';
      hasTextInput1 = true;
      let lines = text
        .split(/\r?\n+/)
        .map(line => cleanLine(line))
        .filter(line => isLikelyOrderLine(line) && containsKnownMedication(line));
      console.log('Raw lines after filtering:', lines); // Debug log
      lines = [...new Set(lines)];
      if (lines.length === 0) {
        showError('No valid medication orders detected in the pasted list. Please try again.');
        return;
      }
      meds1 = lines.map(med => {
        try {
          const parsed = parseOrder(med);
          if (!parsed || typeof parsed !== 'object') {
            console.warn('Parse failed for:', med, 'returning default object');
            return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
          }
          return { original: med, parsed: parsed };
        } catch (e) {
          console.error('Error parsing line:', med, e.stack || e);
          return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
        }
      });
      console.log('Medications from First List (Text Input):', meds1);
      document.getElementById('photo1-status').textContent = 'Proceeding to second list...';
      document.getElementById('initial-photo1-options').style.display = 'none';
      document.getElementById('additional-photo1-option').style.display = 'none';
      document.getElementById('photo1-prompt').style.display = 'none';
      showError('');
      showScreen('photo2-screen');
    }

    function handleTextInput2() {
      const text = document.getElementById('photo2-text-input').value.trim();
      if (!text) {
        showError('Please paste a medication list before submitting.');
        return;
      }
      // Clear any old status
      document.getElementById('photo2-status').textContent = 'List pasted.';
      hasTextInput2 = true;
      let lines = text
        .split(/\r?\n+/)
        .map(line => cleanLine(line))
        .filter(line => isLikelyOrderLine(line) && containsKnownMedication(line));
      console.log('Raw lines after filtering:', lines); // Debug log
      lines = [...new Set(lines)];
      if (lines.length === 0) {
        showError('No valid medication orders detected in the pasted list. Please try again.');
        return;
      }
      meds2 = lines.map(med => {
        try {
          const parsed = parseOrder(med);
          if (!parsed || typeof parsed !== 'object') {
            console.warn('Parse failed for:', med, 'returning default object');
            return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
          }
          return { original: med, parsed: parsed };
        } catch (e) {
          console.error('Error parsing line:', med, e.stack || e);
          return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
        }
      });
      console.log('Medications from Second List (Text Input):', meds2);
      document.getElementById('photo2-compare').disabled = false;
      document.getElementById('initial-photo2-options').style.display = 'none';
      document.getElementById('additional-photo2-option').style.display = 'flex';
      document.getElementById('photo2-prompt').style.display = 'block';
      document.getElementById('photo2-prompt').textContent = 'You may add a photo or click Compare to continue.';
      showError('');
    }

    async function goToPhoto2() {
      if (!hasTextInput1 && (!photo1Files || photo1Files.length === 0)) {
        showError('Please select at least one photo or submit a medication list.');
        return;
      }
      if (!hasTextInput1) {
        showLoading('Processing first image(s)...');
        try {
          let combinedText = await processFiles(photo1Files);
          let lines = combinedText
            .split(/\r?\n+/)
            .map(line => cleanLine(line))
            .filter(line => isLikelyOrderLine(line) && containsKnownMedication(line));
          console.log('Raw lines from OCR:', lines); // Debug log
          lines = [...new Set(lines)];
          if (lines.length === 0) {
            hideLoading();
            showError('No valid medication orders detected in the first photos. Please try again.');
            return;
          }
          meds1 = lines.map(med => {
            try {
              const parsed = parseOrder(med);
              if (!parsed || typeof parsed !== 'object') {
                console.warn('Parse failed for:', med, 'returning default object');
                return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
              }
              return { original: med, parsed: parsed };
            } catch (e) {
              console.error('Error parsing line:', med, e.stack || e);
              return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
            }
          });
          console.log('Medications from First List:', meds1);
          hideLoading();
          showScreen('photo2-screen');
        } catch (err) {
          console.error('OCR Error:', err);
          hideLoading();
          showError('Error extracting text from the first photos. Please try again.');
        }
      }
    }

    async function comparePhotos() {
      if (!hasTextInput2 && (!photo2Files || photo2Files.length === 0)) {
        showError('Please select at least one photo or submit a medication list.');
        return;
      }
      if (!hasTextInput2) {
        showLoading('Processing second image(s)...');
        try {
          let combinedText = await processFiles(photo2Files);
          let lines = combinedText
            .split(/\r?\n+/)
            .map(line => cleanLine(line))
            .filter(line => isLikelyOrderLine(line) && containsKnownMedication(line));
          console.log('Raw lines from OCR:', lines); // Debug log
          lines = [...new Set(lines)];
          if (lines.length === 0) {
            hideLoading();
            showError('No valid medication orders detected in the second photos. Please try again.');
            return;
          }
          meds2 = lines.map(med => {
            try {
              const parsed = parseOrder(med);
              if (!parsed || typeof parsed !== 'object') {
                console.warn('Parse failed for:', med, 'returning default object');
                return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
              }
              return { original: med, parsed: parsed };
            } catch (e) {
              console.error('Error parsing line:', med, e.stack || e);
              return { original: med, parsed: { drug: med, dose: { value: null, unit: '', total: null }, route: '', frequency: '', prn: false } };
            }
          });
          console.log('Medications from Second List:', meds2);
          hideLoading();
          compareAndShowResults();
        } catch (err) {
          console.error('OCR Error:', err);
          hideLoading();
          showError('Error extracting text from the second photos. Please try again.');
        }
      } else {
        compareAndShowResults();
      }
    }

    function compareAndShowResults() {
      const { unchanged, removed, added } = compareOrders(meds1, meds2);
      let html = '';
      if (removed.length > 0) {
        html += '<h3>Removed:</h3><ul>';
        removed.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (added.length > 0) {
        html += '<h3>Added:</h3><ul>';
        added.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (unchanged.length > 0) {
        html += '<h3>Unchanged:</h3><ul>';
        unchanged.forEach(orderObj => {
          html += `<li>${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      document.getElementById('results-content').innerHTML = html;
      showScreen('results-screen');
    }

    function exportResults() {
      const resultsDiv = document.getElementById('results-content');
      let textContent = '';
      const sections = resultsDiv.querySelectorAll('h3');
      sections.forEach(section => {
        const sectionTitle = section.textContent;
        textContent += `${sectionTitle}\n`;
        const items = section.nextElementSibling.querySelectorAll('li');
        items.forEach(item => {
          const isCritical = item.classList.contains('critical') ? '[Critical] ' : '';
          textContent += `- ${isCritical}${item.textContent}\n`;
        });
        textContent += '\n';
      });
      textContent = `Comparison Results\n\nChanges listed in bold red are critical medications and should be reconciled with the provider within 4 hours of discovery.\n\n${textContent}`;
      const blob = new Blob([textContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'MedRec_Comparison_Results.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function printResults() {
      const resultsDiv = document.getElementById('results-content').innerHTML;
      const note = document.querySelector('#results-screen p').innerHTML;
      const printContent = `
        <h2>Comparison Results</h2>
        <p>${note}</p>
        ${resultsDiv}
      `;
      const iframe = document.createElement('iframe');
      document.body.appendChild(iframe);
      iframe.style.display = 'none';
      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(`
        <html>
          <head>
            <title>Print MedRec Results</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h2 { text-align: center; }
              p { text-align: center; }
              .critical { color: red; font-weight: bold; }
              ul { padding-left: 20px; }
              li { margin: 5px 0; }
            </style>
          </head>
          <body>
            ${printContent}
          </body>
        </html>
      `);
      doc.close();
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
      document.body.removeChild(iframe);
    }

    function startOver() {
      photo1Files = [];
      photo2Files = [];
      meds1 = [];
      meds2 = [];
      hasTextInput1 = false;
      hasTextInput2 = false;
      document.getElementById('photo1-capture').value = '';
      document.getElementById('photo1-upload').value = '';
      document.getElementById('photo1-capture2').value = '';
      document.getElementById('photo1-upload2').value = '';
      document.getElementById('photo2-capture').value = '';
      document.getElementById('photo2-upload').value = '';
      document.getElementById('photo2-capture2').value = '';
      document.getElementById('photo2-upload2').value = '';
      document.getElementById('photo1-text-input').value = '';
      document.getElementById('photo2-text-input').value = '';
      document.getElementById('photo1-status').textContent = '';
      document.getElementById('photo2-status').textContent = '';
      document.getElementById('photo1-next').disabled = true;
      document.getElementById('photo2-compare').disabled = true;
      document.getElementById('results-content').innerHTML = '';
      document.getElementById('photo1-preview').innerHTML = "";
      document.getElementById('photo2-preview').innerHTML = "";
      document.getElementById('photo1-prompt').style.display = 'none';
      document.getElementById('initial-photo1-options').style.display = 'flex';
      document.getElementById('additional-photo1-option').style.display = 'none';
      document.getElementById('photo2-prompt').style.display = 'none';
      document.getElementById('initial-photo2-options').style.display = 'flex';
      document.getElementById('additional-photo2-option').style.display = 'none';
      showScreen('disclaimer-screen');
    }

    // Tooltip toggle for mobile
    document.querySelectorAll('.tooltip').forEach(tooltip => {
      tooltip.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = tooltip.classList.contains('active');
        document.querySelectorAll('.tooltip').forEach(t => t.classList.remove('active'));
        if (!isActive) {
          tooltip.classList.add('active');
        }
      });
    });

    document.addEventListener('click', () => {
      document.querySelectorAll('.tooltip').forEach(tooltip => {
        tooltip.classList.remove('active');
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      hideLoading();
      updateProgress('disclaimer-screen');
    });
  </script>
</body>
</html>
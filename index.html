<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedRec 2.0</title>
  <style>
    /* Basic Layout */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }
    /* Buttons & Inputs */
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem auto;
      cursor: pointer;
      border-radius: 5px;
      width: 100%;
      max-width: 300px;
      display: block;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    /* Hide native file inputs */
    input[type="file"] {
      display: none;
    }
    .file-buttons {
      text-align: center;
      margin: 1rem 0;
    }
    .file-buttons button {
      margin: 0.25rem;
    }
    .upload-instructions {
      font-size: 0.9rem;
      text-align: center;
      margin: 0.5rem 1rem;
      color: #555;
    }
    /* Prompt message container */
    .upload-prompt {
      font-size: 0.9rem;
      text-align: center;
      margin: 0.5rem 1rem;
      color: #333;
    }
    /* Container for stacking all photo actions in a column */
    .photo-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      margin: 1rem 0;
    }
    /* Preview container for thumbnails */
    .preview-container {
      text-align: center;
      margin: 0.5rem 0 1rem;
    }
    .preview-container img {
      width: 80px;
      height: auto;
      margin: 0.25rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #error-message {
      color: red;
      text-align: center;
      margin: 1rem 0;
    }
    .critical {
      color: red;
      font-weight: bold;
    }
    /* Progress Bar */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
      position: relative;
    }
    .progress-step {
      width: 30px;
      height: 30px;
      background-color: #cccccc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }
    .progress-step.filled {
      background-color: #007bff;
      color: white;
    }
    .progress-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #cccccc;
      z-index: 0;
    }
    /* Loading overlay fixed at bottom */
    #loading {
      display: none;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.5rem;
      text-align: center;
      z-index: 2000;
    }
    #loading-text {
      margin-bottom: 0.25rem;
    }
    #loading-progress {
      width: 80%;
      max-width: 300px;
    }
    ul {
      padding-left: 20px;
      text-align: left;
    }
    li {
      margin: 0.5rem 0;
    }
    h3 {
      margin-top: 1rem;
    }
    p.disclaimer-text {
      text-align: justify;
      max-width: 500px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>MedRec 2.0</h1>
    <div class="progress-bar">
      <div class="progress-line"></div>
      <div class="progress-step" id="step1">1</div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-step" id="step3">3</div>
      <div class="progress-step" id="step4">4</div>
    </div>
  </header>
  <main>
    <div id="error-message"></div>
    <!-- Disclaimer Screen -->
    <div id="disclaimer-screen" class="screen active">
      <h2>Disclaimer</h2>
      <p class="disclaimer-text">
        ***HIPAA Warning***: DO NOT UPLOAD IMAGES CONTAINING IDENTIFIABLE INFORMATION. This app is intended for use by personnel authorized to handle Protected Health Information (PHI). Users are responsible for ensuring compliance with HIPAA regulations, including safeguarding resident/patient data and restricting access to authorized personnel only. Unauthorized disclosure of PHI may result in disciplinary action and legal consequences.
      </p>
      <button onclick="acknowledgeDisclaimer()">I Understand</button>
    </div>
    <!-- Photo 1 Screen -->
    <div id="photo1-screen" class="screen">
      <h2>Take or Upload First Photo(s)</h2>
      <p class="upload-instructions">
        For best results, please take a clear photo of the medication list text only.
        Avoid excessive background, unrelated papers, or images.
      </p>
      <div class="preview-container" id="photo1-preview"></div>
      <p id="photo1-status">No photo selected.</p>
      <p id="photo1-prompt" class="upload-prompt" style="display: none;">
        You may add another photo or click Next to continue.
      </p>
      <div class="photo-actions">
        <!-- Initial Options -->
        <div id="initial-photo1-options" style="display: flex; flex-direction: column; gap: 0.5rem; width: 100%;">
          <button onclick="document.getElementById('photo1-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo1-upload').click()">Upload Photo</button>
        </div>
        <!-- Additional Options with distinct buttons -->
        <div id="additional-photo1-options" style="display: none; flex-direction: column; gap: 0.5rem; width: 100%;">
          <button onclick="document.getElementById('photo1-capture2').click()">Add Another (Take)</button>
          <button onclick="document.getElementById('photo1-upload2').click()">Add Another (Upload)</button>
        </div>
        <!-- File Inputs -->
        <input type="file" id="photo1-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto1(this.files)">
        <input type="file" id="photo1-upload" accept="image/*" multiple onchange="handlePhoto1(this.files)">
        <!-- Additional File Inputs -->
        <input type="file" id="photo1-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto1(this.files)">
        <input type="file" id="photo1-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto1(this.files)">
        <!-- Navigation Buttons -->
        <button id="photo1-next" onclick="goToPhoto2()" disabled>Next</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Photo 2 Screen -->
    <div id="photo2-screen" class="screen">
      <h2>Take or Upload Second Photo(s)</h2>
      <p class="upload-instructions">
        For best results, please take a clear photo of the medication list text only.
        Avoid excessive background, unrelated papers, or images.
      </p>
      <div class="preview-container" id="photo2-preview"></div>
      <p id="photo2-status">No photo selected.</p>
      <p id="photo2-prompt" class="upload-prompt" style="display: none;">
        You may add another photo or click Compare to continue.
      </p>
      <div class="photo-actions">
        <!-- Initial Options -->
        <div id="initial-photo2-options" style="display: flex; flex-direction: column; gap: 0.5rem; width: 100%;">
          <button onclick="document.getElementById('photo2-capture').click()">Take Photo</button>
          <button onclick="document.getElementById('photo2-upload').click()">Upload Photo</button>
        </div>
        <!-- Additional Options with distinct buttons -->
        <div id="additional-photo2-options" style="display: none; flex-direction: column; gap: 0.5rem; width: 100%;">
          <button onclick="document.getElementById('photo2-capture2').click()">Add Another (Take)</button>
          <button onclick="document.getElementById('photo2-upload2').click()">Add Another (Upload)</button>
        </div>
        <!-- File Inputs -->
        <input type="file" id="photo2-capture" accept="image/*" capture="environment" multiple onchange="handlePhoto2(this.files)">
        <input type="file" id="photo2-upload" accept="image/*" multiple onchange="handlePhoto2(this.files)">
        <!-- Additional File Inputs -->
        <input type="file" id="photo2-capture2" accept="image/*" capture="environment" multiple onchange="handleAdditionalPhoto2(this.files)">
        <input type="file" id="photo2-upload2" accept="image/*" multiple onchange="handleAdditionalPhoto2(this.files)">
        <!-- Navigation Buttons -->
        <button id="photo2-compare" onclick="comparePhotos()" disabled>Compare</button>
        <button onclick="startOver()">Start Over</button>
      </div>
    </div>
    <!-- Results Screen -->
    <div id="results-screen" class="screen">
      <h2>Comparison Results</h2>
      <div id="results-content"></div>
      <button onclick="startOver()">Start Over</button>
    </div>
  </main>
  <!-- Loading Overlay -->
  <div id="loading">
    <p id="loading-text">Processing...</p>
    <progress id="loading-progress" max="100"></progress>
  </div>
  <script>
    /************************************************
     * Order Parsing & Comparison Functions
     ************************************************/
    const criticalMeds = [
      'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban', 'heparin', 'enoxaparin',
      'clopidogrel', 'ticagrelor', 'prasugrel', 'insulin regular', 'insulin glargine', 'insulin detemir',
      'insulin lispro', 'insulin aspart', 'insulin degludec', 'glipizide', 'glyburide', 'glimepiride',
      'repaglinide', 'nateglinide', 'metformin', 'morphine', 'hydromorphone', 'oxycodone', 'fentanyl',
      'methadone', 'tramadol', 'codeine', 'buprenorphine', 'phenytoin', 'carbamazepine', 'valproic acid',
      'phenobarbital', 'lamotrigine', 'levetiracetam', 'digoxin', 'amiodarone', 'sotalol', 'diltiazem',
      'verapamil', 'metoprolol', 'atenolol', 'carvedilol', 'furosemide', 'bumetanide', 'torsemide',
      'spironolactone', 'hydrochlorothiazide', 'chlorthalidone', 'potassium chloride', 'magnesium sulfate',
      'calcium gluconate', 'calcium chloride', 'sodium bicarbonate', 'phosphate', 'hydralazine', 'clonidine',
      'isosorbide mononitrate', 'isosorbide dinitrate', 'nitroglycerin', 'haloperidol', 'risperidone',
      'olanzapine', 'quetiapine', 'aripiprazole', 'ziprasidone', 'lorazepam', 'diazepam', 'clonazepam',
      'temazepam', 'midazolam', 'zolpidem', 'prednisone', 'methylprednisolone', 'dexamethasone',
      'hydrocortisone', 'levothyroxine', 'liothyronine', 'tacrolimus', 'cyclosporine', 'mycophenolate',
      'azathioprine', 'vancomycin', 'gentamicin', 'tobramycin', 'amikacin', 'ciprofloxacin', 'levofloxacin',
      'moxifloxacin', 'azithromycin', 'clarithromycin', 'erythromycin', 'amoxicillin',
      'amoxicillin-clavulanate', 'ceftriaxone', 'cefepime', 'ceftazidime', 'cefdinir', 'cephalexin',
      'piperacillin-tazobactam', 'penicillin vk', 'dicloxacillin', 'nafcillin', 'meropenem', 'ertapenem',
      'imipenem-cilastatin', 'doxycycline', 'minocycline', 'tetracycline', 'linezolid',
      'sulfamethoxazole-trimethoprim', 'nitrofurantoin', 'metronidazole', 'clindamycin', 'fosfomycin',
      'daptomycin', 'tigecycline', 'carbidopa/levodopa', 'entacapone', 'selegiline', 'rasagiline', 'lithium',
      'theophylline', 'clozapine', 'methotrexate', 'allopurinol', 'colchicine', 'tamsulosin', 'finasteride',
      'denosumab', 'zoledronic acid', 'teriparatide', 'alendronate', 'risedronate', 'acetazolamide',
      'bethanechol', 'bethanechol chloride', 'donepezil', 'rivastigmine', 'galantamine', 'memantine',
      'naltrexone', 'naloxone', 'flumazenil', 'desmopressin', 'octreotide', 'erythropoietin', 'filgrastim',
      'calcitriol', 'ergocalciferol', 'cholecalciferol', 'pyridostigmine', 'propranolol', 'labetalol',
      'isosorbide', 'nicardipine', 'nitroprusside', 'ivabradine', 'sacubitril', 'valsartan',
      'atorvastatin', 'rosuvastatin', 'simvastatin'
    ];
    
    let photo1Files = [];
    let photo2Files = [];
    let meds1 = [], meds2 = [];
    
    /************************************************
     * UI & Flow Control
     ************************************************/
    function showScreen(screenId) {
      document.getElementById('error-message').textContent = '';
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
      updateProgress(screenId);
    }
    function updateProgress(screenId) {
      document.getElementById('step1').classList.remove('filled');
      document.getElementById('step2').classList.remove('filled');
      document.getElementById('step3').classList.remove('filled');
      document.getElementById('step4').classList.remove('filled');
      if (screenId === 'disclaimer-screen') {
        document.getElementById('step1').classList.add('filled');
      } else if (screenId === 'photo1-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
      } else if (screenId === 'photo2-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
      } else if (screenId === 'results-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
        document.getElementById('step4').classList.add('filled');
      }
    }
    function showLoading(msg) {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('loading-text').textContent = msg;
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
    }
    function acknowledgeDisclaimer() {
      showScreen('photo1-screen');
    }
    
    /************************************************
     * File Handling for Photo 1
     ************************************************/
    function handlePhoto1(files) {
      if (!files || files.length === 0) return;
      // Append valid files
      const validFiles = Array.from(files).filter(file => file.size > 0);
      photo1Files = photo1Files.concat(validFiles);
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0, 5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo1-status').textContent = photo1Files.length + " photo(s) selected.";
      document.getElementById('photo1-next').disabled = false;
      updatePreview('photo1-preview', photo1Files);
      // After first photo, update prompt and switch options
      if (photo1Files.length >= 1) {
        document.getElementById('photo1-prompt').style.display = 'block';
        document.getElementById('photo1-prompt').textContent = "You may add another photo or click Next to continue.";
        document.getElementById('initial-photo1-options').style.display = 'none';
        document.getElementById('additional-photo1-options').style.display = 'flex';
      }
      // Clear initial inputs so the same file can be reselected if needed
      document.getElementById('photo1-capture').value = "";
      document.getElementById('photo1-upload').value = "";
    }
    function handleAdditionalPhoto1(files) {
      if (!files || files.length === 0) return;
      const validFiles = Array.from(files).filter(file => file.size > 0);
      photo1Files = photo1Files.concat(validFiles);
      if (photo1Files.length > 5) {
        photo1Files = photo1Files.slice(0, 5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo1-status').textContent = photo1Files.length + " photo(s) selected.";
      updatePreview('photo1-preview', photo1Files);
      // Clear additional inputs
      document.getElementById('photo1-capture2').value = "";
      document.getElementById('photo1-upload2').value = "";
    }
    
    /************************************************
     * File Handling for Photo 2
     ************************************************/
    function handlePhoto2(files) {
      if (!files || files.length === 0) return;
      const validFiles = Array.from(files).filter(file => file.size > 0);
      photo2Files = photo2Files.concat(validFiles);
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0, 5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo2-status').textContent = photo2Files.length + " photo(s) selected.";
      document.getElementById('photo2-compare').disabled = false;
      updatePreview('photo2-preview', photo2Files);
      if (photo2Files.length >= 1) {
        document.getElementById('photo2-prompt').style.display = 'block';
        document.getElementById('photo2-prompt').textContent = "You may add another photo or click Compare to continue.";
        document.getElementById('initial-photo2-options').style.display = 'none';
        document.getElementById('additional-photo2-options').style.display = 'flex';
      }
      document.getElementById('photo2-capture').value = "";
      document.getElementById('photo2-upload').value = "";
    }
    function handleAdditionalPhoto2(files) {
      if (!files || files.length === 0) return;
      const validFiles = Array.from(files).filter(file => file.size > 0);
      photo2Files = photo2Files.concat(validFiles);
      if (photo2Files.length > 5) {
        photo2Files = photo2Files.slice(0, 5);
        showError("Maximum of 5 photos allowed for this step.");
      } else {
        showError("");
      }
      document.getElementById('photo2-status').textContent = photo2Files.length + " photo(s) selected.";
      updatePreview('photo2-preview', photo2Files);
      document.getElementById('photo2-capture2').value = "";
      document.getElementById('photo2-upload2').value = "";
    }
    function updatePreview(previewId, files) {
      const container = document.getElementById(previewId);
      container.innerHTML = "";
      files.forEach(file => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        container.appendChild(img);
      });
    }
    
    /************************************************
     * OCR & Processing
     ************************************************/
    async function goToPhoto2() {
      if (!photo1Files || photo1Files.length === 0) {
        showError('Please select at least one photo.');
        return;
      }
      showLoading('Processing first image(s)...');
      try {
        let combinedText = await processFiles(photo1Files);
        let lines = combinedText.split(/[\n,]+/).map(line => cleanLine(line)).filter(isLikelyOrderLine);
        lines = [...new Set(lines)];
        meds1 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
        console.log('Medications from Photo 1:', meds1);
        hideLoading();
        showScreen('photo2-screen');
      } catch (err) {
        console.error('OCR Error:', err);
        hideLoading();
        showError('Error extracting text from the first photos. Please try again.');
      }
    }
    async function comparePhotos() {
      if (!photo2Files || photo2Files.length === 0) {
        showError('Please select at least one photo.');
        return;
      }
      showLoading('Processing second image(s)...');
      try {
        let combinedText = await processFiles(photo2Files);
        let lines = combinedText.split(/[\n,]+/).map(line => cleanLine(line)).filter(isLikelyOrderLine);
        lines = [...new Set(lines)];
        meds2 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
        console.log('Medications from Photo 2:', meds2);
        hideLoading();
        compareAndShowResults();
      } catch (err) {
        console.error('OCR Error:', err);
        hideLoading();
        showError('Error extracting text from the second photos. Please try again.');
      }
    }
    async function processFiles(files) {
      let allText = "";
      for (let file of files) {
        try {
          let text = await processFile(file);
          allText += "\n" + text;
        } catch (err) {
          console.error("Error processing file: ", err);
        }
      }
      return allText;
    }
    function processFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Image = e.target.result;
          try {
            const response = await fetch('https://us-central1-medrec-ocr.cloudfunctions.net/ocr', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: base64Image })
            });
            const { text, error } = await response.json();
            if (error) reject(error);
            else if (!text) reject('No text detected');
            else resolve(text);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject("File could not be read.");
        reader.readAsDataURL(file);
      });
    }
    function compareAndShowResults() {
      const { unchanged, removed, added } = compareOrders(meds1, meds2);
      let html = '';
      if (removed.length > 0) {
        html += '<h3>Removed:</h3><ul>';
        removed.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (added.length > 0) {
        html += '<h3>Added:</h3><ul>';
        added.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (unchanged.length > 0) {
        html += '<h3>Unchanged:</h3><ul>';
        unchanged.forEach(orderObj => {
          html += `<li>${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      document.getElementById('results-content').innerHTML = html;
      showScreen('results-screen');
    }
    function ordersAreEqual(a, b) {
      if (a.dose !== b.dose) return false;
      if (a.route !== b.route) return false;
      if (a.frequency !== b.frequency) return false;
      if (a.name && b.name && a.name !== b.name) return false;
      return true;
    }
    function compareOrders(list1, list2) {
      let unchanged = [];
      let removed = [];
      let added = [];
      let matched2 = new Array(list2.length).fill(false);
      for (let orderObj1 of list1) {
        let found = false;
        for (let i = 0; i < list2.length; i++) {
          if (!matched2[i] && ordersAreEqual(orderObj1.parsed, list2[i].parsed)) {
            matched2[i] = true;
            unchanged.push(orderObj1);
            found = true;
            break;
          }
        }
        if (!found) removed.push(orderObj1);
      }
      for (let i = 0; i < list2.length; i++) {
        if (!matched2[i]) added.push(list2[i]);
      }
      return { unchanged, removed, added };
    }
    function isCriticalOrder(parsedOrder) {
      return parsedOrder.name && criticalMeds.includes(parsedOrder.name);
    }
    function startOver() {
      photo1Files = [];
      photo2Files = [];
      meds1 = [];
      meds2 = [];
      document.getElementById('photo1-capture').value = '';
      document.getElementById('photo1-upload').value = '';
      document.getElementById('photo1-upload2').value = '';
      document.getElementById('photo2-capture').value = '';
      document.getElementById('photo2-upload').value = '';
      document.getElementById('photo2-upload2').value = '';
      document.getElementById('photo1-status').textContent = 'No photo selected.';
      document.getElementById('photo2-status').textContent = 'No photo selected.';
      document.getElementById('photo1-next').disabled = true;
      document.getElementById('photo2-compare').disabled = true;
      document.getElementById('results-content').innerHTML = '';
      document.getElementById('photo1-preview').innerHTML = "";
      document.getElementById('photo2-preview').innerHTML = "";
      document.getElementById('photo1-prompt').style.display = 'none';
      document.getElementById('initial-photo1-options').style.display = 'flex';
      document.getElementById('additional-photo1-options').style.display = 'none';
      document.getElementById('photo2-prompt').style.display = 'none';
      document.getElementById('initial-photo2-options').style.display = 'flex';
      document.getElementById('additional-photo2-options').style.display = 'none';
      showScreen('disclaimer-screen');
    }
    document.addEventListener('DOMContentLoaded', () => {
      hideLoading();
      updateProgress('disclaimer-screen');
    });
  </script>
</body>
</html>
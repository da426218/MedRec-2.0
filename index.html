<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedRec 2.0</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background-color: #f0f0f0;
      text-align: center;
    }
    .screen {
      display: none;
      max-width: 600px;
      width: 100%;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      margin-bottom: 20px;
    }
    .screen.active {
      display: block;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    input[type="file"] {
      margin: 10px 0;
      display: block;
      width: 100%;
    }
    #results-screen ul {
      list-style: none;
      padding: 0;
    }
    #results-screen li {
      margin: 5px 0;
    }
    .critical {
      color: red;
      font-weight: bold;
    }
    .photo-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    /* Loading Indicator */
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      text-align: center;
      z-index: 1000;
      font-size: 16px;
    }
    #progress-bar {
      width: 100%;
    }
    /* Inline Error Message */
    #error-message {
      color: red;
      margin-top: 10px;
    }
    /* Step Indicator */
    #progress-steps {
      margin-top: 20px;
      text-align: center;
    }
    .dash {
      font-size: 32px;
      margin: 0 10px;
      color: #cccccc;
    }
    .dash.filled {
      color: #007bff;
      font-weight: bold;
    }
    /* Mobile Responsive */
    @media screen and (max-width: 600px) {
      body {
        padding: 10px;
      }
      .screen {
        margin: 0 10px 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Indicator -->
  <div id="loading">
    <span id="loading-text">Loading...</span>
    <br>
    <progress id="progress-bar" value="0" max="1"></progress>
  </div>
  <!-- Inline Error Message -->
  <div id="error-message"></div>
  
  <!-- Disclaimer Screen -->
  <div id="disclaimer-screen" class="screen active">
    <h2>Disclaimer</h2>
    <p><strong>***HIPAA Warning***:</strong> DO NOT UPLOAD IMAGES CONTAINING IDENTIFIABLE INFORMATION. This app is intended for use by personnel authorized to handle Protected Health Information (PHI). Users are responsible for ensuring compliance with HIPAA regulations, including safeguarding resident/patient data and restricting access to authorized personnel only. Unauthorized disclosure of PHI may result in disciplinary action and legal consequences.</p>
    <button onclick="acknowledgeDisclaimer()">Acknowledge</button>
  </div>

  <!-- Photo 1 Screen -->
  <div id="photo1-screen" class="screen">
    <h2>First Medication List</h2>
    <p>Please take a photo of the first medication list or upload an image.</p>
    <div class="photo-buttons">
      <button onclick="document.getElementById('photo1-capture').click()">Take Photo</button>
      <input type="file" id="photo1-capture" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto1(this.files[0])">
      <button onclick="document.getElementById('photo1-upload').click()">Choose File</button>
      <input type="file" id="photo1-upload" accept="image/*" style="display: none;" onchange="handlePhoto1(this.files[0])">
    </div>
    <p id="photo1-status">No photo selected.</p>
    <button onclick="goToPhoto2()" id="photo1-next" disabled>Next</button>
  </div>

  <!-- Photo 2 Screen -->
  <div id="photo2-screen" class="screen">
    <h2>Second Medication List</h2>
    <p>Please take a photo of the second medication list or upload an image.</p>
    <div class="photo-buttons">
      <button onclick="document.getElementById('photo2-capture').click()">Take Photo</button>
      <input type="file" id="photo2-capture" accept="image/*" capture="environment" style="display: none;" onchange="handlePhoto2(this.files[0])">
      <button onclick="document.getElementById('photo2-upload').click()">Choose File</button>
      <input type="file" id="photo2-upload" accept="image/*" style="display: none;" onchange="handlePhoto2(this.files[0])">
    </div>
    <p id="photo2-status">No photo selected.</p>
    <button onclick="comparePhotos()" id="photo2-compare" disabled>Compare</button>
  </div>

  <!-- Results Screen -->
  <div id="results-screen" class="screen">
    <h2>Comparison Results</h2>
    <div id="results-content"></div>
    <button onclick="startOver()">Start Over</button>
  </div>

  <!-- Step Indicator -->
  <div id="progress-steps">
    <span class="dash" id="step1">-</span>
    <span class="dash" id="step2">-</span>
    <span class="dash" id="step3">-</span>
    <span class="dash" id="step4">-</span>
  </div>

  <script>
    // --- Preprocessing: Convert image file to grayscale and threshold ---
    function preprocessImage(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          // Draw the image on the canvas.
          ctx.drawImage(img, 0, 0);
          // Convert to grayscale.
          let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let data = imageData.data;
          for (let i = 0; i < data.length; i += 4) {
            const gray = 0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2];
            data[i] = data[i+1] = data[i+2] = gray;
          }
          ctx.putImageData(imageData, 0, 0);
          // Apply simple thresholding.
          for (let i = 0; i < data.length; i += 4) {
            const threshold = 128;
            const val = data[i] > threshold ? 255 : 0;
            data[i] = data[i+1] = data[i+2] = val;
          }
          ctx.putImageData(imageData, 0, 0);
          // Return the preprocessed image as a Data URL.
          callback(canvas.toDataURL());
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // --- Order Parsing & Comparison Functions ---
    const criticalMeds = [
      'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban', 'heparin', 'enoxaparin',
      'clopidogrel', 'ticagrelor', 'prasugrel', 'insulin regular', 'insulin glargine', 'insulin detemir',
      'insulin lispro', 'insulin aspart', 'insulin degludec', 'glipizide', 'glyburide', 'glimepiride',
      'repaglinide', 'nateglinide', 'metformin', 'morphine', 'hydromorphone', 'oxycodone', 'fentanyl',
      'methadone', 'tramadol', 'codeine', 'buprenorphine', 'phenytoin', 'carbamazepine', 'valproic acid',
      'phenobarbital', 'lamotrigine', 'levetiracetam', 'digoxin', 'amiodarone', 'sotalol', 'diltiazem',
      'verapamil', 'metoprolol', 'atenolol', 'carvedilol', 'furosemide', 'bumetanide', 'torsemide',
      'spironolactone', 'hydrochlorothiazide', 'chlorthalidone', 'potassium chloride', 'magnesium sulfate',
      'calcium gluconate', 'calcium chloride', 'sodium bicarbonate', 'phosphate', 'hydralazine', 'clonidine',
      'isosorbide mononitrate', 'isosorbide dinitrate', 'nitroglycerin', 'haloperidol', 'risperidone',
      'olanzapine', 'quetiapine', 'aripiprazole', 'ziprasidone', 'lorazepam', 'diazepam', 'clonazepam',
      'temazepam', 'midazolam', 'zolpidem', 'prednisone', 'methylprednisolone', 'dexamethasone',
      'hydrocortisone', 'levothyroxine', 'liothyronine', 'tacrolimus', 'cyclosporine', 'mycophenolate',
      'azathioprine', 'vancomycin', 'gentamicin', 'tobramycin', 'amikacin', 'ciprofloxacin', 'levofloxacin',
      'moxifloxacin', 'azithromycin', 'clarithromycin', 'erythromycin', 'amoxicillin',
      'amoxicillin-clavulanate', 'ceftriaxone', 'cefepime', 'ceftazidime', 'cefdinir', 'cephalexin',
      'piperacillin-tazobactam', 'penicillin vk', 'dicloxacillin', 'nafcillin', 'meropenem', 'ertapenem',
      'imipenem-cilastatin', 'doxycycline', 'minocycline', 'tetracycline', 'linezolid',
      'sulfamethoxazole-trimethoprim', 'nitrofurantoin', 'metronidazole', 'clindamycin', 'fosfomycin',
      'daptomycin', 'tigecycline', 'carbidopa/levodopa', 'entacapone', 'selegiline', 'rasagiline', 'lithium',
      'theophylline', 'clozapine', 'methotrexate', 'allopurinol', 'colchicine', 'tamsulosin', 'finasteride',
      'denosumab', 'zoledronic acid', 'teriparatide', 'alendronate', 'risedronate', 'acetazolamide',
      'bethanechol', 'bethanechol chloride', 'donepezil', 'rivastigmine', 'galantamine', 'memantine',
      'naltrexone', 'naloxone', 'flumazenil', 'desmopressin', 'octreotide', 'erythropoietin', 'filgrastim',
      'calcitriol', 'ergocalciferol', 'cholecalciferol', 'pyridostigmine', 'propranolol', 'labetalol',
      'isosorbide', 'nicardipine', 'nitroprusside', 'ivabradine', 'sacubitril', 'valsartan',
      'atorvastatin', 'rosuvastatin', 'simvastatin'
    ];

    let photo1, photo2, meds1, meds2;

    // Aggressive filtering: clean trailing punctuation/symbols.
    function cleanLine(line) {
      return line.replace(/[^a-z0-9]+$/i, '').trim();
    }

    // Filter out lines that likely aren't orders.
    function isLikelyOrderLine(line) {
      if (line.length < 3) return false;
      let alphaNumCount = (line.match(/[a-z0-9]/gi) || []).length;
      let ratio = alphaNumCount / line.length;
      // If less than 40% alphanumeric, reject.
      if (ratio < 0.4) return false;
      return true;
    }

    // Parse an order into its components.
    function parseOrder(orderStr) {
      orderStr = orderStr.toLowerCase().trim().replace(/\s+/g, ' ');
      let doseMatch = orderStr.match(/(\d+)\s*mg/);
      let dose = doseMatch ? parseInt(doseMatch[1]) : null;
      let route = orderStr.includes("po") ? "po" : "";
      const freqMapping = {
        "every other morning": "every other morning",
        "every other afternoon": "every other afternoon",
        "every other evening": "every other evening",
        "every other night": "every other night",
        "every morning": "every morning",
        "every afternoon": "every afternoon",
        "every evening": "every evening",
        "every night": "every night",
        "once daily": "daily",
        "daily": "daily",
        "qd": "daily",
        "q.d.": "daily",
        "twice daily": "twice daily"
      };
      let frequency = "";
      let freqKeys = Object.keys(freqMapping).sort((a, b) => b.length - a.length);
      for (let key of freqKeys) {
        if (orderStr.includes(key)) {
          frequency = freqMapping[key];
          orderStr = orderStr.replace(key, '');
          break;
        }
      }
      if (doseMatch) {
        orderStr = orderStr.replace(doseMatch[0], '');
      }
      if (route) {
        orderStr = orderStr.replace(/\bpo\b/, '');
      }
      let name = orderStr.trim();
      return { name, dose, route, frequency };
    }

    function ordersAreEqual(a, b) {
      if (a.dose !== b.dose) return false;
      if (a.route !== b.route) return false;
      if (a.frequency !== b.frequency) return false;
      if (a.name && b.name && a.name !== b.name) return false;
      return true;
    }

    function compareOrders(list1, list2) {
      let unchanged = [];
      let removed = [];
      let added = [];
      let matched2 = new Array(list2.length).fill(false);
      for (let orderObj1 of list1) {
        let found = false;
        for (let i = 0; i < list2.length; i++) {
          if (!matched2[i] && ordersAreEqual(orderObj1.parsed, list2[i].parsed)) {
            matched2[i] = true;
            unchanged.push(orderObj1);
            found = true;
            break;
          }
        }
        if (!found) removed.push(orderObj1);
      }
      for (let i = 0; i < list2.length; i++) {
        if (!matched2[i]) added.push(list2[i]);
      }
      return { unchanged, removed, added };
    }

    function isCriticalOrder(parsedOrder) {
      return parsedOrder.name && criticalMeds.includes(parsedOrder.name);
    }

    // --- UI and OCR Flow ---
    function showScreen(screenId) {
      document.getElementById('error-message').textContent = '';
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      updateProgress(screenId);
    }

    function updateProgress(screenId) {
      document.getElementById('step1').classList.remove('filled');
      document.getElementById('step2').classList.remove('filled');
      document.getElementById('step3').classList.remove('filled');
      document.getElementById('step4').classList.remove('filled');
      if (screenId === 'disclaimer-screen') {
        document.getElementById('step1').classList.add('filled');
      } else if (screenId === 'photo1-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
      } else if (screenId === 'photo2-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
      } else if (screenId === 'results-screen') {
        document.getElementById('step1').classList.add('filled');
        document.getElementById('step2').classList.add('filled');
        document.getElementById('step3').classList.add('filled');
        document.getElementById('step4').classList.add('filled');
      }
    }

    function showLoading(msg) {
      const ld = document.getElementById('loading'),
            lt = document.getElementById('loading-text');
      ld.style.display = 'block';
      lt.textContent = msg;
      document.getElementById('progress-bar').value = 0;
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
    }

    function acknowledgeDisclaimer() {
      showScreen('photo1-screen');
    }

    function handlePhoto1(file) {
      if (!file) return;
      photo1 = file;
      document.getElementById('photo1-status').textContent = 'Photo selected: ' + file.name;
      document.getElementById('photo1-next').disabled = false;
    }

    // Preprocess image then OCR Photo 1.
    function goToPhoto2() {
      if (!photo1) {
        showError('Please select a photo first.');
        return;
      }
      showLoading('Processing first image...');
      preprocessImage(photo1, function(dataURL) {
        Tesseract.recognize(
          dataURL,
          'eng',
          { logger: m => {
              console.log(m);
              if (m.progress) document.getElementById('progress-bar').value = m.progress;
            },
            tessedit_pageseg_mode: 6
          }
        ).then(({ data: { text } }) => {
          const lines = text.split(/[\n,]+/)
                            .map(line => cleanLine(line))
                            .filter(isLikelyOrderLine);
          meds1 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
          console.log('Medications from Photo 1:', meds1);
          hideLoading();
          showScreen('photo2-screen');
        }).catch(err => {
          console.error('OCR Error:', err);
          hideLoading();
          showError('Error extracting text from the first photo. Please try again.');
        });
      });
    }

    function handlePhoto2(file) {
      if (!file) return;
      photo2 = file;
      document.getElementById('photo2-status').textContent = 'Photo selected: ' + file.name;
      document.getElementById('photo2-compare').disabled = false;
    }

    // Preprocess image then OCR Photo 2.
    function comparePhotos() {
      if (!photo2) {
        showError('Please select a photo first.');
        return;
      }
      showLoading('Processing second image...');
      preprocessImage(photo2, function(dataURL) {
        Tesseract.recognize(
          dataURL,
          'eng',
          { logger: m => {
              console.log(m);
              if (m.progress) document.getElementById('progress-bar').value = m.progress;
            },
            tessedit_pageseg_mode: 6
          }
        ).then(({ data: { text } }) => {
          const lines = text.split(/[\n,]+/)
                            .map(line => cleanLine(line))
                            .filter(isLikelyOrderLine);
          meds2 = lines.map(med => ({ original: med, parsed: parseOrder(med) }));
          console.log('Medications from Photo 2:', meds2);
          hideLoading();
          compareAndShowResults();
        }).catch(err => {
          console.error('OCR Error:', err);
          hideLoading();
          showError('Error extracting text from the second photo. Please try again.');
        });
      });
    }

    function compareAndShowResults() {
      const { unchanged, removed, added } = compareOrders(meds1, meds2);
      let html = '';
      if (removed.length > 0) {
        html += '<h3>Removed:</h3><ul>';
        removed.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (added.length > 0) {
        html += '<h3>Added:</h3><ul>';
        added.forEach(orderObj => {
          const crit = isCriticalOrder(orderObj.parsed);
          html += `<li class="${crit ? 'critical' : ''}">${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      if (unchanged.length > 0) {
        html += '<h3>Unchanged:</h3><ul>';
        unchanged.forEach(orderObj => {
          html += `<li>${orderObj.original}</li>`;
        });
        html += '</ul>';
      }
      document.getElementById('results-content').innerHTML = html;
      showScreen('results-screen');
    }

    function startOver() {
      photo1 = photo2 = meds1 = meds2 = null;
      document.getElementById('photo1-capture').value = '';
      document.getElementById('photo1-upload').value = '';
      document.getElementById('photo2-capture').value = '';
      document.getElementById('photo2-upload').value = '';
      document.getElementById('photo1-status').textContent = 'No photo selected.';
      document.getElementById('photo2-status').textContent = 'No photo selected.';
      document.getElementById('photo1-next').disabled = true;
      document.getElementById('photo2-compare').disabled = true;
      document.getElementById('results-content').innerHTML = '';
      showScreen('disclaimer-screen');
    }

    // Set initial progress.
    updateProgress('disclaimer-screen');
  </script>
</body>
</html>

